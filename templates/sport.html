{% extends "base.html" %}

{% block title %}{{ sport.name }} - Ham Radio Olympics{% endblock %}

{% block content %}
<h2>{{ sport.name }}</h2>

{% if sport.description %}
<p>{{ sport.description }}</p>
{% endif %}

<div class="card">
    <p><strong>Target Type:</strong> {{ sport.target_type | title }}</p>
    <p><strong>Modes:</strong>
        {% if sport.work_enabled %}Work{% endif %}
        {% if sport.work_enabled and sport.activate_enabled %} / {% endif %}
        {% if sport.activate_enabled %}Activate{% endif %}
    </p>
    {% if sport.separate_pools %}
    <p><em>Work and Activate have separate medal pools</em></p>
    {% endif %}
    <p><strong>Participants:</strong> {{ entry_count }} <a href="/olympiad/sport/{{ sport.id }}/participants" title="View participants"><span class="icon">ğŸ‘¥</span></a></p>
    {% if user %}
    <div style="margin-top: 10px;">
        {% if is_entered %}
        <span style="color: #38a169; font-weight: bold;">âœ“ You are entered in this sport</span>
        <button type="button" class="btn" style="background: #c53030; margin-left: 10px;" onclick="leaveSport()">Leave Sport</button>
        {% else %}
        <button type="button" onclick="enterSport()" class="btn btn-success">Participate</button>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
async function enterSport() {
    const resp = await fetch('/sport/{{ sport.id }}/enter', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin'
    });
    if (resp.ok) {
        location.reload();
    } else {
        const data = await resp.json().catch(() => ({}));
        showToast(data.detail || 'Failed to enter sport', 'error');
    }
}

async function leaveSport() {
    if (!confirm('Leave this sport? You can re-enter later.')) return;
    const resp = await fetch('/sport/{{ sport.id }}/leave', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin'
    });
    if (resp.ok) {
        location.reload();
    } else {
        const data = await resp.json().catch(() => ({}));
        showToast(data.detail || 'Failed to leave sport', 'error');
    }
}
</script>

{% if standings %}
<h3>Overall Standings</h3>
<div class="table-responsive"><table>
    <thead>
        <tr>
            <th scope="col">Rank</th>
            <th scope="col">Callsign</th>
            <th scope="col">ğŸ¥‡</th>
            <th scope="col">ğŸ¥ˆ</th>
            <th scope="col">ğŸ¥‰</th>
            <th scope="col">Points</th>
        </tr>
    </thead>
    <tbody>
        {% for standing in standings[:20] %}
        <tr>
            <td>{{ loop.index }}</td>
            <td><a href="/competitor/{{ standing.callsign }}">{{ standing.first_name | competitor_display(standing.callsign) }}</a></td>
            <td class="medal-gold">{{ standing.gold or '-' }}</td>
            <td class="medal-silver">{{ standing.silver or '-' }}</td>
            <td class="medal-bronze">{{ standing.bronze or '-' }}</td>
            <td><strong>{{ standing.total_points }}</strong></td>
        </tr>
        {% endfor %}
    </tbody>
</table></div>
{% else %}
<div class="card">
    <p>No standings yet. Medals are awarded as matches complete.</p>
</div>
{% endif %}

{% if matches %}
<h3>Matches</h3>
{% if sport.target_type == 'park' %}
<p id="spots-summary" style="margin-bottom: 15px; color: var(--text-secondary);">
    <span class="loading-spinner" style="vertical-align: middle;"></span> Checking for active spots...
</p>
{% endif %}
<div class="table-responsive"><table>
    <thead>
        <tr>
            <th scope="col">Target</th>
            <th scope="col">Status</th>
            <th scope="col">Start</th>
            <th scope="col">End</th>
            <th scope="col">Action</th>
        </tr>
    </thead>
    <tbody>
        {% for match in matches %}
        <tr>
            <td>
                <strong>{{ match.target_display | pota_tooltip }}</strong>
                {% if sport.target_type == 'park' %}
                <span class="live-indicator" data-park="{{ match.target_value }}" style="display: none;" title="Active on air now!">ğŸ“¡</span>
                {% endif %}
            </td>
            <td><span class="status-badge" data-start="{{ match.start_date }}" data-end="{{ match.end_date }}">...</span></td>
            <td>{{ match.start_date | format_date }}</td>
            <td>{{ match.end_date | format_date }}</td>
            <td><a href="/olympiad/sport/{{ sport.id }}/match/{{ match.id }}" class="btn btn-sm"><span class="icon">ğŸ‘ï¸</span> View</a></td>
        </tr>
        {% endfor %}
    </tbody>
</table></div>
<script>
(function() {
    document.querySelectorAll('.status-badge[data-start]').forEach(function(badge) {
        var start = new Date(badge.dataset.start + 'T00:00:00');
        var end = new Date(badge.dataset.end + 'T23:59:59');
        var now = new Date();

        if (now < start) {
            badge.textContent = 'Upcoming';
            badge.classList.add('status-upcoming');
        } else if (now > end) {
            badge.textContent = 'Ended';
            badge.classList.add('status-ended');
        } else {
            badge.textContent = 'â— Active';
            badge.classList.add('status-active');
        }
    });
})();
</script>

{% if sport.target_type == 'park' %}
<script>
(function() {
    async function updateLiveIndicators() {
        try {
            const resp = await fetch('/api/v1/spots');
            if (!resp.ok) return;
            const data = await resp.json();
            const activeParks = new Set(data.parks_with_spots || []);

            let activeCount = 0;
            document.querySelectorAll('.live-indicator[data-park]').forEach(el => {
                const park = el.getAttribute('data-park');
                if (activeParks.has(park)) {
                    el.style.display = 'inline';
                    activeCount++;
                } else {
                    el.style.display = 'none';
                }
            });

            // Update summary message
            const summary = document.getElementById('spots-summary');
            if (summary) {
                if (activeCount > 0) {
                    summary.innerHTML = '<span class="live-indicator">ğŸ“¡</span> ' + activeCount + ' of {{ matches|length }} parks have activators on the air right now';
                    summary.style.color = 'var(--text-primary)';
                } else {
                    summary.innerHTML = 'No parks reporting spots right now';
                    summary.style.color = 'var(--text-secondary)';
                }
            }
        } catch (e) {
            console.error('Failed to load spots:', e);
        }
    }

    // Load immediately
    updateLiveIndicators();

    // Refresh every 60 seconds
    setInterval(updateLiveIndicators, 60000);
})();
</script>
{% endif %}
{% else %}
<div class="card">
    <p>No matches scheduled yet.</p>
</div>
{% endif %}

<p><a href="/">Back to Home</a></p>
{% endblock %}
