{% extends "base.html" %}

{% block title %}{{ sport.name }} - Ham Radio Olympics{% endblock %}

{% block content %}
<h2>{{ sport.name }}</h2>

{% if sport.description %}
<p>{{ sport.description }}</p>
{% endif %}

<div class="card">
    <p><strong>Target Type:</strong> {{ sport.target_type | title }}</p>
    <p><strong>Competition Modes:</strong>
        {% if sport.work_enabled %}Work{% endif %}
        {% if sport.work_enabled and sport.activate_enabled %} / {% endif %}
        {% if sport.activate_enabled %}Activate{% endif %}
    </p>
    {% if sport.separate_pools %}
    <p><em>Work and Activate have separate medal pools</em></p>
    {% endif %}
    <p><strong>Allowed Modes:</strong> {{ sport.allowed_modes if sport.allowed_modes else 'All modes' }}</p>
    <p><strong>Participants:</strong> {{ entry_count }} <a href="/olympiad/sport/{{ sport.id }}/participants" title="View participants"><span class="icon">üë•</span></a></p>
    {% if user %}
    <div style="margin-top: 10px;">
        {% if is_entered %}
        <span style="color: #38a169; font-weight: bold;">‚úì You are entered in this sport</span>
        <button type="button" class="btn" style="background: #c53030; margin-left: 10px;" onclick="leaveSport()">Leave Sport</button>
        {% else %}
        <button type="button" onclick="enterSport()" class="btn btn-success">Participate</button>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
async function enterSport() {
    const resp = await fetch('/sport/{{ sport.id }}/enter', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin'
    });
    if (resp.ok) {
        location.reload();
    } else {
        const data = await resp.json().catch(() => ({}));
        showToast(data.detail || 'Failed to enter sport', 'error');
    }
}

async function leaveSport() {
    if (!confirm('Leave this sport? You can re-enter later.')) return;
    const resp = await fetch('/sport/{{ sport.id }}/leave', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin'
    });
    if (resp.ok) {
        location.reload();
    } else {
        const data = await resp.json().catch(() => ({}));
        showToast(data.detail || 'Failed to leave sport', 'error');
    }
}
</script>

{% if standings %}
<h3>Overall Standings</h3>
<div class="table-responsive"><table>
    <thead>
        <tr>
            <th scope="col" style="width: 30px;"></th>
            <th scope="col">Rank</th>
            <th scope="col">Callsign</th>
            <th scope="col">ü•á</th>
            <th scope="col">ü•à</th>
            <th scope="col">ü•â</th>
            <th scope="col">Points</th>
        </tr>
    </thead>
    <tbody>
        {% for standing in standings[:20] %}
        <tr class="standings-row" data-callsign="{{ standing.callsign }}">
            <td style="cursor: pointer; text-align: center;" onclick="toggleDetails('{{ standing.callsign }}')">
                {% if medal_details.get(standing.callsign) %}
                <span class="expand-icon" id="icon-{{ standing.callsign }}">‚ñ∂</span>
                {% endif %}
            </td>
            <td>{{ loop.index }}</td>
            <td><a href="/competitor/{{ standing.callsign }}">{{ standing.first_name | competitor_display(standing.callsign) }}</a></td>
            <td class="medal-gold">{{ standing.gold or '-' }}</td>
            <td class="medal-silver">{{ standing.silver or '-' }}</td>
            <td class="medal-bronze">{{ standing.bronze or '-' }}</td>
            <td><strong>{{ standing.total_points }}</strong></td>
        </tr>
        {% if medal_details.get(standing.callsign) %}
        <tr class="details-row" id="details-{{ standing.callsign }}" style="display: none;">
            <td colspan="7" style="padding: 0; background: var(--bg-primary);">
                <div style="padding: 10px 15px 10px 40px;">
                    <table style="margin: 0; font-size: 0.9em;">
                        <thead>
                            <tr>
                                <th>Match</th>
                                <th>QSO Race</th>
                                <th>Cool Factor</th>
                                <th>POTA</th>
                                <th>Pts</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for detail in medal_details[standing.callsign] %}
                            <tr>
                                <td><a href="/olympiad/sport/{{ sport.id }}/match/{{ detail.match_id }}">{{ detail.target | pota_tooltip }}</a></td>
                                <td>
                                    {% if detail.qso_medal == 'gold' %}ü•á
                                    {% elif detail.qso_medal == 'silver' %}ü•à
                                    {% elif detail.qso_medal == 'bronze' %}ü•â
                                    {% else %}-{% endif %}
                                </td>
                                <td>
                                    {% if detail.cf_medal == 'gold' %}ü•á
                                    {% elif detail.cf_medal == 'silver' %}ü•à
                                    {% elif detail.cf_medal == 'bronze' %}ü•â
                                    {% else %}-{% endif %}
                                    {% if detail.cf_value %}<span style="color: var(--text-secondary); font-size: 0.85em;">({{ "%.1f" | format(detail.cf_value) }})</span>{% endif %}
                                </td>
                                <td>{% if detail.pota_bonus %}+{{ detail.pota_bonus }}{% else %}-{% endif %}</td>
                                <td><strong>{{ detail.points }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </td>
        </tr>
        {% endif %}
        {% endfor %}
    </tbody>
</table></div>

<script>
function toggleDetails(callsign) {
    const detailsRow = document.getElementById('details-' + callsign);
    const icon = document.getElementById('icon-' + callsign);
    if (!detailsRow || !icon) return;

    if (detailsRow.style.display === 'none') {
        detailsRow.style.display = 'table-row';
        icon.textContent = '‚ñº';
    } else {
        detailsRow.style.display = 'none';
        icon.textContent = '‚ñ∂';
    }
}
</script>

<style>
.expand-icon {
    font-size: 0.8em;
    color: var(--text-secondary);
    transition: transform 0.2s;
}
.standings-row:hover .expand-icon {
    color: var(--text-primary);
}
.details-row table {
    width: 100%;
    border-collapse: collapse;
}
.details-row th, .details-row td {
    padding: 5px 10px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}
.details-row th {
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.85em;
}
</style>
{% else %}
<div class="card">
    <p>No standings yet. Medals are awarded as matches complete.</p>
</div>
{% endif %}

{% if matches %}
<h3>Matches{% if total_matches > matches|length %} ({{ total_matches }} total){% endif %}</h3>
{% if sport.target_type == 'park' %}
<p id="spots-summary" style="margin-bottom: 10px; color: var(--text-secondary);">
    <span class="loading-spinner" style="vertical-align: middle;"></span> Checking for active spots...
</p>
<div id="active-parks-list" style="display: none; margin-bottom: 15px; padding: 10px; background: var(--bg-secondary); border-radius: 6px; border: 1px solid var(--border-color);">
</div>
{% endif %}
<div class="table-responsive"><table>
    <thead>
        <tr>
            <th scope="col">Target</th>
            <th scope="col">Status</th>
            <th scope="col">Start</th>
            <th scope="col">End</th>
            <th scope="col">Action</th>
        </tr>
    </thead>
    <tbody>
        {% for match in matches %}
        <tr>
            <td>
                <strong>{{ match.target_display | pota_tooltip }}</strong>
                {% if sport.target_type == 'park' %}
                <span class="live-indicator" data-park="{{ match.target_value }}" style="display: none;" title="Active on air now!">üì°</span>
                {% endif %}
            </td>
            <td><span class="status-badge" data-start="{{ match.start_date }}" data-end="{{ match.end_date }}">...</span></td>
            <td>{{ match.start_date | format_date }}</td>
            <td>{{ match.end_date | format_date }}</td>
            <td><a href="/olympiad/sport/{{ sport.id }}/match/{{ match.id }}" class="btn btn-sm"><span class="icon">üëÅÔ∏è</span> View</a></td>
        </tr>
        {% endfor %}
    </tbody>
</table></div>

{% if total_pages > 1 %}
<div class="pagination" style="margin: 20px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
    {% if page > 1 %}
    <a href="?page={{ page - 1 }}" class="btn btn-sm">Previous</a>
    {% endif %}

    <span style="color: var(--text-secondary);">Page {{ page }} of {{ total_pages }}</span>

    {% if page < total_pages %}
    <a href="?page={{ page + 1 }}" class="btn btn-sm">Next</a>
    {% endif %}

    <span style="margin-left: auto; color: var(--text-secondary);">
        Showing {{ ((page - 1) * 50) + 1 }}-{{ [page * 50, total_matches] | min }} of {{ total_matches }}
    </span>
</div>
{% endif %}

<script>
(function() {
    document.querySelectorAll('.status-badge[data-start]').forEach(function(badge) {
        var start = new Date(badge.dataset.start + 'T00:00:00');
        var end = new Date(badge.dataset.end + 'T23:59:59');
        var now = new Date();

        if (now < start) {
            badge.textContent = 'Upcoming';
            badge.classList.add('status-upcoming');
        } else if (now > end) {
            badge.textContent = 'Ended';
            badge.classList.add('status-ended');
        } else {
            badge.textContent = '‚óè Active';
            badge.classList.add('status-active');
        }
    });
})();
</script>

{% if sport.target_type == 'park' %}
<script>
(function() {
    // Build map of park -> match info
    const parkMatches = {
        {% for match in matches %}
        "{{ match.target_value }}": {
            id: {{ match.id }},
            display: "{{ match.target_display | replace('"', '\\"') }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    };

    async function updateLiveIndicators() {
        try {
            const resp = await fetch('/api/v1/spots');
            if (!resp.ok) return;
            const data = await resp.json();
            const activeParks = new Set(data.parks_with_spots || []);

            let activeCount = 0;
            const activeMatchParks = [];
            document.querySelectorAll('.live-indicator[data-park]').forEach(el => {
                const park = el.getAttribute('data-park');
                if (activeParks.has(park)) {
                    el.style.display = 'inline';
                    activeCount++;
                    if (parkMatches[park]) {
                        activeMatchParks.push({ park: park, ...parkMatches[park] });
                    }
                } else {
                    el.style.display = 'none';
                }
            });

            // Update summary message
            const summary = document.getElementById('spots-summary');
            const parksList = document.getElementById('active-parks-list');
            if (summary) {
                if (activeCount > 0) {
                    summary.innerHTML = '<span class="live-indicator">üì°</span> ' + activeCount + ' of {{ total_matches }} parks have activators on the air right now';
                    summary.style.color = 'var(--text-primary)';

                    // Build list of active parks with links
                    if (parksList && activeMatchParks.length > 0) {
                        const links = activeMatchParks.map(p =>
                            '<a href="/olympiad/sport/{{ sport.id }}/match/' + p.id + '" style="margin-right: 12px; white-space: nowrap;">üì° ' + p.display + '</a>'
                        ).join('');
                        parksList.innerHTML = '<strong style="margin-right: 10px;">Active now:</strong>' + links;
                        parksList.style.display = 'block';
                    }
                } else {
                    summary.innerHTML = 'No parks reporting spots right now';
                    summary.style.color = 'var(--text-secondary)';
                    if (parksList) parksList.style.display = 'none';
                }
            }
        } catch (e) {
            console.error('Failed to load spots:', e);
        }
    }

    // Load immediately
    updateLiveIndicators();

    // Refresh every 60 seconds
    setInterval(updateLiveIndicators, 60000);
})();
</script>
{% endif %}
{% else %}
<div class="card">
    <p>No matches scheduled yet.</p>
</div>
{% endif %}

<p><a href="/">Back to Home</a></p>
{% endblock %}
