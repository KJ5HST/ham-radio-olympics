{% extends "base.html" %}

{% block title %}{{ sport.name }} - Ham Radio Olympics{% endblock %}

{% block content %}
<h2>{{ sport.name }}</h2>

{% if sport.description %}
<p>{{ sport.description }}</p>
{% endif %}

<div class="card">
    <p><strong>Target Type:</strong> {{ sport.target_type | title }}</p>
    <p><strong>Competition Modes:</strong>
        {% if sport.work_enabled %}Work{% endif %}
        {% if sport.work_enabled and sport.activate_enabled %} / {% endif %}
        {% if sport.activate_enabled %}Activate{% endif %}
    </p>
    {% if sport.separate_pools %}
    <p><em>Work and Activate have separate medal pools</em></p>
    {% endif %}
    <p><strong>Allowed Modes:</strong> {{ sport.allowed_modes if sport.allowed_modes else 'All modes' }}</p>
    <p><strong>Participants:</strong> {{ entry_count }} <a href="/olympiad/sport/{{ sport.id }}/participants" title="View participants"><span class="icon">üë•</span></a></p>
    {% if user %}
    <div style="margin-top: 10px;">
        {% if is_entered %}
        <span style="color: #38a169; font-weight: bold;">‚úì You are entered in this sport</span>
        <button type="button" class="btn" style="background: #c53030; margin-left: 10px;" onclick="leaveSport()">Leave Sport</button>
        {% else %}
        <button type="button" onclick="enterSport()" class="btn btn-success">Participate</button>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
async function enterSport() {
    const resp = await fetch('/sport/{{ sport.id }}/enter', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin'
    });
    if (resp.ok) {
        location.reload();
    } else {
        const data = await resp.json().catch(() => ({}));
        showToast(data.detail || 'Failed to enter sport', 'error');
    }
}

async function leaveSport() {
    if (!confirm('Leave this sport? You can re-enter later.')) return;
    const resp = await fetch('/sport/{{ sport.id }}/leave', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin'
    });
    if (resp.ok) {
        location.reload();
    } else {
        const data = await resp.json().catch(() => ({}));
        showToast(data.detail || 'Failed to leave sport', 'error');
    }
}
</script>

{% if standings %}
<h3>Overall Standings</h3>
<div class="table-responsive"><table>
    <thead>
        <tr>
            <th scope="col" style="width: 30px;"></th>
            <th scope="col">Rank</th>
            <th scope="col">Callsign</th>
            <th scope="col">ü•á</th>
            <th scope="col">ü•à</th>
            <th scope="col">ü•â</th>
            <th scope="col">Points</th>
        </tr>
    </thead>
    <tbody>
        {% for standing in standings[:20] %}
        <tr class="standings-row" data-callsign="{{ standing.callsign }}">
            <td style="cursor: pointer; text-align: center;" onclick="toggleDetails('{{ standing.callsign }}')">
                {% if medal_details.get(standing.callsign) %}
                <span class="expand-icon" id="icon-{{ standing.callsign }}">‚ñ∂</span>
                {% endif %}
            </td>
            <td>{{ loop.index }}</td>
            <td><a href="/competitor/{{ standing.callsign }}">{{ standing.first_name | competitor_display(standing.callsign) }}</a></td>
            <td class="medal-gold">{{ standing.gold or '-' }}</td>
            <td class="medal-silver">{{ standing.silver or '-' }}</td>
            <td class="medal-bronze">{{ standing.bronze or '-' }}</td>
            <td><strong>{{ standing.total_points }}</strong></td>
        </tr>
        {% if medal_details.get(standing.callsign) %}
        <tr class="details-row" id="details-{{ standing.callsign }}" style="display: none;">
            <td colspan="7" style="padding: 0; background: var(--bg-primary);">
                <div style="padding: 10px 15px 10px 40px;">
                    <table style="margin: 0; font-size: 0.9em;">
                        <thead>
                            <tr>
                                <th style="width: 25px;"></th>
                                <th>Match</th>
                                <th>QSO Race</th>
                                <th>Cool Factor</th>
                                <th>POTA</th>
                                <th>Pts</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for detail in medal_details[standing.callsign] %}
                            <tr>
                                <td style="cursor: pointer; text-align: center;" onclick="toggleQsoDetails('qsos-{{ standing.callsign }}-{{ detail.match_id }}')">
                                    {% if detail.qsos %}
                                    <span class="expand-icon" id="icon-qsos-{{ standing.callsign }}-{{ detail.match_id }}">‚ñ∂</span>
                                    {% endif %}
                                </td>
                                <td><a href="/olympiad/sport/{{ sport.id }}/match/{{ detail.match_id }}">{{ detail.target | pota_tooltip }}</a></td>
                                <td>
                                    {% if detail.qso_medal == 'gold' %}ü•á
                                    {% elif detail.qso_medal == 'silver' %}ü•à
                                    {% elif detail.qso_medal == 'bronze' %}ü•â
                                    {% else %}-{% endif %}
                                </td>
                                <td>
                                    {% if detail.cf_medal == 'gold' %}ü•á
                                    {% elif detail.cf_medal == 'silver' %}ü•à
                                    {% elif detail.cf_medal == 'bronze' %}ü•â
                                    {% else %}-{% endif %}
                                    {% if detail.cf_value %}<span style="color: var(--text-secondary); font-size: 0.85em;">({{ "%.1f" | format(detail.cf_value) }})</span>{% endif %}
                                </td>
                                <td>{% if detail.pota_bonus %}+{{ detail.pota_bonus }}{% else %}-{% endif %}</td>
                                <td><strong>{{ detail.points }}</strong></td>
                            </tr>
                            {% if detail.qsos %}
                            <tr class="qso-details-row" id="qsos-{{ standing.callsign }}-{{ detail.match_id }}" style="display: none;">
                                <td colspan="6" style="padding: 0; background: var(--bg-secondary);">
                                    <div style="padding: 8px 15px 8px 35px;">
                                        <table style="margin: 0; font-size: 0.85em; width: 100%;">
                                            <thead>
                                                <tr>
                                                    <th style="padding: 3px 6px;">Medal</th>
                                                    <th style="padding: 3px 6px;">DX Call</th>
                                                    <th style="padding: 3px 6px;" class="hide-mobile">Time{% if display_prefs.time_display == 'local' and display_prefs.home_grid %} (Local){% else %} (UTC){% endif %}</th>
                                                    <th style="padding: 3px 6px;" class="hide-mobile">Mode</th>
                                                    <th style="padding: 3px 6px;" class="hide-mobile">Power</th>
                                                    <th style="padding: 3px 6px;">Distance</th>
                                                    <th style="padding: 3px 6px;">CF</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for qso in detail.qsos %}
                                                <tr>
                                                    <td style="padding: 3px 6px;">
                                                        {% if qso.medal_type == 'QSO Race' %}
                                                            {% if detail.qso_medal == 'gold' %}ü•á{% elif detail.qso_medal == 'silver' %}ü•à{% elif detail.qso_medal == 'bronze' %}ü•â{% endif %} Race
                                                        {% else %}
                                                            {% if detail.cf_medal == 'gold' %}ü•á{% elif detail.cf_medal == 'silver' %}ü•à{% elif detail.cf_medal == 'bronze' %}ü•â{% endif %} CF
                                                        {% endif %}
                                                    </td>
                                                    <td style="padding: 3px 6px;"><strong>{{ qso.dx_callsign }}</strong></td>
                                                    <td style="padding: 3px 6px;" class="hide-mobile">{{ qso.time | format_datetime(qso.my_grid or display_prefs.home_grid, display_prefs.time_display) }}{% if qso.my_park %} üì° {{ qso.my_park | pota_tooltip }}{% endif %}</td>
                                                    <td style="padding: 3px 6px;" class="hide-mobile">{{ qso.mode or '-' }}</td>
                                                    <td style="padding: 3px 6px;" class="hide-mobile">{% if qso.power %}{{ qso.power }}W{% else %}-{% endif %}</td>
                                                    <td style="padding: 3px 6px;">{% if qso.distance %}{{ qso.distance | format_distance(display_prefs.distance_unit or 'km') }}{% else %}-{% endif %}</td>
                                                    <td style="padding: 3px 6px;">{% if qso.cool_factor %}{% if display_prefs.distance_unit == 'mi' %}{{ "%.1f" | format(qso.cool_factor * 0.621371) }}{% else %}{{ "%.1f" | format(qso.cool_factor) }}{% endif %}{% else %}-{% endif %}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </td>
        </tr>
        {% endif %}
        {% endfor %}
    </tbody>
</table></div>

<script>
function toggleDetails(callsign) {
    const detailsRow = document.getElementById('details-' + callsign);
    const icon = document.getElementById('icon-' + callsign);
    if (!detailsRow || !icon) return;

    if (detailsRow.style.display === 'none') {
        detailsRow.style.display = 'table-row';
        icon.textContent = '‚ñº';
    } else {
        detailsRow.style.display = 'none';
        icon.textContent = '‚ñ∂';
    }
}

function toggleQsoDetails(qsoId) {
    const qsoRow = document.getElementById(qsoId);
    const icon = document.getElementById('icon-' + qsoId);
    if (!qsoRow || !icon) return;

    if (qsoRow.style.display === 'none') {
        qsoRow.style.display = 'table-row';
        icon.textContent = '‚ñº';
    } else {
        qsoRow.style.display = 'none';
        icon.textContent = '‚ñ∂';
    }
}
</script>

<style>
.expand-icon {
    font-size: 0.8em;
    color: var(--text-secondary);
    transition: transform 0.2s;
}
.standings-row:hover .expand-icon {
    color: var(--text-primary);
}
.details-row table {
    width: 100%;
    border-collapse: collapse;
}
.details-row th, .details-row td {
    padding: 5px 10px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}
.details-row th {
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.85em;
}
.qso-details-row table {
    border-collapse: collapse;
}
.qso-details-row th {
    font-weight: 600;
    color: var(--text-secondary);
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}
.qso-details-row td {
    border-bottom: 1px solid var(--border-color);
}
</style>
{% else %}
<div class="card">
    <p>No standings yet. Medals are awarded as matches complete.</p>
</div>
{% endif %}

{% if matches %}
<h3>Matches{% if total_matches > matches|length %} ({{ total_matches }} total){% endif %}</h3>
{% if user %}
<div style="margin-bottom: 10px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
        <input type="checkbox" id="hide-logged" onchange="filterMatches()">
        <span>Hide logged</span>
    </label>
    <span id="logged-count" style="color: var(--text-secondary); font-size: 0.9em;"></span>
</div>
{% endif %}
{% if sport.target_type == 'park' %}
<p id="spots-summary" style="margin-bottom: 10px; color: var(--text-secondary);">
    <span class="loading-spinner" style="vertical-align: middle;"></span> Checking for active spots...
</p>
<div id="active-parks-list" style="display: none; margin-bottom: 15px; padding: 10px; background: var(--bg-secondary); border-radius: 6px; border: 1px solid var(--border-color);">
</div>
{% endif %}
<div class="table-responsive"><table id="matches-table">
    <thead>
        <tr>
            {% if user %}<th scope="col" style="width: 50px;">Logged</th>{% endif %}
            <th scope="col">Target</th>
            <th scope="col">Status</th>
            <th scope="col">Start</th>
            <th scope="col">End</th>
            <th scope="col">Action</th>
        </tr>
    </thead>
    <tbody>
        {% for match in matches %}
        <tr data-logged="{{ 'true' if match.user_logged else 'false' }}">
            {% if user %}
            <td style="text-align: center;">
                {% if match.user_logged %}
                <span style="color: #38a169;" title="You have a confirmed QSO for this match">‚úì</span>
                {% else %}
                <span style="color: var(--text-secondary);">-</span>
                {% endif %}
            </td>
            {% endif %}
            <td>
                <strong>{{ match.target_display | pota_tooltip }}</strong>
                {% if sport.target_type == 'park' %}
                <span class="live-indicator" data-park="{{ match.target_value }}" style="display: none;" title="Active on air now!">üì°</span>
                {% endif %}
            </td>
            <td><span class="status-badge" data-start="{{ match.start_date }}" data-end="{{ match.end_date }}"></span></td>
            <td>{{ match.start_date | format_date }}</td>
            <td>{{ match.end_date | format_date }}</td>
            <td><a href="/olympiad/sport/{{ sport.id }}/match/{{ match.id }}" class="btn btn-sm"><span class="icon">üëÅÔ∏è</span> View</a></td>
        </tr>
        {% endfor %}
    </tbody>
</table></div>

{% if total_pages > 1 %}
<div class="pagination" style="margin: 20px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
    {% if page > 1 %}
    <a href="?page={{ page - 1 }}" class="btn btn-sm">Previous</a>
    {% endif %}

    <span style="color: var(--text-secondary);">Page {{ page }} of {{ total_pages }}</span>

    {% if page < total_pages %}
    <a href="?page={{ page + 1 }}" class="btn btn-sm">Next</a>
    {% endif %}

    <span style="margin-left: auto; color: var(--text-secondary);">
        Showing {{ ((page - 1) * 50) + 1 }}-{{ [page * 50, total_matches] | min }} of {{ total_matches }}
    </span>
</div>
{% endif %}

<script>
(function() {
    document.querySelectorAll('.status-badge[data-start]').forEach(function(badge) {
        // Parse dates - handle "YYYY-MM-DD" or "YYYY-MM-DD HH:MM:SS" formats
        // Treat as UTC by appending Z
        var startStr = badge.dataset.start.replace(' ', 'T');
        var endStr = badge.dataset.end.replace(' ', 'T');
        // If no time component, add it
        if (startStr.length === 10) startStr += 'T00:00:00';
        if (endStr.length === 10) endStr += 'T23:59:59';
        // Append Z to treat as UTC
        var start = new Date(startStr + 'Z');
        var end = new Date(endStr + 'Z');
        var now = new Date();

        if (now >= start && now <= end) {
            badge.classList.add('status-active');
            badge.title = 'Active - eligible for points';
        } else {
            badge.classList.add('status-inactive');
            badge.title = now < start ? 'Upcoming' : 'Ended';
        }
    });

    // Update logged count
    updateLoggedCount();
})();

function updateLoggedCount() {
    const countEl = document.getElementById('logged-count');
    if (!countEl) return;
    const rows = document.querySelectorAll('#matches-table tbody tr');
    const logged = Array.from(rows).filter(r => r.dataset.logged === 'true').length;
    const total = rows.length;
    countEl.textContent = `${logged}/${total} logged`;
}

function filterMatches() {
    const hideLogged = document.getElementById('hide-logged')?.checked || false;
    const rows = document.querySelectorAll('#matches-table tbody tr');
    rows.forEach(row => {
        if (hideLogged && row.dataset.logged === 'true') {
            row.style.display = 'none';
        } else {
            row.style.display = '';
        }
    });
}

</script>

{% if sport.target_type == 'park' %}
<script>
(function() {
    // Build map of park -> match info from ACTIVE matches (by date, not pagination)
    const parkMatches = {
        {% for match in active_matches %}
        "{{ match.target_value }}": {
            id: {{ match.id }},
            display: "{{ match.target_display | replace('"', '\\"') }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    };

    function formatSpotTooltip(parkName, spots) {
        // Format: "Park Name: W1ABC on SSB, K2XYZ on FT8"
        if (!spots || spots.length === 0) return parkName + ': Active on air now!';
        const activators = spots.map(s => s.activator + ' on ' + s.mode).join(', ');
        return parkName + ': ' + activators;
    }

    async function updateLiveIndicators() {
        try {
            const resp = await fetch('/api/v1/spots?sport_id={{ sport.id }}');
            if (!resp.ok) return;
            const data = await resp.json();
            const activeParks = new Set(data.parks_with_spots || []);
            const spotDetails = data.spot_details || {};

            // Update DOM indicators for matches visible on current page
            document.querySelectorAll('.live-indicator[data-park]').forEach(el => {
                const park = el.getAttribute('data-park');
                if (activeParks.has(park)) {
                    el.style.display = 'inline';
                    const parkInfo = parkMatches[park];
                    const parkName = parkInfo ? parkInfo.display : park;
                    el.title = formatSpotTooltip(parkName, spotDetails[park]);
                } else {
                    el.style.display = 'none';
                }
            });

            // Build summary from ALL active matches (not just current page)
            let activeCount = 0;
            const activeMatchParks = [];
            for (const [park, parkInfo] of Object.entries(parkMatches)) {
                if (activeParks.has(park)) {
                    activeCount++;
                    activeMatchParks.push({
                        park: park,
                        spots: spotDetails[park] || [],
                        ...parkInfo
                    });
                }
            }

            // Update summary message
            const summary = document.getElementById('spots-summary');
            const parksList = document.getElementById('active-parks-list');
            if (summary) {
                if (activeCount > 0) {
                    summary.innerHTML = '<span class="live-indicator">üì°</span> ' + activeCount + ' of {{ total_matches }} parks have activators on the air right now';
                    summary.style.color = 'var(--text-primary)';

                    // Build list of active parks with links and tooltips
                    if (parksList && activeMatchParks.length > 0) {
                        const links = activeMatchParks.map(p => {
                            const tooltip = formatSpotTooltip(p.display, p.spots);
                            return '<a href="/olympiad/sport/{{ sport.id }}/match/' + p.id + '" style="margin-right: 12px; white-space: nowrap;" title="' + tooltip.replace(/"/g, '&quot;') + '">üì° ' + p.display + '</a>';
                        }).join('');
                        parksList.innerHTML = '<strong style="margin-right: 10px;">Active now:</strong>' + links;
                        parksList.style.display = 'block';
                    }
                } else {
                    summary.innerHTML = 'No parks reporting spots right now{% if sport.allowed_modes %} (filtering for {{ sport.allowed_modes }}){% endif %}';
                    summary.style.color = 'var(--text-secondary)';
                    if (parksList) parksList.style.display = 'none';
                }
            }
        } catch (e) {
            console.error('Failed to load spots:', e);
        }
    }

    // Load immediately
    updateLiveIndicators();

    // Refresh every 60 seconds
    setInterval(updateLiveIndicators, 60000);
})();
</script>
{% endif %}
{% else %}
<div class="card">
    <p>No matches scheduled yet.</p>
</div>
{% endif %}

<p><a href="/">Back to Home</a></p>
{% endblock %}
