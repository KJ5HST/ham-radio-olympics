{% extends "base.html" %}

{% block title %}{{ competitor.callsign }} - Ham Radio Olympics{% endblock %}

{% block nav_extra %}{% endblock %}

{% block content %}
{% if is_own_profile %}
<h2>Welcome, {{ competitor.first_name | competitor_display(competitor.callsign) }}</h2>
{% else %}
<h2>{{ competitor.first_name | competitor_display(competitor.callsign) }}</h2>
{% endif %}

<div class="stats">
    <a href="#medals-section" class="stat-box" style="text-decoration: none; color: inherit;">
        <div class="value">ü•á <span class="medal-gold">{{ medal_summary.gold }}</span></div>
        <div class="label">Gold</div>
    </a>
    <a href="#medals-section" class="stat-box" style="text-decoration: none; color: inherit;">
        <div class="value">ü•à <span class="medal-silver">{{ medal_summary.silver }}</span></div>
        <div class="label">Silver</div>
    </a>
    <a href="#medals-section" class="stat-box" style="text-decoration: none; color: inherit;">
        <div class="value">ü•â <span class="medal-bronze">{{ medal_summary.bronze }}</span></div>
        <div class="label">Bronze</div>
    </a>
    <a href="#medals-section" class="stat-box" style="text-decoration: none; color: inherit;">
        <div class="value">{{ medal_summary.total_points }}</div>
        <div class="label">Points</div>
    </a>
</div>

<div class="card">
    <h4>Account Status</h4>
    <p><strong>Registered:</strong> {{ competitor.registered_at | format_date if competitor.registered_at else '-' }}</p>
    {% if is_own_profile %}
    <p><strong>QRZ API Key:</strong> {% if user.has_qrz_key %}Stored{% else %}<span style="color: #718096;">Not stored</span>{% endif %}</p>
    <p><strong>LoTW Credentials:</strong> {% if user.has_lotw_creds %}Stored{% else %}<span style="color: #718096;">Not stored</span>{% endif %}</p>
    {% endif %}
    <p><strong>Last Sync:</strong> {{ competitor.last_sync_at | format_datetime(competitor.home_grid, competitor.time_display) if competitor.last_sync_at else 'Never' }}</p>
    {% if is_own_profile %}
    <div style="margin-top: 15px;">
        <strong>Sync QSOs:</strong>
        <div style="display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap;">
            {% if user.has_qrz_key %}
            <button onclick="syncQrzStored()" id="sync-qrz-btn" class="btn"><span class="icon">üîÑ</span> Sync from QRZ</button>
            {% else %}
            <button onclick="showQrzModal()" id="sync-qrz-btn" class="btn"><span class="icon">üîÑ</span> Sync from QRZ</button>
            {% endif %}
            {% if user.has_lotw_creds %}
            <button onclick="syncLotwStored()" id="sync-lotw-btn" class="btn btn-purple"><span class="icon">üîÑ</span> Sync from LoTW</button>
            {% else %}
            <button onclick="showLotwModal()" id="sync-lotw-btn" class="btn btn-purple"><span class="icon">üîÑ</span> Sync from LoTW</button>
            {% endif %}
        </div>
        <p style="margin-top: 10px; font-size: 0.85em; color: #718096;">
            Sync checks for new and updated QSOs from the last 60 days to catch recent confirmations.
            <a href="/settings">Manage stored credentials</a>
        </p>
    </div>

    <div style="margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 15px;">
        <strong>Reset QSOs:</strong>
        <div style="margin-top: 8px;">
            <button onclick="resetQsos()" id="reset-qsos-btn" class="btn btn-warning"><span class="icon">üîÑ</span> Reset & Reload QSOs</button>
        </div>
        <p style="margin-top: 8px; font-size: 0.85em; color: #718096;">
            This will delete all your QSOs and reload them from scratch. Use this if your QSO data seems incorrect or out of sync.
        </p>
    </div>

    <!-- QRZ Modal -->
    <div id="qrz-modal" class="modal-overlay">
        <div class="modal-content">
            <h4 style="margin-top: 0;">Sync from QRZ</h4>
            <p style="color: #718096; font-size: 0.9em;">Enter your QRZ API key to sync your QSOs.</p>
            <div class="form-group">
                <label for="qrz-api-key">QRZ API Key</label>
                <input type="text" id="qrz-api-key" placeholder="XXXX-XXXX-XXXX-XXXX">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button onclick="syncQrz()" id="qrz-submit-btn" class="btn btn-success" style="flex: 1;"><span class="icon">üîÑ</span> Sync</button>
                <button onclick="hideQrzModal()" class="btn btn-secondary" style="flex: 1;"><span class="icon">‚úï</span> Cancel</button>
            </div>
            <div id="qrz-result" style="margin-top: 10px;"></div>
        </div>
    </div>

    <!-- LoTW Modal -->
    <div id="lotw-modal" class="modal-overlay">
        <div class="modal-content">
            <h4 style="margin-top: 0;">Sync from LoTW</h4>
            <p style="color: #718096; font-size: 0.9em;">Enter your LoTW credentials to sync your QSOs.</p>
            <div class="form-group">
                <label for="lotw-username">LoTW Username</label>
                <input type="text" id="lotw-username" placeholder="Your callsign" value="{{ competitor.callsign }}">
            </div>
            <div class="form-group">
                <label for="lotw-password">LoTW Password</label>
                <input type="password" id="lotw-password" placeholder="Your LoTW password">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button onclick="syncLotw()" id="lotw-submit-btn" class="btn btn-success" style="flex: 1;"><span class="icon">üîÑ</span> Sync</button>
                <button onclick="hideLotwModal()" class="btn btn-secondary" style="flex: 1;"><span class="icon">‚úï</span> Cancel</button>
            </div>
            <div id="lotw-result" style="margin-top: 10px;"></div>
        </div>
    </div>

    <!-- Reset Credentials Modal (shown when no credentials stored) -->
    <div id="reset-credentials-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <h4 style="margin-top: 0;">Enter Logbook Credentials</h4>
            <p style="color: #718096; font-size: 0.9em;">
                Enter at least one credential source to reload your QSOs.
                Your credentials will be stored for future syncs.
            </p>

            <fieldset style="border: 1px solid var(--border-color); border-radius: 4px; padding: 15px; margin-bottom: 15px;">
                <legend style="padding: 0 10px; font-weight: bold;">QRZ Logbook</legend>
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="reset-qrz-api-key">QRZ API Key</label>
                    <input type="text" id="reset-qrz-api-key" placeholder="XXXX-XXXX-XXXX-XXXX">
                </div>
                <p style="font-size: 0.8em; color: #718096; margin-top: 5px;">
                    Get your API key from qrz.com &rarr; Logbook &rarr; Settings
                </p>
            </fieldset>

            <fieldset style="border: 1px solid var(--border-color); border-radius: 4px; padding: 15px; margin-bottom: 15px;">
                <legend style="padding: 0 10px; font-weight: bold;">LoTW (Logbook of the World)</legend>
                <div class="form-group" style="margin-bottom: 10px;">
                    <label for="reset-lotw-username">LoTW Username</label>
                    <input type="text" id="reset-lotw-username" placeholder="Your callsign" value="{{ competitor.callsign }}">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="reset-lotw-password">LoTW Password</label>
                    <input type="password" id="reset-lotw-password" placeholder="Your LoTW password">
                </div>
            </fieldset>

            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button onclick="submitResetWithCredentials()" id="reset-submit-btn" class="btn btn-warning" style="flex: 1;"><span class="icon">üîÑ</span> Reset & Reload</button>
                <button onclick="hideResetCredentialsModal()" class="btn btn-secondary" style="flex: 1;"><span class="icon">‚úï</span> Cancel</button>
            </div>
            <div id="reset-credentials-result" style="margin-top: 10px;"></div>
        </div>
    </div>

    <script>
    // Format sync result message
    function formatSyncResult(data) {
        if (data.message) return data.message;
        const parts = [];
        if (data.new_qsos > 0) parts.push(data.new_qsos + ' new');
        if (data.updated_qsos > 0) parts.push(data.updated_qsos + ' updated');
        if (parts.length === 0) return 'QSOs synced successfully';
        return 'Synced ' + data.total_fetched + ' QSOs (' + parts.join(', ') + ')';
    }

    // QRZ sync with stored credentials
    async function syncQrzStored() {
        const btn = document.getElementById('sync-qrz-btn');
        setButtonLoading(btn, true);
        try {
            const resp = await fetch('/sync?callsign={{ competitor.callsign }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin'
            });
            const data = await resp.json();
            if (!resp.ok) {
                showToast('Sync failed: ' + (data.detail || 'Unknown error'), 'error');
                setButtonLoading(btn, false);
            } else {
                showToast(formatSyncResult(data), 'success');
                setTimeout(() => location.reload(), 1500);
            }
        } catch (e) {
            setButtonLoading(btn, false);
            showToast('Sync failed. Please try again.', 'error');
        }
    }

    // LoTW sync with stored credentials
    async function syncLotwStored() {
        const btn = document.getElementById('sync-lotw-btn');
        setButtonLoading(btn, true);
        try {
            const resp = await fetch('/sync/lotw/stored', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin'
            });
            const data = await resp.json();
            if (!resp.ok) {
                showToast('Sync failed: ' + (data.detail || 'Unknown error'), 'error');
                setButtonLoading(btn, false);
            } else {
                showToast(formatSyncResult(data), 'success');
                setTimeout(() => location.reload(), 1500);
            }
        } catch (e) {
            setButtonLoading(btn, false);
            showToast('Sync failed. Please try again.', 'error');
        }
    }

    // QRZ modal functions
    function showQrzModal() {
        document.getElementById('qrz-modal').classList.add('show');
        document.getElementById('qrz-api-key').focus();
    }

    function hideQrzModal() {
        document.getElementById('qrz-modal').classList.remove('show');
        document.getElementById('qrz-api-key').value = '';
        document.getElementById('qrz-result').innerHTML = '';
    }

    async function syncQrz() {
        const btn = document.getElementById('qrz-submit-btn');
        const result = document.getElementById('qrz-result');
        const apiKey = document.getElementById('qrz-api-key').value;

        if (!apiKey) {
            result.innerHTML = '<div class="alert alert-error">Please enter your QRZ API key</div>';
            return;
        }

        setButtonLoading(btn, true);
        result.innerHTML = '';

        try {
            const resp = await fetch('/sync/qrz', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({api_key: apiKey})
            });
            const data = await resp.json();
            if (resp.ok) {
                hideQrzModal();
                showToast(formatSyncResult(data), 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                result.innerHTML = '<div class="alert alert-error">' + (data.detail || 'Sync failed') + '</div>';
                setButtonLoading(btn, false);
            }
        } catch (e) {
            result.innerHTML = '<div class="alert alert-error">Sync failed: ' + e.message + '</div>';
            setButtonLoading(btn, false);
        }
    }

    // LoTW modal functions
    function showLotwModal() {
        document.getElementById('lotw-modal').classList.add('show');
        document.getElementById('lotw-password').focus();
    }

    function hideLotwModal() {
        document.getElementById('lotw-modal').classList.remove('show');
        document.getElementById('lotw-password').value = '';
        document.getElementById('lotw-result').innerHTML = '';
    }

    async function syncLotw() {
        const btn = document.getElementById('lotw-submit-btn');
        const result = document.getElementById('lotw-result');
        const username = document.getElementById('lotw-username').value;
        const password = document.getElementById('lotw-password').value;

        if (!username || !password) {
            result.innerHTML = '<div class="alert alert-error">Please enter both username and password</div>';
            return;
        }

        setButtonLoading(btn, true);
        result.innerHTML = '';

        try {
            const resp = await fetch('/sync/lotw', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: username, password: password})
            });
            const data = await resp.json();
            if (resp.ok) {
                hideLotwModal();
                showToast(formatSyncResult(data), 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                result.innerHTML = '<div class="alert alert-error">' + (data.detail || 'Sync failed') + '</div>';
                setButtonLoading(btn, false);
            }
        } catch (e) {
            result.innerHTML = '<div class="alert alert-error">Sync failed: ' + e.message + '</div>';
            setButtonLoading(btn, false);
        }
    }

    // Reset QSOs functions
    async function resetQsos() {
        const btn = document.getElementById('reset-qsos-btn');

        // First check if we have stored credentials
        try {
            const preflightResp = await fetch('/qsos/reset/preflight', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin'
            });
            const preflight = await preflightResp.json();

            if (!preflightResp.ok) {
                showToast('Error: ' + (preflight.detail || 'Failed to check credentials'), 'error');
                return;
            }

            if (preflight.can_reset) {
                // Has stored credentials - confirm and reset
                if (!confirm('This will delete all your QSOs and reload them from scratch.\n\nAre you sure you want to continue?')) {
                    return;
                }

                setButtonLoading(btn, true);
                const resetResp = await fetch('/qsos/reset', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin'
                });
                const resetData = await resetResp.json();

                if (!resetResp.ok) {
                    showToast('Reset failed: ' + (resetData.detail || 'Unknown error'), 'error');
                    setButtonLoading(btn, false);
                } else {
                    showToast('Reset complete! Deleted ' + resetData.deleted_qsos + ' QSOs and reloaded.', 'success');
                    setTimeout(() => location.reload(), 2000);
                }
            } else {
                // No stored credentials - show modal to enter them
                showResetCredentialsModal();
            }
        } catch (e) {
            showToast('Error: ' + e.message, 'error');
        }
    }

    function showResetCredentialsModal() {
        document.getElementById('reset-credentials-modal').classList.add('show');
        document.getElementById('reset-qrz-api-key').focus();
    }

    function hideResetCredentialsModal() {
        document.getElementById('reset-credentials-modal').classList.remove('show');
        document.getElementById('reset-qrz-api-key').value = '';
        document.getElementById('reset-lotw-password').value = '';
        document.getElementById('reset-credentials-result').innerHTML = '';
    }

    async function submitResetWithCredentials() {
        const btn = document.getElementById('reset-submit-btn');
        const result = document.getElementById('reset-credentials-result');

        const qrzApiKey = document.getElementById('reset-qrz-api-key').value.trim();
        const lotwUsername = document.getElementById('reset-lotw-username').value.trim();
        const lotwPassword = document.getElementById('reset-lotw-password').value;

        const hasQrz = qrzApiKey.length > 0;
        const hasLotw = lotwUsername.length > 0 && lotwPassword.length > 0;

        if (!hasQrz && !hasLotw) {
            result.innerHTML = '<div class="alert alert-error">Please enter QRZ API key and/or LoTW credentials</div>';
            return;
        }

        if (!confirm('This will delete all your QSOs and reload them from scratch.\n\nAre you sure you want to continue?')) {
            return;
        }

        setButtonLoading(btn, true);
        result.innerHTML = '';

        try {
            const body = {};
            if (hasQrz) body.qrz_api_key = qrzApiKey;
            if (hasLotw) {
                body.lotw_username = lotwUsername;
                body.lotw_password = lotwPassword;
            }

            const resp = await fetch('/qsos/reset-with-key', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });
            const data = await resp.json();

            if (resp.ok) {
                hideResetCredentialsModal();
                showToast('Reset complete! Deleted ' + data.deleted_qsos + ' QSOs and reloaded.', 'success');
                setTimeout(() => location.reload(), 2000);
            } else {
                result.innerHTML = '<div class="alert alert-error">' + (data.detail || 'Reset failed') + '</div>';
                setButtonLoading(btn, false);
            }
        } catch (e) {
            result.innerHTML = '<div class="alert alert-error">Reset failed: ' + e.message + '</div>';
            setButtonLoading(btn, false);
        }
    }

    // Close modals on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideQrzModal();
            hideLotwModal();
            hideResetCredentialsModal();
        }
    });
    </script>
    {% endif %}
</div>

{% if is_own_profile %}
<h3>My Team</h3>
<div class="card" style="margin-bottom: 20px;">
    {% if user_team %}
    <p>
        <strong>Team:</strong> <a href="/team/{{ user_team.id }}">{{ user_team.name }}</a>
        {% if is_team_captain %}<span style="color: #718096;">(Captain)</span>{% endif %}
    </p>
    <p><strong>Members:</strong> {{ team_member_count }}</p>
    <div style="margin-top: 15px; display: flex; gap: 10px;">
        <a href="/team/{{ user_team.id }}" class="btn">View Team</a>
        {% if not is_team_captain %}
        <button type="button" class="btn" style="background: #c53030;" onclick="leaveTeam({{ user_team.id }})">Leave Team</button>
        {% endif %}
    </div>
    {% else %}
    <p>You are not on a team.</p>

    {% if pending_team_invites %}
    <h4 style="margin-top: 15px;">Pending Invites</h4>
    <table style="margin-bottom: 15px;">
        <thead>
            <tr>
                <th>Team</th>
                <th>Invited</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for inv in pending_team_invites %}
            <tr>
                <td><a href="/team/{{ inv.team_id }}">{{ inv.team_name }}</a></td>
                <td>{{ inv.created_at | format_date }}</td>
                <td>
                    <button type="button" class="btn btn-success" style="font-size: 0.8em; padding: 3px 8px;" onclick="acceptInvite({{ inv.team_id }})">Accept</button>
                    <button type="button" class="btn" style="font-size: 0.8em; padding: 3px 8px; background: #718096;" onclick="rejectInvite({{ inv.team_id }})">Decline</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    <div style="margin-top: 15px;">
        <a href="/teams" class="btn btn-success">Browse Teams</a>
    </div>
    {% endif %}
</div>

<script>
async function leaveTeam(teamId) {
    if (!confirm('Are you sure you want to leave this team?')) return;

    try {
        const resp = await fetch('/team/' + teamId + '/leave', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin'
        });
        const data = await resp.json();
        if (resp.ok) {
            window.location.reload();
        } else {
            showToast(data.detail || 'Failed to leave team', 'error');
        }
    } catch (err) {
        showToast('Network error', 'error');
    }
}

async function acceptInvite(teamId) {
    try {
        const resp = await fetch('/team/' + teamId + '/accept', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin'
        });
        const data = await resp.json();
        if (resp.ok) {
            showToast(data.message, 'success');
            window.location.reload();
        } else {
            showToast(data.detail || 'Failed to accept invite', 'error');
        }
    } catch (err) {
        showToast('Network error', 'error');
    }
}

async function rejectInvite(teamId) {
    if (!confirm('Decline this team invite?')) return;

    try {
        const resp = await fetch('/team/' + teamId + '/reject', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin'
        });
        const data = await resp.json();
        if (resp.ok) {
            showToast('Invite declined', 'success');
            window.location.reload();
        } else {
            showToast(data.detail || 'Failed to decline invite', 'error');
        }
    } catch (err) {
        showToast('Network error', 'error');
    }
}
</script>
{% endif %}

{% if sport_entries %}
<h3>{% if is_own_profile %}My {% endif %}Sports</h3>
<div class="table-responsive"><table>
    <thead>
        <tr>
            <th scope="col">Sport</th>
            <th scope="col">Olympiad</th>
            <th scope="col">Medals</th>
            <th scope="col">Points</th>
        </tr>
    </thead>
    <tbody>
        {% for sport in sport_entries %}
        <tr>
            <td><a href="/olympiad/sport/{{ sport.id }}"><strong>{{ sport.name }}</strong></a></td>
            <td>{{ sport.olympiad_name }}</td>
            <td>
                {% if sport.gold_count %}<span class="medal-count"><span class="gold">ü•á{{ sport.gold_count }}</span></span> {% endif %}
                {% if sport.silver_count %}<span class="medal-count"><span class="silver">ü•à{{ sport.silver_count }}</span></span> {% endif %}
                {% if sport.bronze_count %}<span class="medal-count"><span class="bronze">ü•â{{ sport.bronze_count }}</span></span> {% endif %}
                {% if not sport.gold_count and not sport.silver_count and not sport.bronze_count %}-{% endif %}
            </td>
            <td><strong>{{ sport.sport_points }}</strong></td>
        </tr>
        {% endfor %}
    </tbody>
</table></div>
{% endif %}

{% if personal_bests %}
<h3>Personal Bests (Competition)</h3>
<div class="table-responsive"><table>
    <thead>
        <tr>
            <th scope="col">Record Type</th>
            <th scope="col">Value</th>
            <th scope="col">Date</th>
        </tr>
    </thead>
    <tbody>
        {% for record in personal_bests %}
        <tr>
            <td>{{ record.record_type | replace('_', ' ') | title }}</td>
            <td>
                {% if 'distance' in record.record_type %}
                    {{ record.value | format_distance(competitor.distance_unit or 'km') }}
                {% elif 'cool_factor' in record.record_type %}
                    {% if competitor.distance_unit == 'mi' %}
                        {{ "%.1f" | format(record.value * 0.621371) }} mi/W
                    {% else %}
                        {{ "%.1f" | format(record.value) }} km/W
                    {% endif %}
                {% elif 'power' in record.record_type %}
                    {{ "%.1f" | format(record.value) }} W
                {% else %}
                    {{ record.value }}
                {% endif %}
            </td>
            <td>{{ record.achieved_at | format_datetime(competitor.home_grid, competitor.time_display) if record.achieved_at else '-' }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table></div>
{% endif %}

{% if alltime_bests %}
<h3>Personal Bests (All Time)</h3>
<div class="table-responsive"><table>
    <thead>
        <tr>
            <th scope="col">Record Type</th>
            <th scope="col">Value</th>
            <th scope="col">Contact</th>
            <th scope="col">Date</th>
        </tr>
    </thead>
    <tbody>
        {% for record in alltime_bests %}
        <tr>
            <td>{{ record.record_type | replace('_', ' ') | title }}</td>
            <td>
                {% if 'distance' in record.record_type %}
                    {{ record.value | format_distance(competitor.distance_unit or 'km') }}
                {% elif 'cool_factor' in record.record_type %}
                    {% if competitor.distance_unit == 'mi' %}
                        {{ "%.1f" | format(record.value * 0.621371) }} mi/W
                    {% else %}
                        {{ "%.1f" | format(record.value) }} km/W
                    {% endif %}
                {% elif 'power' in record.record_type %}
                    {{ "%.1f" | format(record.value) }} W
                {% else %}
                    {{ record.value }}
                {% endif %}
            </td>
            <td>{{ record.dx_callsign }}</td>
            <td>{{ record.achieved_at | format_datetime(competitor.home_grid, competitor.time_display) if record.achieved_at else '-' }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table></div>
{% endif %}

{% if medals %}
<h3 id="medals-section">{% if is_own_profile %}Recent {% endif %}Medals</h3>
<div class="table-responsive"><table>
    <thead>
        <tr>
            <th scope="col">Sport</th>
            <th scope="col">Target</th>
            <th scope="col">QSO Race</th>
            <th scope="col">Cool Factor</th>
            <th scope="col">Points</th>
            <th scope="col"></th>
        </tr>
    </thead>
    <tbody>
        {% for medal in medals[:10] %}
        <tr>
            <td><a href="/olympiad/sport/{{ medal.sport_id }}">{{ medal.sport_name }}</a></td>
            <td>{{ medal.target_display | pota_tooltip }}</td>
            <td>
                {% if medal.qso_race_medal %}
                    {% if medal.qso_race_medal == 'gold' %}ü•á{% elif medal.qso_race_medal == 'silver' %}ü•à{% elif medal.qso_race_medal == 'bronze' %}ü•â{% endif %}
                    {% if medal.qso_race_dx %}
                    <small style="color: var(--text-secondary);" title="QSO with {{ medal.qso_race_dx }} at {{ medal.qso_race_claim_time }}">{{ medal.qso_race_dx }}</small>
                    {% endif %}
                {% else %}
                    -
                {% endif %}
            </td>
            <td>
                {% if medal.cool_factor_medal %}
                    {% if medal.cool_factor_medal == 'gold' %}ü•á{% elif medal.cool_factor_medal == 'silver' %}ü•à{% elif medal.cool_factor_medal == 'bronze' %}ü•â{% endif %}
                    {% if medal.cool_factor_dx %}
                    <small style="color: var(--text-secondary);" title="QSO with {{ medal.cool_factor_dx }} (CF: {{ '%.1f' | format(medal.cool_factor_value) if medal.cool_factor_value else '-' }})">{{ medal.cool_factor_dx }}</small>
                    {% endif %}
                {% else %}
                    -
                {% endif %}
            </td>
            <td>{{ medal.total_points }}</td>
            <td><a href="/olympiad/sport/{{ medal.sport_id }}/match/{{ medal.match_id }}" class="btn btn-sm" title="View match details"><span class="icon">üëÅÔ∏è</span></a></td>
        </tr>
        {% endfor %}
    </tbody>
</table></div>
{% endif %}

<h3>{% if is_own_profile %}QSO Log{% else %}QSOs{% endif %}</h3>
<div class="card" style="margin-bottom: 15px;">
    <form method="get" id="qso-filter-form">
        <input type="hidden" name="callsign" value="{{ competitor.callsign }}">
        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: end;">
            <div class="form-group" style="margin-bottom: 0;">
                <label for="band">Band</label>
                <select id="band" name="band" style="min-width: 100px;">
                    <option value="">All Bands</option>
                    {% for b in ['160m', '80m', '60m', '40m', '30m', '20m', '17m', '15m', '12m', '10m', '6m', '2m', '70cm'] %}
                    <option value="{{ b }}" {% if request.query_params.get('band') == b %}selected{% endif %}>{{ b }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label for="mode">Mode</label>
                <select id="mode" name="mode" style="min-width: 100px;">
                    <option value="">All Modes</option>
                    {% for m in ['SSB', 'CW', 'FT8', 'FT4', 'RTTY', 'PSK31', 'FM', 'AM', 'DIGI'] %}
                    <option value="{{ m }}" {% if request.query_params.get('mode') == m %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label for="confirmed">Status</label>
                <select id="confirmed" name="confirmed" style="min-width: 120px;">
                    <option value="">All QSOs</option>
                    <option value="1" {% if request.query_params.get('confirmed') == '1' %}selected{% endif %}>Confirmed</option>
                    <option value="0" {% if request.query_params.get('confirmed') == '0' %}selected{% endif %}>Unconfirmed</option>
                </select>
            </div>
            <div class="btn-group">
                <button type="button" class="btn" onclick="filterQsos(1)" style="min-width: 80px;"><span class="icon">üîç</span> Filter</button>
                <button type="button" class="btn btn-secondary" onclick="toggleAdvancedFilters()" style="min-width: 100px;"><span class="icon">‚öôÔ∏è</span> Advanced</button>
                <button type="button" class="btn btn-secondary" onclick="clearFilters()" style="min-width: 70px;"><span class="icon">‚úï</span> Clear</button>
            </div>
            {% if is_own_profile %}
            <div class="btn-group" style="margin-left: auto;">
                <div class="dropdown" style="position: relative; display: inline-block;">
                    <button type="button" class="btn btn-info" onclick="toggleExportMenu()" id="export-qsos-btn" style="min-width: 120px;"><span class="icon">üì•</span> Export <span style="font-size: 0.8em;">‚ñº</span></button>
                    <div id="export-qsos-menu" class="dropdown-menu" style="display: none; position: absolute; top: 100%; right: 0; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 1000; min-width: 120px;">
                        <a href="/export/qsos?format=csv" class="dropdown-item" style="display: block; padding: 8px 12px; text-decoration: none; color: var(--text-primary);">QSOs (CSV)</a>
                        <a href="/export/qsos?format=adif" class="dropdown-item" style="display: block; padding: 8px 12px; text-decoration: none; color: var(--text-primary);">QSOs (ADIF)</a>
                        <a href="/export/medals" class="dropdown-item" style="display: block; padding: 8px 12px; text-decoration: none; color: var(--text-primary);">Medals (CSV)</a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Advanced Filters (hidden by default) -->
        {% set has_advanced = request.query_params.get('date_from') or request.query_params.get('date_to') or request.query_params.get('dx_call') or request.query_params.get('distance_min') or request.query_params.get('distance_max') or request.query_params.get('cf_min') or request.query_params.get('cf_max') or request.query_params.get('power_min') or request.query_params.get('power_max') or request.query_params.get('pota') %}
        <div id="advanced-filters" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); {% if not has_advanced %}display: none;{% endif %}">
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: end; margin-bottom: 10px;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="dx_call">DX Callsign</label>
                    <input type="text" id="dx_call" name="dx_call" placeholder="e.g. W1AW" style="width: 100px;" value="{{ request.query_params.get('dx_call', '') }}">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="date_from">Date From</label>
                    <input type="date" id="date_from" name="date_from" style="width: 140px;" value="{{ request.query_params.get('date_from', '') }}">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="date_to">Date To</label>
                    <input type="date" id="date_to" name="date_to" style="width: 140px;" value="{{ request.query_params.get('date_to', '') }}">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="pota">POTA</label>
                    <select id="pota" name="pota" style="min-width: 100px;">
                        <option value="">All QSOs</option>
                        <option value="1" {% if request.query_params.get('pota') == '1' %}selected{% endif %}>POTA Only</option>
                    </select>
                </div>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: end;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Distance (km)</label>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <input type="number" id="distance_min" name="distance_min" placeholder="Min" style="width: 70px;" value="{{ request.query_params.get('distance_min', '') }}" min="0">
                        <span>-</span>
                        <input type="number" id="distance_max" name="distance_max" placeholder="Max" style="width: 70px;" value="{{ request.query_params.get('distance_max', '') }}" min="0">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Cool Factor</label>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <input type="number" id="cf_min" name="cf_min" placeholder="Min" style="width: 70px;" value="{{ request.query_params.get('cf_min', '') }}" min="0" step="0.1">
                        <span>-</span>
                        <input type="number" id="cf_max" name="cf_max" placeholder="Max" style="width: 70px;" value="{{ request.query_params.get('cf_max', '') }}" min="0" step="0.1">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Power (W)</label>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <input type="number" id="power_min" name="power_min" placeholder="Min" style="width: 70px;" value="{{ request.query_params.get('power_min', '') }}" min="0">
                        <span>-</span>
                        <input type="number" id="power_max" name="power_max" placeholder="Max" style="width: 70px;" value="{{ request.query_params.get('power_max', '') }}" min="0">
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
function toggleAdvancedFilters() {
    var panel = document.getElementById('advanced-filters');
    if (!panel) return;
    var isHidden = window.getComputedStyle(panel).display === 'none';
    panel.style.display = isHidden ? 'block' : 'none';
}

function toggleExportMenu() {
    var menu = document.getElementById('export-qsos-menu');
    if (!menu) return;
    var isHidden = window.getComputedStyle(menu).display === 'none';
    menu.style.display = isHidden ? 'block' : 'none';
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    var menu = document.getElementById('export-qsos-menu');
    var btn = document.getElementById('export-qsos-btn');
    if (menu && btn && !btn.contains(e.target) && !menu.contains(e.target)) {
        menu.style.display = 'none';
    }
});

// Clear all filters
function clearFilters() {
    var form = document.getElementById('qso-filter-form');
    if (!form) return;

    // Reset all inputs except hidden callsign field
    var inputs = form.querySelectorAll('input, select');
    inputs.forEach(function(input) {
        if (input.type === 'hidden' && input.name === 'callsign') {
            return; // Don't clear the callsign
        }
        if (input.type === 'select-one') {
            input.selectedIndex = 0;
        } else {
            input.value = '';
        }
    });

    // Update URL and reload QSOs
    history.replaceState(null, '', window.location.pathname);
    filterQsos(1);
}

// AJAX QSO filtering
function filterQsos(page) {
    var form = document.getElementById('qso-filter-form');
    if (!form) {
        console.error('Filter form not found');
        return;
    }

    var params = new URLSearchParams();

    // Collect all form inputs
    var inputs = form.querySelectorAll('input, select');
    inputs.forEach(function(input) {
        if (input.name && input.value) {
            params.append(input.name, input.value);
        }
    });
    params.set('page', page || 1);

    // Update URL without reload (for bookmarking)
    var newUrl = window.location.pathname + '?' + params.toString();
    history.replaceState(null, '', newUrl);

    // Show loading state
    var container = document.getElementById('qso-table-container');
    if (container) {
        container.style.opacity = '0.5';
    }

    // Fetch filtered QSOs
    fetch('/api/qsos?' + params.toString(), {
        credentials: 'same-origin'
    })
        .then(function(response) {
            if (!response.ok) {
                throw new Error('HTTP ' + response.status);
            }
            return response.json();
        })
        .then(function(data) {
            renderQsoTable(data.qsos, data.pagination);
            if (container) container.style.opacity = '1';
        })
        .catch(function(err) {
            console.error('Filter error:', err);
            if (container) {
                container.style.opacity = '1';
                container.innerHTML = '<div class="card" style="color: red;">Error loading QSOs. Please try refreshing the page.</div>';
            }
        });
}

function renderQsoTable(qsos, pagination) {
    var container = document.getElementById('qso-table-container');
    if (!container) return;

    if (qsos.length === 0) {
        container.innerHTML = '<div class="card"><p>No QSOs match the current filters.</p></div>';
        return;
    }

    var html = '<div class="table-responsive"><table><thead><tr>';
    html += '<th scope="col">Date/Time</th>';
    html += '<th scope="col">DX Call</th>';
    html += '<th scope="col" class="hide-mobile">Band</th>';
    html += '<th scope="col" class="hide-mobile">Mode</th>';
    html += '<th scope="col">Power</th>';
    html += '<th scope="col">QSO Race</th>';
    html += '<th scope="col">Cool Factor</th>';
    html += '<th scope="col">Confirmed</th>';
    html += '</tr></thead><tbody>';

    qsos.forEach(function(qso) {
        html += '<tr>';
        html += '<td>' + (qso.qso_datetime_formatted || qso.qso_datetime_utc || '-') + '</td>';
        html += '<td><span class="dx-callsign">';
        if (qso.country_flag) html += qso.country_flag + ' ';
        html += '<strong>' + qso.dx_callsign + '</strong></span>';
        if (qso.dx_sig_info || qso.my_sig_info) {
            html += ' <span class="pota-badge">üèïÔ∏è ' + (qso.dx_sig_info || qso.my_sig_info) + '</span>';
        }
        html += '</td>';
        html += '<td class="hide-mobile">' + (qso.band || '-') + '</td>';
        html += '<td class="hide-mobile">' + (qso.mode || '-') + '</td>';
        html += '<td>' + (qso.tx_power_w ? qso.tx_power_w + 'W' : '-') + '</td>';
        html += '<td>' + (qso.distance_formatted || '-') + '</td>';
        html += '<td>' + (qso.cool_factor ? qso.cool_factor.toFixed(1) : '-') + '</td>';
        html += '<td>' + (qso.is_confirmed ? 'Yes' : 'No') + '</td>';
        html += '</tr>';
    });

    html += '</tbody></table></div>';

    // Pagination
    if (pagination.total_pages > 1) {
        html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; flex-wrap: wrap; gap: 10px;">';
        html += '<span style="color: var(--text-secondary);">Showing ';
        html += ((pagination.page - 1) * pagination.per_page + 1) + '-';
        html += Math.min(pagination.page * pagination.per_page, pagination.total_items);
        html += ' of ' + pagination.total_items + ' QSOs</span>';
        html += '<div class="btn-group">';
        if (pagination.page > 1) {
            html += '<button onclick="filterQsos(' + (pagination.page - 1) + ')" class="btn btn-sm btn-secondary">&larr; Prev</button>';
        }
        html += '<span class="btn btn-sm" style="cursor: default;">Page ' + pagination.page + ' of ' + pagination.total_pages + '</span>';
        if (pagination.page < pagination.total_pages) {
            html += '<button onclick="filterQsos(' + (pagination.page + 1) + ')" class="btn btn-sm btn-secondary">Next &rarr;</button>';
        }
        html += '</div></div>';
    } else if (pagination.total_items > 0) {
        html += '<div style="margin-top: 15px; color: var(--text-secondary);">Showing ' + pagination.total_items + ' QSOs</div>';
    }

    container.innerHTML = html;
}
</script>

<div id="qso-table-container">
{% if qsos %}
<div class="table-responsive"><table>
    <thead>
        <tr>
            <th scope="col">Date/Time{% if competitor.time_display == 'local' and competitor.home_grid %} (Local){% else %} (UTC){% endif %}</th>
            <th scope="col">DX Call</th>
            <th scope="col" class="hide-mobile">Band</th>
            <th scope="col" class="hide-mobile">Mode</th>
            <th scope="col">Power</th>
            <th scope="col">QSO Race</th>
            <th scope="col">Cool Factor</th>
            <th scope="col">Confirmed</th>
        </tr>
    </thead>
    <tbody>
        {% for qso in qsos %}
        <tr{% if qso.has_disqualified %} class="qso-dq-row"{% endif %}>
            <td>{{ qso.qso_datetime_utc | format_time_local(qso.my_grid or competitor.home_grid, competitor.time_display or 'utc') }}</td>
            <td>
                <span class="dx-callsign" title="{{ qso.dx_country or '' }}">
                    {{ qso.dx_dxcc | country_flag }}
                    <strong>{{ qso.dx_callsign }}</strong>
                </span>
                {% if qso.dx_sig_info or qso.my_sig_info %}
                <span class="pota-badge">üèïÔ∏è {{ (qso.dx_sig_info or qso.my_sig_info) | pota_tooltip }}</span>
                {% endif %}
                {% if qso.disqualifications %}
                {% for dq in qso.disqualifications %}
                {% if dq.status == 'disqualified' %}
                <span class="badge badge-dq" title="Disqualified from {{ dq.sport_name }}" style="cursor: pointer;" onclick="viewQsoDqHistory({{ qso.id }})">DQ</span>
                {% elif dq.status == 'refuted' %}
                <span class="badge badge-refuted" title="Refuted in {{ dq.sport_name }}" style="cursor: pointer;" onclick="viewQsoDqHistory({{ qso.id }})">REFUTED</span>
                {% elif dq.status == 'requalified' %}
                <span class="badge badge-rq" title="Requalified in {{ dq.sport_name }}" style="cursor: pointer;" onclick="viewQsoDqHistory({{ qso.id }})">RQ</span>
                {% endif %}
                {% endfor %}
                {% endif %}
            </td>
            <td class="hide-mobile">{{ qso.band or '-' }}</td>
            <td class="hide-mobile">{{ qso.mode or '-' }}</td>
            <td>{% if qso.tx_power_w %}{{ qso.tx_power_w }}W{% else %}-{% endif %}</td>
            <td>{{ qso.distance_km | format_distance(competitor.distance_unit or 'km') if qso.distance_km else '-' }}</td>
            <td>{{ "%.1f" | format(qso.cool_factor) if qso.cool_factor else '-' }}</td>
            <td>
                {% if qso.is_confirmed %}Yes{% else %}No{% endif %}
                {% if is_own_profile and qso.has_disqualified %}
                <button class="btn btn-sm btn-warning" style="margin-left: 5px; padding: 2px 6px; font-size: 0.7em;" onclick="showRefuteModal({{ qso.id }}, '{{ qso.dx_callsign }}')" title="Refute disqualification">Refute</button>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table></div>

{% if pagination %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; flex-wrap: wrap; gap: 10px;">
    <span style="color: var(--text-secondary);">
        Showing {{ (pagination.page - 1) * pagination.per_page + 1 }}-{{ [pagination.page * pagination.per_page, pagination.total_items] | min }} of {{ pagination.total_items }} QSOs
    </span>
    {% if pagination.total_pages > 1 %}
    <div class="btn-group">
        {% if pagination.page > 1 %}
        <a href="?{% if request.query_params.get('band') %}band={{ request.query_params.get('band') }}&{% endif %}{% if request.query_params.get('mode') %}mode={{ request.query_params.get('mode') }}&{% endif %}{% if request.query_params.get('confirmed') %}confirmed={{ request.query_params.get('confirmed') }}&{% endif %}page={{ pagination.page - 1 }}" class="btn btn-sm btn-secondary">&larr; Prev</a>
        {% endif %}
        <span class="btn btn-sm" style="cursor: default;">Page {{ pagination.page }} of {{ pagination.total_pages }}</span>
        {% if pagination.page < pagination.total_pages %}
        <a href="?{% if request.query_params.get('band') %}band={{ request.query_params.get('band') }}&{% endif %}{% if request.query_params.get('mode') %}mode={{ request.query_params.get('mode') }}&{% endif %}{% if request.query_params.get('confirmed') %}confirmed={{ request.query_params.get('confirmed') }}&{% endif %}page={{ pagination.page + 1 }}" class="btn btn-sm btn-secondary">Next &rarr;</a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endif %}

{% else %}
<div class="card">
    {% if is_own_profile %}
    <p>No QSOs synced yet. Use the sync buttons above to import your contacts from QRZ or LoTW.</p>
    {% else %}
    <p>No QSOs recorded for this competitor.</p>
    {% endif %}
</div>
{% endif %}
</div><!-- end qso-table-container -->

<!-- DQ History Modal -->
<div id="qso-dq-history-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
        <h4 style="margin-top: 0;">Disqualification History</h4>
        <div id="qso-dq-history-content">Loading...</div>
        <div style="margin-top: 15px;">
            <button onclick="hideQsoDqHistoryModal()" class="btn btn-secondary">Close</button>
        </div>
    </div>
</div>

<!-- Refute Modal -->
<div id="refute-modal" class="modal-overlay">
    <div class="modal-content">
        <h4 style="margin-top: 0;">Refute Disqualification</h4>
        <p style="color: var(--text-secondary); font-size: 0.9em;">QSO with <strong id="refute-dx-call"></strong></p>
        <input type="hidden" id="refute-qso-id">
        <div id="refute-sports-list" style="margin-bottom: 15px;">Loading disqualifications...</div>
        <div class="form-group">
            <label for="refute-text">Refutation (required, min 10 characters)</label>
            <textarea id="refute-text" rows="3" placeholder="Explain why this QSO should not be disqualified..." style="width: 100%;"></textarea>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button onclick="submitRefute()" id="refute-submit-btn" class="btn btn-warning" style="flex: 1;">Submit Refutation</button>
            <button onclick="hideRefuteModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
        </div>
        <div id="refute-result" style="margin-top: 10px;"></div>
    </div>
</div>

<style>
.qso-dq-row {
    background: rgba(197, 48, 48, 0.1);
}
.badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.7em;
    font-weight: bold;
    margin-left: 5px;
    text-transform: uppercase;
}
.badge-dq {
    background: #c53030;
    color: white;
}
.badge-refuted {
    background: #d69e2e;
    color: white;
}
.badge-rq {
    background: #38a169;
    color: white;
}
.btn-warning {
    background: #d69e2e;
    color: white;
}
.btn-warning:hover {
    background: #b7791f;
}
.dq-comment {
    padding: 10px;
    margin: 8px 0;
    border-radius: 5px;
    background: var(--bg-secondary);
    border-left: 3px solid var(--border-color);
}
.dq-comment.disqualify { border-left-color: #c53030; }
.dq-comment.refute { border-left-color: #d69e2e; }
.dq-comment.requalify { border-left-color: #38a169; }
</style>

<script>
let currentRefuteSportId = null;

async function viewQsoDqHistory(qsoId) {
    document.getElementById('qso-dq-history-modal').classList.add('show');
    document.getElementById('qso-dq-history-content').innerHTML = '<p>Loading...</p>';

    try {
        const resp = await fetch('/qso/' + qsoId + '/disqualifications');
        const data = await resp.json();

        if (!resp.ok) {
            document.getElementById('qso-dq-history-content').innerHTML = '<p class="alert alert-error">' + (data.detail || 'Failed to load') + '</p>';
            return;
        }

        let html = '<p><strong>QSO:</strong> ' + data.competitor_callsign + ' &rarr; ' + data.dx_callsign + '</p>';
        html += '<p><strong>Date:</strong> ' + formatTimestamp(data.qso_datetime_utc) + '</p>';

        if (data.disqualifications.length === 0) {
            html += '<p style="color: var(--text-secondary);">No disqualification history.</p>';
        } else {
            for (const dq of data.disqualifications) {
                html += '<div style="margin-top: 15px; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px;">';
                html += '<p><strong>' + dq.sport_name + '</strong> - Status: <span class="badge badge-' + (dq.status === 'disqualified' ? 'dq' : dq.status === 'refuted' ? 'refuted' : 'rq') + '">' + dq.status.toUpperCase() + '</span></p>';
                for (const c of dq.comments) {
                    html += '<div class="dq-comment ' + c.comment_type + '">';
                    html += '<small style="color: var(--text-secondary);">' + formatTimestamp(c.created_at) + ' - <strong>' + c.author_callsign + '</strong> (' + c.comment_type + ')</small>';
                    html += '<p style="margin: 5px 0 0 0;">' + escapeHtml(c.comment) + '</p>';
                    html += '</div>';
                }
                html += '</div>';
            }
        }

        document.getElementById('qso-dq-history-content').innerHTML = html;
    } catch (e) {
        document.getElementById('qso-dq-history-content').innerHTML = '<p class="alert alert-error">Failed to load: ' + e.message + '</p>';
    }
}

function hideQsoDqHistoryModal() {
    document.getElementById('qso-dq-history-modal').classList.remove('show');
}

async function showRefuteModal(qsoId, dxCall) {
    document.getElementById('refute-qso-id').value = qsoId;
    document.getElementById('refute-dx-call').textContent = dxCall;
    document.getElementById('refute-text').value = '';
    document.getElementById('refute-result').innerHTML = '';
    document.getElementById('refute-sports-list').innerHTML = '<p>Loading disqualifications...</p>';
    document.getElementById('refute-modal').classList.add('show');

    // Load disqualifications to let user select which to refute
    try {
        const resp = await fetch('/qso/' + qsoId + '/disqualifications');
        const data = await resp.json();

        if (!resp.ok || data.disqualifications.length === 0) {
            document.getElementById('refute-sports-list').innerHTML = '<p class="alert alert-error">No active disqualifications found</p>';
            return;
        }

        // Show only disqualified (not already refuted or requalified)
        const disqualified = data.disqualifications.filter(d => d.status === 'disqualified');
        if (disqualified.length === 0) {
            document.getElementById('refute-sports-list').innerHTML = '<p>No active disqualifications to refute.</p>';
            return;
        }

        let html = '<p><strong>Select sport to refute:</strong></p>';
        for (const dq of disqualified) {
            html += '<label style="display: block; margin: 5px 0; cursor: pointer;">';
            html += '<input type="radio" name="refute-sport" value="' + dq.sport_id + '" style="margin-right: 8px;"';
            if (disqualified.length === 1) html += ' checked';
            html += '>' + dq.sport_name;
            html += '</label>';
        }
        document.getElementById('refute-sports-list').innerHTML = html;

        if (disqualified.length === 1) {
            currentRefuteSportId = disqualified[0].sport_id;
        }
    } catch (e) {
        document.getElementById('refute-sports-list').innerHTML = '<p class="alert alert-error">Failed to load: ' + e.message + '</p>';
    }

    document.getElementById('refute-text').focus();
}

function hideRefuteModal() {
    document.getElementById('refute-modal').classList.remove('show');
    currentRefuteSportId = null;
}

async function submitRefute() {
    const qsoId = document.getElementById('refute-qso-id').value;
    const refutation = document.getElementById('refute-text').value.trim();
    const result = document.getElementById('refute-result');
    const btn = document.getElementById('refute-submit-btn');

    // Get selected sport
    const selectedSport = document.querySelector('input[name="refute-sport"]:checked');
    if (!selectedSport) {
        result.innerHTML = '<div class="alert alert-error">Please select a sport to refute</div>';
        return;
    }
    const sportId = selectedSport.value;

    if (refutation.length < 10) {
        result.innerHTML = '<div class="alert alert-error">Refutation must be at least 10 characters</div>';
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Submitting...';

    try {
        const resp = await fetch('/qso/' + qsoId + '/sport/' + sportId + '/refute', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({refutation: refutation})
        });
        const data = await resp.json();
        if (resp.ok) {
            hideRefuteModal();
            showToast('Refutation submitted successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            result.innerHTML = '<div class="alert alert-error">' + (data.detail || 'Failed to submit refutation') + '</div>';
            btn.disabled = false;
            btn.textContent = 'Submit Refutation';
        }
    } catch (e) {
        result.innerHTML = '<div class="alert alert-error">Request failed: ' + e.message + '</div>';
        btn.disabled = false;
        btn.textContent = 'Submit Refutation';
    }
}

function formatTimestamp(isoString) {
    if (!isoString) return '';
    const date = new Date(isoString);
    return date.toLocaleString(undefined, {
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit'
    });
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Close modals on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hideQsoDqHistoryModal();
        hideRefuteModal();
    }
});
</script>
{% endblock %}
