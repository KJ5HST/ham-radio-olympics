{% extends "base.html" %}

{% block title %}{{ competitor.callsign }} - Ham Radio Olympics{% endblock %}

{% block nav_extra %}{% endblock %}

{% block content %}
{% if is_own_profile %}
<h2>Welcome, {{ competitor.callsign }}</h2>
{% else %}
<h2>{{ competitor.callsign }}</h2>
{% endif %}

<div class="stats">
    <div class="stat-box">
        <div class="value medal-gold">{{ medal_summary.gold }}</div>
        <div class="label">Gold Medals</div>
    </div>
    <div class="stat-box">
        <div class="value medal-silver">{{ medal_summary.silver }}</div>
        <div class="label">Silver Medals</div>
    </div>
    <div class="stat-box">
        <div class="value medal-bronze">{{ medal_summary.bronze }}</div>
        <div class="label">Bronze Medals</div>
    </div>
    <div class="stat-box">
        <div class="value">{{ medal_summary.total_points }}</div>
        <div class="label">Total Points</div>
    </div>
</div>

<div class="card">
    <h4>Account Status</h4>
    <p><strong>Registered:</strong> {{ competitor.registered_at | format_date if competitor.registered_at else '-' }}</p>
    {% if is_own_profile %}
    <p><strong>QRZ API Key:</strong> {% if user.has_qrz_key %}Stored{% else %}<span style="color: #718096;">Not stored</span>{% endif %}</p>
    <p><strong>LoTW Credentials:</strong> {% if user.has_lotw_creds %}Stored{% else %}<span style="color: #718096;">Not stored</span>{% endif %}</p>
    {% endif %}
    <p><strong>Last Sync:</strong> {{ competitor.last_sync_at | format_datetime if competitor.last_sync_at else 'Never' }}</p>
    {% if is_own_profile %}
    <div style="margin-top: 15px;">
        <strong>Sync QSOs:</strong>
        <div style="display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap;">
            {% if user.has_qrz_key %}
            <button onclick="syncQrzStored()" id="sync-qrz-btn" class="btn">Sync from QRZ</button>
            {% else %}
            <button onclick="showQrzModal()" id="sync-qrz-btn" class="btn">Sync from QRZ</button>
            {% endif %}
            {% if user.has_lotw_creds %}
            <button onclick="syncLotwStored()" id="sync-lotw-btn" class="btn" style="background: #805ad5;">Sync from LoTW</button>
            {% else %}
            <button onclick="showLotwModal()" id="sync-lotw-btn" class="btn" style="background: #805ad5;">Sync from LoTW</button>
            {% endif %}
        </div>
        <p style="margin-top: 10px; font-size: 0.9em; color: #718096;">
            <a href="/settings">Manage stored credentials</a>
        </p>
    </div>

    <!-- QRZ Modal -->
    <div id="qrz-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 25px; border-radius: 8px; max-width: 400px; width: 90%; margin: 20px;">
            <h4 style="margin-top: 0;">Sync from QRZ</h4>
            <p style="color: #718096; font-size: 0.9em;">Enter your QRZ API key to sync your QSOs.</p>
            <div class="form-group">
                <label for="qrz-api-key">QRZ API Key</label>
                <input type="text" id="qrz-api-key" placeholder="XXXX-XXXX-XXXX-XXXX">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button onclick="syncQrz()" id="qrz-submit-btn" class="btn" style="flex: 1;">Sync</button>
                <button onclick="hideQrzModal()" class="btn" style="flex: 1; background: #718096;">Cancel</button>
            </div>
            <div id="qrz-result" style="margin-top: 10px;"></div>
        </div>
    </div>

    <!-- LoTW Modal -->
    <div id="lotw-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 25px; border-radius: 8px; max-width: 400px; width: 90%; margin: 20px;">
            <h4 style="margin-top: 0;">Sync from LoTW</h4>
            <p style="color: #718096; font-size: 0.9em;">Enter your LoTW credentials to sync your QSOs.</p>
            <div class="form-group">
                <label for="lotw-username">LoTW Username</label>
                <input type="text" id="lotw-username" placeholder="Your callsign" value="{{ competitor.callsign }}">
            </div>
            <div class="form-group">
                <label for="lotw-password">LoTW Password</label>
                <input type="password" id="lotw-password" placeholder="Your LoTW password">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button onclick="syncLotw()" id="lotw-submit-btn" class="btn" style="flex: 1;">Sync</button>
                <button onclick="hideLotwModal()" class="btn" style="flex: 1; background: #718096;">Cancel</button>
            </div>
            <div id="lotw-result" style="margin-top: 10px;"></div>
        </div>
    </div>

    <script>
    // QRZ sync with stored credentials
    async function syncQrzStored() {
        const btn = document.getElementById('sync-qrz-btn');
        const originalText = btn.textContent;
        btn.textContent = 'Syncing...';
        btn.disabled = true;
        try {
            const resp = await fetch('/sync?callsign={{ competitor.callsign }}', {method: 'POST'});
            if (!resp.ok) {
                const data = await resp.json();
                showToast('Sync failed: ' + (data.detail || 'Unknown error'), 'error');
                btn.textContent = originalText;
                btn.disabled = false;
            } else {
                location.reload();
            }
        } catch (e) {
            btn.textContent = originalText;
            btn.disabled = false;
            showToast('Sync failed. Please try again.', 'error');
        }
    }

    // LoTW sync with stored credentials
    async function syncLotwStored() {
        const btn = document.getElementById('sync-lotw-btn');
        const originalText = btn.textContent;
        btn.textContent = 'Syncing...';
        btn.disabled = true;
        try {
            const resp = await fetch('/sync/lotw/stored', {method: 'POST'});
            if (!resp.ok) {
                const data = await resp.json();
                showToast('Sync failed: ' + (data.detail || 'Unknown error'), 'error');
                btn.textContent = originalText;
                btn.disabled = false;
            } else {
                location.reload();
            }
        } catch (e) {
            btn.textContent = originalText;
            btn.disabled = false;
            showToast('Sync failed. Please try again.', 'error');
        }
    }

    // QRZ modal functions
    function showQrzModal() {
        document.getElementById('qrz-modal').style.display = 'flex';
        document.getElementById('qrz-api-key').focus();
    }

    function hideQrzModal() {
        document.getElementById('qrz-modal').style.display = 'none';
        document.getElementById('qrz-api-key').value = '';
        document.getElementById('qrz-result').innerHTML = '';
    }

    async function syncQrz() {
        const btn = document.getElementById('qrz-submit-btn');
        const result = document.getElementById('qrz-result');
        const apiKey = document.getElementById('qrz-api-key').value;

        if (!apiKey) {
            result.innerHTML = '<div class="alert alert-error">Please enter your QRZ API key</div>';
            return;
        }

        btn.textContent = 'Syncing...';
        btn.disabled = true;
        result.innerHTML = '';

        try {
            const resp = await fetch('/sync/qrz', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({api_key: apiKey})
            });
            const data = await resp.json();
            if (resp.ok) {
                hideQrzModal();
                location.reload();
            } else {
                result.innerHTML = '<div class="alert alert-error">' + (data.detail || 'Sync failed') + '</div>';
                btn.textContent = 'Sync';
                btn.disabled = false;
            }
        } catch (e) {
            result.innerHTML = '<div class="alert alert-error">Sync failed: ' + e.message + '</div>';
            btn.textContent = 'Sync';
            btn.disabled = false;
        }
    }

    // LoTW modal functions
    function showLotwModal() {
        document.getElementById('lotw-modal').style.display = 'flex';
        document.getElementById('lotw-password').focus();
    }

    function hideLotwModal() {
        document.getElementById('lotw-modal').style.display = 'none';
        document.getElementById('lotw-password').value = '';
        document.getElementById('lotw-result').innerHTML = '';
    }

    async function syncLotw() {
        const btn = document.getElementById('lotw-submit-btn');
        const result = document.getElementById('lotw-result');
        const username = document.getElementById('lotw-username').value;
        const password = document.getElementById('lotw-password').value;

        if (!username || !password) {
            result.innerHTML = '<div class="alert alert-error">Please enter both username and password</div>';
            return;
        }

        btn.textContent = 'Syncing...';
        btn.disabled = true;
        result.innerHTML = '';

        try {
            const resp = await fetch('/sync/lotw', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: username, password: password})
            });
            const data = await resp.json();
            if (resp.ok) {
                hideLotwModal();
                location.reload();
            } else {
                result.innerHTML = '<div class="alert alert-error">' + (data.detail || 'Sync failed') + '</div>';
                btn.textContent = 'Sync';
                btn.disabled = false;
            }
        } catch (e) {
            result.innerHTML = '<div class="alert alert-error">Sync failed: ' + e.message + '</div>';
            btn.textContent = 'Sync';
            btn.disabled = false;
        }
    }

    // Close modals on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideQrzModal();
            hideLotwModal();
        }
    });
    </script>
    {% endif %}
</div>

{% if sport_entries %}
<h3>{% if is_own_profile %}My {% endif %}Sports</h3>
<div class="table-responsive"><table>
    <thead>
        <tr>
            <th scope="col">Sport</th>
            <th scope="col">Olympiad</th>
            <th scope="col">Medals</th>
            <th scope="col">Points</th>
        </tr>
    </thead>
    <tbody>
        {% for sport in sport_entries %}
        <tr>
            <td><a href="/olympiad/sport/{{ sport.id }}"><strong>{{ sport.name }}</strong></a></td>
            <td>{{ sport.olympiad_name }}</td>
            <td>
                {% if sport.gold_count %}<span class="medal-gold">{{ sport.gold_count }}G</span> {% endif %}
                {% if sport.silver_count %}<span class="medal-silver">{{ sport.silver_count }}S</span> {% endif %}
                {% if sport.bronze_count %}<span class="medal-bronze">{{ sport.bronze_count }}B</span> {% endif %}
                {% if not sport.gold_count and not sport.silver_count and not sport.bronze_count %}-{% endif %}
            </td>
            <td><strong>{{ sport.sport_points }}</strong></td>
        </tr>
        {% endfor %}
    </tbody>
</table></div>
{% endif %}

{% if personal_bests %}
<h3>Personal Bests</h3>
<div class="table-responsive"><table>
    <thead>
        <tr>
            <th scope="col">Record Type</th>
            <th scope="col">Value</th>
            <th scope="col">Date</th>
        </tr>
    </thead>
    <tbody>
        {% for record in personal_bests %}
        <tr>
            <td>{{ record.record_type | replace('_', ' ') | title }}</td>
            <td>
                {% if 'distance' in record.record_type %}
                    {{ "%.1f" | format(record.value) }} km
                {% elif 'cool_factor' in record.record_type %}
                    {{ "%.1f" | format(record.value) }} km/W
                {% elif 'power' in record.record_type %}
                    {{ "%.1f" | format(record.value) }} W
                {% else %}
                    {{ record.value }}
                {% endif %}
            </td>
            <td>{{ record.achieved_at | format_date if record.achieved_at else '-' }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table></div>
{% endif %}

{% if medals %}
<h3>{% if is_own_profile %}Recent {% endif %}Medals</h3>
<div class="table-responsive"><table>
    <thead>
        <tr>
            <th scope="col">Sport</th>
            <th scope="col">Target</th>
            <th scope="col">QSO Race</th>
            <th scope="col">Cool Factor</th>
            <th scope="col">Points</th>
        </tr>
    </thead>
    <tbody>
        {% for medal in medals[:10] %}
        <tr>
            <td>{{ medal.sport_name }}</td>
            <td>{{ medal.target_display }}</td>
            <td>
                {% if medal.qso_race_medal %}
                    <span class="medal-{{ medal.qso_race_medal }}">{{ medal.qso_race_medal | upper }}</span>
                {% else %}
                    -
                {% endif %}
            </td>
            <td>
                {% if medal.cool_factor_medal %}
                    <span class="medal-{{ medal.cool_factor_medal }}">{{ medal.cool_factor_medal | upper }}</span>
                    ({{ "%.1f" | format(medal.cool_factor_value) if medal.cool_factor_value else '-' }})
                {% else %}
                    -
                {% endif %}
            </td>
            <td>{{ medal.total_points }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table></div>
{% endif %}

{% if qsos %}
<h3>Recent QSOs</h3>
<div class="table-responsive"><table>
    <thead>
        <tr>
            <th scope="col">Date/Time (UTC)</th>
            <th scope="col">DX Call</th>
            <th scope="col">Band</th>
            <th scope="col">Mode</th>
            <th scope="col">Power</th>
            <th scope="col">QSO Race</th>
            <th scope="col">Cool Factor</th>
            <th scope="col">Confirmed</th>
        </tr>
    </thead>
    <tbody>
        {% for qso in qsos %}
        <tr>
            <td>{{ qso.qso_datetime_utc | format_datetime }}</td>
            <td><strong>{{ qso.dx_callsign }}</strong></td>
            <td>{{ qso.band or '-' }}</td>
            <td>{{ qso.mode or '-' }}</td>
            <td>{{ qso.tx_power_w }}W</td>
            <td>{{ "%.0f" | format(qso.distance_km) if qso.distance_km else '-' }} km</td>
            <td>{{ "%.1f" | format(qso.cool_factor) if qso.cool_factor else '-' }}</td>
            <td>{% if qso.is_confirmed %}Yes{% else %}No{% endif %}</td>
        </tr>
        {% endfor %}
    </tbody>
</table></div>
{% else %}
<div class="card">
    {% if is_own_profile %}
    <p>No QSOs synced yet. Use the sync buttons above to import your contacts from QRZ or LoTW.</p>
    {% else %}
    <p>No QSOs recorded for this competitor.</p>
    {% endif %}
</div>
{% endif %}
{% endblock %}
