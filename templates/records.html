{% extends "base.html" %}

{% block title %}World Records - Ham Radio Olympics{% endblock %}

{% block content %}
<h2>World Records</h2>

{% if triathlon_leaders %}
<h3>Triathlon Podium</h3>
<p style="color: var(--text-secondary); margin-bottom: 1rem;">Top QSOs excelling across all three events: Distance + Cool Factor + POTA <a href="/static/user_guide.html#64-triathlon-podium" title="Learn more about Triathlon Podium">‚ìò</a></p>
<div class="table-responsive"><table>
    <thead>
        <tr>
            <th scope="col" style="width: 30px;"></th>
            <th scope="col" style="width: 50px;">Rank</th>
            <th scope="col">Score</th>
            <th scope="col">Operator</th>
            <th scope="col">QSO Details</th>
        </tr>
    </thead>
    <tbody>
        {% for leader in triathlon_leaders %}
        <tr class="record-row">
            <td style="cursor: pointer; text-align: center;" onclick="toggleRecord('tri-{{ loop.index }}')">
                <span class="expand-icon" id="icon-tri-{{ loop.index }}">‚ñ∂</span>
            </td>
            <td style="text-align: center;">
                {% if loop.index == 1 %}ü•á{% elif loop.index == 2 %}ü•à{% elif loop.index == 3 %}ü•â{% else %}{{ loop.index }}{% endif %}
            </td>
            <td><strong>{{ "%.1f" | format(leader.total_score) }}</strong> / 300</td>
            <td>
                <a href="/competitor/{{ leader.callsign }}">{{ leader.first_name | competitor_display(leader.callsign) }}</a>
            </td>
            <td>
                {{ leader.dx_callsign }} via {{ leader.mode or 'unknown' }}
                {% if leader.my_sig_info and leader.dx_sig_info %}
                    <span title="Park-to-Park: {{ leader.my_sig_info }} ‚Üî {{ leader.dx_sig_info }}">üèïÔ∏è‚ÜîüèïÔ∏è</span>
                {% elif leader.my_sig_info %}
                    <span title="Activated from {{ leader.my_sig_info }}">üì°</span>
                {% elif leader.dx_sig_info %}
                    <span title="Hunted {{ leader.dx_sig_info }}">üèïÔ∏è</span>
                {% endif %}
            </td>
        </tr>
        <tr class="details-row" id="details-tri-{{ loop.index }}" style="display: none;">
            <td colspan="5" style="padding: 0; background: var(--bg-primary);">
                <div style="padding: 10px 15px 10px 40px;">
                    <table style="margin: 0; font-size: 0.85em;">
                        <tr>
                            <th style="padding: 4px 12px 4px 0; color: var(--text-secondary);">Distance:</th>
                            <td>{{ leader.distance_km | format_distance(display_prefs.distance_unit or 'km') }} <span style="color: var(--text-secondary);">({{ "%.1f" | format(leader.distance_percentile) }}%)</span></td>
                        </tr>
                        <tr>
                            <th style="padding: 4px 12px 4px 0; color: var(--text-secondary);">Cool Factor:</th>
                            <td>{% if display_prefs.distance_unit == 'mi' %}{{ "%.1f" | format(leader.cool_factor * 0.621371) }} mi/W{% else %}{{ "%.1f" | format(leader.cool_factor) }} km/W{% endif %} <span style="color: var(--text-secondary);">({{ "%.1f" | format(leader.cool_factor_percentile) }}%)</span></td>
                        </tr>
                        <tr>
                            <th style="padding: 4px 12px 4px 0; color: var(--text-secondary);">Power:</th>
                            <td>{{ leader.tx_power_w }}W</td>
                        </tr>
                        <tr>
                            <th style="padding: 4px 12px 4px 0; color: var(--text-secondary);">POTA Bonus:</th>
                            <td>
                                {% if leader.pota_bonus == 100 %}
                                    +100 (Park-to-Park: {{ leader.my_sig_info }} ‚Üî {{ leader.dx_sig_info }})
                                {% else %}
                                    +50 ({% if leader.my_sig_info %}Activated {{ leader.my_sig_info }}{% else %}Hunted {{ leader.dx_sig_info }}{% endif %})
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th style="padding: 4px 12px 4px 0; color: var(--text-secondary);">Date:</th>
                            <td>{{ leader.qso_datetime | format_datetime(display_prefs.home_grid, display_prefs.time_display) }}</td>
                        </tr>
                        <tr style="border-top: 1px solid var(--border-color);">
                            <th style="padding: 8px 12px 4px 0; color: var(--text-primary);"><strong>Total Score:</strong></th>
                            <td style="padding-top: 8px;"><strong>{{ "%.1f" | format(leader.distance_percentile) }} + {{ "%.1f" | format(leader.cool_factor_percentile) }} + {{ leader.pota_bonus }} = {{ "%.1f" | format(leader.total_score) }}</strong></td>
                        </tr>
                    </table>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table></div>
{% endif %}

{% if world_records %}
<h3>Overall Records</h3>
<div class="table-responsive"><table>
    <thead>
        <tr>
            <th scope="col" style="width: 30px;"></th>
            <th scope="col">Record Type</th>
            <th scope="col">Value</th>
            <th scope="col">Holder</th>
            <th scope="col">Match</th>
        </tr>
    </thead>
    <tbody>
        {% for record in world_records %}
        <tr class="record-row">
            <td style="cursor: pointer; text-align: center;" onclick="toggleRecord('world-{{ loop.index }}')">
                <span class="expand-icon" id="icon-world-{{ loop.index }}">‚ñ∂</span>
            </td>
            <td><strong>{{ record.record_type | replace('_', ' ') | title }}</strong></td>
            <td>
                {% if 'distance' in record.record_type %}
                    {{ record.value | format_distance(display_prefs.distance_unit or 'km') }}
                {% elif 'cool_factor' in record.record_type %}
                    {% if display_prefs.distance_unit == 'mi' %}
                        {{ "%.1f" | format(record.value * 0.621371) }} mi/W
                    {% else %}
                        {{ "%.1f" | format(record.value) }} km/W
                    {% endif %}
                {% elif 'power' in record.record_type %}
                    {{ "%.1f" | format(record.value) }} W
                {% else %}
                    {{ record.value }}
                {% endif %}
            </td>
            <td>
                {% if record.holder %}
                    <a href="/competitor/{{ record.holder }}">{{ record.holder_first_name | competitor_display(record.holder) }}</a>
                {% else %}
                    -
                {% endif %}
            </td>
            <td>
                {% if record.match_id %}
                    <a href="/olympiad/sport/{{ record.linked_sport_id }}/match/{{ record.match_id }}">{{ record.sport_name }}: {{ record.target_value | pota_tooltip }}</a>
                {% else %}
                    -
                {% endif %}
            </td>
        </tr>
        <tr class="details-row" id="details-world-{{ loop.index }}" style="display: none;">
            <td colspan="5" style="padding: 0; background: var(--bg-primary);">
                <div style="padding: 10px 15px 10px 40px;">
                    <table style="margin: 0; font-size: 0.85em;">
                        <tr><th style="padding: 4px 12px 4px 0; color: var(--text-secondary);">QSO With:</th><td><strong>{% if record.dx_callsign %}<a href="https://www.qrz.com/db/{{ record.dx_callsign }}" target="_blank" rel="noopener">{{ record.dx_callsign }}</a>{% else %}-{% endif %}</strong></td></tr>
                        <tr><th style="padding: 4px 12px 4px 0; color: var(--text-secondary);">Mode:</th><td>{{ record.mode or '-' }}{% if record.my_sig_info %} <span title="Activated from {{ record.my_sig_info }}">üì°</span>{% endif %}</td></tr>
                        <tr><th style="padding: 4px 12px 4px 0; color: var(--text-secondary);">Power:</th><td>{% if record.tx_power_w %}{{ record.tx_power_w }}W{% else %}-{% endif %}</td></tr>
                        <tr><th style="padding: 4px 12px 4px 0; color: var(--text-secondary);">Distance:</th><td>{% if record.distance_km %}{{ record.distance_km | format_distance(display_prefs.distance_unit or 'km') }}{% else %}-{% endif %}</td></tr>
                        <tr><th style="padding: 4px 12px 4px 0; color: var(--text-secondary);">Cool Factor:</th><td>{% if record.cool_factor %}{% if display_prefs.distance_unit == 'mi' %}{{ "%.1f" | format(record.cool_factor * 0.621371) }} mi/W{% else %}{{ "%.1f" | format(record.cool_factor) }} km/W{% endif %}{% else %}-{% endif %}</td></tr>
                        <tr><th style="padding: 4px 12px 4px 0; color: var(--text-secondary);">Date:</th><td>{{ record.qso_datetime_utc | format_datetime(display_prefs.home_grid, display_prefs.time_display) if record.qso_datetime_utc else (record.achieved_at | format_datetime(display_prefs.home_grid, display_prefs.time_display) if record.achieved_at else '-') }}</td></tr>
                    </table>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table></div>

{% if honorable_mentions.longest_distance or honorable_mentions.highest_cool_factor %}
<div class="honorable-mentions" style="margin-top: 0.5rem; padding: 0.75rem 1rem; background: var(--bg-secondary); border-radius: 4px; font-size: 0.85em;">
    <p style="margin: 0 0 0.25rem 0; color: var(--text-secondary); font-style: italic;"><strong>Honorable Mention</strong> ‚Äî Best outside competition:</p>
    {% if honorable_mentions.longest_distance %}
    <p style="margin: 0.25rem 0; color: var(--text-secondary);">
        <strong>Longest Distance:</strong>
        {{ honorable_mentions.longest_distance.value | format_distance(display_prefs.distance_unit or 'km') }}
        by <a href="/competitor/{{ honorable_mentions.longest_distance.callsign }}">{{ honorable_mentions.longest_distance.first_name | competitor_display(honorable_mentions.longest_distance.callsign) }}</a>
        ({{ honorable_mentions.longest_distance.date | format_date }})
    </p>
    {% endif %}
    {% if honorable_mentions.highest_cool_factor %}
    <p style="margin: 0.25rem 0; color: var(--text-secondary);">
        <strong>Highest Cool Factor:</strong>
        {% if display_prefs.distance_unit == 'mi' %}{{ "%.1f" | format(honorable_mentions.highest_cool_factor.value * 0.621371) }} mi/W{% else %}{{ "%.1f" | format(honorable_mentions.highest_cool_factor.value) }} km/W{% endif %}
        by <a href="/competitor/{{ honorable_mentions.highest_cool_factor.callsign }}">{{ honorable_mentions.highest_cool_factor.first_name | competitor_display(honorable_mentions.highest_cool_factor.callsign) }}</a>
        ({{ honorable_mentions.highest_cool_factor.date | format_date }})
    </p>
    {% endif %}
</div>
{% endif %}

{% else %}
<div class="card">
    <p>No world records have been set yet. Be the first to set a record!</p>
</div>
{% endif %}

{% if distance_records %}
<h3>Distance Records by Mode</h3>
<div class="table-responsive"><table>
    <thead>
        <tr>
            <th scope="col" style="width: 30px;"></th>
            <th scope="col">Mode</th>
            <th scope="col">Distance</th>
            <th scope="col">Holder</th>
            <th scope="col">Match</th>
        </tr>
    </thead>
    <tbody>
        {% for record in distance_records %}
        <tr class="record-row">
            <td style="cursor: pointer; text-align: center;" onclick="toggleRecord('dist-{{ loop.index }}')">
                <span class="expand-icon" id="icon-dist-{{ loop.index }}">‚ñ∂</span>
            </td>
            <td><strong>{{ record.mode }}</strong></td>
            <td>{{ record.value | format_distance(display_prefs.distance_unit or 'km') }}</td>
            <td>
                <a href="/competitor/{{ record.holder }}">{{ record.holder_name | competitor_display(record.holder) }}</a>
            </td>
            <td>
                <a href="/olympiad/sport/{{ record.sport_id }}/match/{{ record.match_id }}">{{ record.sport_name }}: {{ record.target | pota_tooltip }}</a>
            </td>
        </tr>
        <tr class="details-row" id="details-dist-{{ loop.index }}" style="display: none;">
            <td colspan="5" style="padding: 0; background: var(--bg-primary);">
                <div style="padding: 10px 15px 10px 40px;">
                    <table style="margin: 0; font-size: 0.85em;">
                        <tr><th style="padding: 4px 12px 4px 0; color: var(--text-secondary);">QSO With:</th><td><strong>{% if record.dx_callsign %}<a href="https://www.qrz.com/db/{{ record.dx_callsign }}" target="_blank" rel="noopener">{{ record.dx_callsign }}</a>{% else %}-{% endif %}</strong></td></tr>
                        <tr><th style="padding: 4px 12px 4px 0; color: var(--text-secondary);">Power:</th><td>{% if record.power %}{{ record.power }}W{% else %}-{% endif %}{% if record.my_sig_info %} <span title="Activated from {{ record.my_sig_info }}">üì°</span>{% endif %}</td></tr>
                        <tr><th style="padding: 4px 12px 4px 0; color: var(--text-secondary);">Cool Factor:</th><td>{% if record.cool_factor %}{% if display_prefs.distance_unit == 'mi' %}{{ "%.1f" | format(record.cool_factor * 0.621371) }} mi/W{% else %}{{ "%.1f" | format(record.cool_factor) }} km/W{% endif %}{% else %}-{% endif %}</td></tr>
                        <tr><th style="padding: 4px 12px 4px 0; color: var(--text-secondary);">Date:</th><td>{{ record.date | format_datetime(display_prefs.home_grid, display_prefs.time_display) if record.date else '-' }}</td></tr>
                    </table>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table></div>
{% endif %}

{% if cool_factor_records %}
<h3>Cool Factor Records by Mode</h3>
<div class="table-responsive"><table>
    <thead>
        <tr>
            <th scope="col" style="width: 30px;"></th>
            <th scope="col">Mode</th>
            <th scope="col">Cool Factor</th>
            <th scope="col">Holder</th>
            <th scope="col">Match</th>
        </tr>
    </thead>
    <tbody>
        {% for record in cool_factor_records %}
        <tr class="record-row">
            <td style="cursor: pointer; text-align: center;" onclick="toggleRecord('cf-{{ loop.index }}')">
                <span class="expand-icon" id="icon-cf-{{ loop.index }}">‚ñ∂</span>
            </td>
            <td><strong>{{ record.mode }}</strong></td>
            <td>{% if display_prefs.distance_unit == 'mi' %}{{ "%.1f" | format(record.value * 0.621371) }} mi/W{% else %}{{ "%.1f" | format(record.value) }} km/W{% endif %}</td>
            <td>
                <a href="/competitor/{{ record.holder }}">{{ record.holder_name | competitor_display(record.holder) }}</a>
            </td>
            <td>
                <a href="/olympiad/sport/{{ record.sport_id }}/match/{{ record.match_id }}">{{ record.sport_name }}: {{ record.target | pota_tooltip }}</a>
            </td>
        </tr>
        <tr class="details-row" id="details-cf-{{ loop.index }}" style="display: none;">
            <td colspan="5" style="padding: 0; background: var(--bg-primary);">
                <div style="padding: 10px 15px 10px 40px;">
                    <table style="margin: 0; font-size: 0.85em;">
                        <tr><th style="padding: 4px 12px 4px 0; color: var(--text-secondary);">QSO With:</th><td><strong>{% if record.dx_callsign %}<a href="https://www.qrz.com/db/{{ record.dx_callsign }}" target="_blank" rel="noopener">{{ record.dx_callsign }}</a>{% else %}-{% endif %}</strong></td></tr>
                        <tr><th style="padding: 4px 12px 4px 0; color: var(--text-secondary);">Power:</th><td>{% if record.power %}{{ record.power }}W{% else %}-{% endif %}{% if record.my_sig_info %} <span title="Activated from {{ record.my_sig_info }}">üì°</span>{% endif %}</td></tr>
                        <tr><th style="padding: 4px 12px 4px 0; color: var(--text-secondary);">Distance:</th><td>{% if record.distance %}{{ record.distance | format_distance(display_prefs.distance_unit or 'km') }}{% else %}-{% endif %}</td></tr>
                        <tr><th style="padding: 4px 12px 4px 0; color: var(--text-secondary);">Date:</th><td>{{ record.date | format_datetime(display_prefs.home_grid, display_prefs.time_display) if record.date else '-' }}</td></tr>
                    </table>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table></div>
{% endif %}

<script>
function toggleRecord(id) {
    const detailsRow = document.getElementById('details-' + id);
    const icon = document.getElementById('icon-' + id);
    if (!detailsRow || !icon) return;

    if (detailsRow.style.display === 'none') {
        detailsRow.style.display = 'table-row';
        icon.textContent = '‚ñº';
    } else {
        detailsRow.style.display = 'none';
        icon.textContent = '‚ñ∂';
    }
}
</script>

<style>
.expand-icon {
    font-size: 0.8em;
    color: var(--text-secondary);
    transition: transform 0.2s;
}
.record-row:hover .expand-icon {
    color: var(--text-primary);
}
.details-row table {
    border-collapse: collapse;
}
</style>

<h3>About Records</h3>
<div class="card">
    <p><strong>Distance Records:</strong> Longest confirmed QSO distance{% if display_prefs.distance_unit == 'mi' %} in miles{% else %} in kilometers{% endif %}.</p>
    <p><strong>Cool Factor Records:</strong> Best distance-to-power ratio ({% if display_prefs.distance_unit == 'mi' %}mi/W{% else %}km/W{% endif %}) - rewards efficient, low-power contacts.</p>
    <p><strong>Triathlon Podium:</strong> Top QSOs combining all three events - Distance percentile + Cool Factor percentile + POTA bonus (P2P=100, single park=50). Max score: 300.</p>
</div>
{% endblock %}
