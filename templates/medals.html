{% extends "base.html" %}

{% block title %}Medal Standings - Ham Radio Olympics{% endblock %}

{% block content %}
<h2>Medal Standings</h2>

{% if medal_standings %}
<div class="table-responsive"><table>
    <thead>
        <tr>
            <th scope="col" style="width: 30px;"></th>
            <th scope="col">Rank</th>
            <th scope="col">Competitor</th>
            <th scope="col"><span class="medal-emoji gold"></span></th>
            <th scope="col"><span class="medal-emoji silver"></span></th>
            <th scope="col"><span class="medal-emoji bronze"></span></th>
            <th scope="col">Total</th>
            <th scope="col">Points</th>
        </tr>
    </thead>
    <tbody>
        {% for competitor in medal_standings %}
        <tr class="standings-row" data-callsign="{{ competitor.callsign }}">
            <td style="cursor: pointer; text-align: center;" onclick="toggleDetails('{{ competitor.callsign }}')">
                {% if medal_details.get(competitor.callsign) %}
                <span class="expand-icon" id="icon-{{ competitor.callsign }}">â–¶</span>
                {% endif %}
            </td>
            <td>{{ loop.index }}</td>
            <td><a href="/competitor/{{ competitor.callsign }}">{{ competitor.first_name | competitor_display(competitor.callsign) }}</a></td>
            <td>{{ competitor.gold_count }}</td>
            <td>{{ competitor.silver_count }}</td>
            <td>{{ competitor.bronze_count }}</td>
            <td><strong>{{ competitor.total_medals }}</strong></td>
            <td>{{ competitor.total_points }}</td>
        </tr>
        {% if medal_details.get(competitor.callsign) %}
        <tr class="details-row" id="details-{{ competitor.callsign }}" style="display: none;">
            <td colspan="8" style="padding: 0; background: var(--bg-primary);">
                <div style="padding: 10px 15px 10px 40px;">
                    <table style="margin: 0; font-size: 0.85em; width: 100%;">
                        <thead>
                            <tr>
                                <th style="padding: 4px 8px;">Match</th>
                                <th style="padding: 4px 8px;">Medal</th>
                                <th style="padding: 4px 8px;">DX Call</th>
                                <th style="padding: 4px 8px;" class="hide-mobile">Time{% if display_prefs.time_display == 'local' and display_prefs.home_grid %} (Local){% else %} (UTC){% endif %}</th>
                                <th style="padding: 4px 8px;" class="hide-mobile">Mode</th>
                                <th style="padding: 4px 8px;" class="hide-mobile">Power</th>
                                <th style="padding: 4px 8px;">Distance</th>
                                <th style="padding: 4px 8px;">CF</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for detail in medal_details[competitor.callsign] %}
                            {% for qso in detail.qsos %}
                            <tr>
                                <td style="padding: 4px 8px;"><a href="/olympiad/sport/{{ detail.sport_id }}/match/{{ detail.match_id }}">{{ detail.sport_name }}: {{ detail.target | pota_tooltip }}</a></td>
                                <td style="padding: 4px 8px;">
                                    {% if qso.medal_type == 'QSO Race' %}
                                        {% if detail.qso_medal == 'gold' %}ðŸ¥‡{% elif detail.qso_medal == 'silver' %}ðŸ¥ˆ{% elif detail.qso_medal == 'bronze' %}ðŸ¥‰{% endif %} Race
                                    {% else %}
                                        {% if detail.cf_medal == 'gold' %}ðŸ¥‡{% elif detail.cf_medal == 'silver' %}ðŸ¥ˆ{% elif detail.cf_medal == 'bronze' %}ðŸ¥‰{% endif %} CF
                                    {% endif %}
                                </td>
                                <td style="padding: 4px 8px;"><strong>{{ qso.dx_callsign }}</strong></td>
                                <td style="padding: 4px 8px;" class="hide-mobile">{{ qso.time | format_datetime(qso.my_grid or display_prefs.home_grid, display_prefs.time_display) }}{% if qso.my_park %} <span title="Activated from {{ qso.my_park }}">ðŸ“¡</span>{% endif %}</td>
                                <td style="padding: 4px 8px;" class="hide-mobile">{{ qso.mode or '-' }}</td>
                                <td style="padding: 4px 8px;" class="hide-mobile">{% if qso.power %}{{ qso.power }}W{% else %}-{% endif %}</td>
                                <td style="padding: 4px 8px;">{% if qso.distance %}{{ qso.distance | format_distance(display_prefs.distance_unit or 'km') }}{% else %}-{% endif %}</td>
                                <td style="padding: 4px 8px;">{% if qso.cool_factor %}{% if display_prefs.distance_unit == 'mi' %}{{ "%.1f" | format(qso.cool_factor * 0.621371) }}{% else %}{{ "%.1f" | format(qso.cool_factor) }}{% endif %}{% else %}-{% endif %}</td>
                            </tr>
                            {% endfor %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </td>
        </tr>
        {% endif %}
        {% endfor %}
    </tbody>
</table></div>

<script>
function toggleDetails(callsign) {
    const detailsRow = document.getElementById('details-' + callsign);
    const icon = document.getElementById('icon-' + callsign);
    if (!detailsRow || !icon) return;

    if (detailsRow.style.display === 'none') {
        detailsRow.style.display = 'table-row';
        icon.textContent = 'â–¼';
    } else {
        detailsRow.style.display = 'none';
        icon.textContent = 'â–¶';
    }
}
</script>

<style>
.expand-icon {
    font-size: 0.8em;
    color: var(--text-secondary);
    transition: transform 0.2s;
}
.standings-row:hover .expand-icon {
    color: var(--text-primary);
}
.details-row table {
    border-collapse: collapse;
}
.details-row th {
    font-weight: 600;
    color: var(--text-secondary);
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}
.details-row td {
    border-bottom: 1px solid var(--border-color);
}
</style>
{% else %}
<div class="card">
    <p>No medals have been awarded yet. Compete in matches to earn medals!</p>
</div>
{% endif %}

{% if sport_standings %}
<h2 style="margin-top: 30px;">Standings by Sport</h2>

{% for sport_id, sport in sport_standings.items() %}
<h3 style="margin-top: 20px; cursor: pointer;" onclick="toggleSport('sport-{{ sport_id }}')">
    <span class="expand-icon" id="icon-sport-{{ sport_id }}">â–¶</span>
    <a href="/olympiad/sport/{{ sport_id }}" onclick="event.stopPropagation();">{{ sport.name }}</a>
</h3>
<div class="table-responsive sport-table" id="sport-{{ sport_id }}" style="display: none;"><table>
    <thead>
        <tr>
            <th scope="col" style="width: 30px;"></th>
            <th scope="col">Rank</th>
            <th scope="col">Competitor</th>
            <th scope="col">ðŸ¥‡</th>
            <th scope="col">ðŸ¥ˆ</th>
            <th scope="col">ðŸ¥‰</th>
            <th scope="col">Points</th>
        </tr>
    </thead>
    <tbody>
        {% for competitor in sport.competitors %}
        {% set sport_details = medal_details.get(competitor.callsign, []) | selectattr('sport_id', 'equalto', sport_id) | list %}
        <tr class="standings-row">
            <td style="cursor: pointer; text-align: center;" onclick="toggleSportDetails('sport-{{ sport_id }}-{{ competitor.callsign }}')">
                {% if sport_details %}
                <span class="expand-icon" id="icon-sport-{{ sport_id }}-{{ competitor.callsign }}">â–¶</span>
                {% endif %}
            </td>
            <td>{{ loop.index }}</td>
            <td><a href="/competitor/{{ competitor.callsign }}">{{ competitor.first_name | competitor_display(competitor.callsign) }}</a>{% if competitor.role and competitor.role != 'combined' %} <span style="color: var(--text-secondary); font-size: 0.85em;">({{ competitor.role }})</span>{% endif %}</td>
            <td>{{ competitor.gold_count or '-' }}</td>
            <td>{{ competitor.silver_count or '-' }}</td>
            <td>{{ competitor.bronze_count or '-' }}</td>
            <td><strong>{{ competitor.total_points }}</strong></td>
        </tr>
        {% if sport_details %}
        <tr class="details-row" id="sport-{{ sport_id }}-{{ competitor.callsign }}" style="display: none;">
            <td colspan="7" style="padding: 0; background: var(--bg-primary);">
                <div style="padding: 10px 15px 10px 40px;">
                    <table style="margin: 0; font-size: 0.85em; width: 100%;">
                        <thead>
                            <tr>
                                <th style="padding: 4px 8px;">Match</th>
                                <th style="padding: 4px 8px;">Medal</th>
                                <th style="padding: 4px 8px;">DX Call</th>
                                <th style="padding: 4px 8px;" class="hide-mobile">Time{% if display_prefs.time_display == 'local' and display_prefs.home_grid %} (Local){% else %} (UTC){% endif %}</th>
                                <th style="padding: 4px 8px;" class="hide-mobile">Mode</th>
                                <th style="padding: 4px 8px;" class="hide-mobile">Power</th>
                                <th style="padding: 4px 8px;">Distance</th>
                                <th style="padding: 4px 8px;">CF</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for detail in sport_details %}
                            {% for qso in detail.qsos %}
                            <tr>
                                <td style="padding: 4px 8px;"><a href="/olympiad/sport/{{ detail.sport_id }}/match/{{ detail.match_id }}">{{ detail.target | pota_tooltip }}</a></td>
                                <td style="padding: 4px 8px;">
                                    {% if qso.medal_type == 'QSO Race' %}
                                        {% if detail.qso_medal == 'gold' %}ðŸ¥‡{% elif detail.qso_medal == 'silver' %}ðŸ¥ˆ{% elif detail.qso_medal == 'bronze' %}ðŸ¥‰{% endif %} Race
                                    {% else %}
                                        {% if detail.cf_medal == 'gold' %}ðŸ¥‡{% elif detail.cf_medal == 'silver' %}ðŸ¥ˆ{% elif detail.cf_medal == 'bronze' %}ðŸ¥‰{% endif %} CF
                                    {% endif %}
                                </td>
                                <td style="padding: 4px 8px;"><strong>{{ qso.dx_callsign }}</strong></td>
                                <td style="padding: 4px 8px;" class="hide-mobile">{{ qso.time | format_datetime(qso.my_grid or display_prefs.home_grid, display_prefs.time_display) }}{% if qso.my_park %} <span title="Activated from {{ qso.my_park }}">ðŸ“¡</span>{% endif %}</td>
                                <td style="padding: 4px 8px;" class="hide-mobile">{{ qso.mode or '-' }}</td>
                                <td style="padding: 4px 8px;" class="hide-mobile">{% if qso.power %}{{ qso.power }}W{% else %}-{% endif %}</td>
                                <td style="padding: 4px 8px;">{% if qso.distance %}{{ qso.distance | format_distance(display_prefs.distance_unit or 'km') }}{% else %}-{% endif %}</td>
                                <td style="padding: 4px 8px;">{% if qso.cool_factor %}{% if display_prefs.distance_unit == 'mi' %}{{ "%.1f" | format(qso.cool_factor * 0.621371) }}{% else %}{{ "%.1f" | format(qso.cool_factor) }}{% endif %}{% else %}-{% endif %}</td>
                            </tr>
                            {% endfor %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </td>
        </tr>
        {% endif %}
        {% endfor %}
    </tbody>
</table></div>
{% endfor %}

<script>
function toggleSport(sportId) {
    const table = document.getElementById(sportId);
    const icon = document.getElementById('icon-' + sportId);
    if (!table || !icon) return;

    if (table.style.display === 'none') {
        table.style.display = 'block';
        icon.textContent = 'â–¼';
    } else {
        table.style.display = 'none';
        icon.textContent = 'â–¶';
    }
}

function toggleSportDetails(detailsId) {
    const detailsRow = document.getElementById(detailsId);
    const icon = document.getElementById('icon-' + detailsId);
    if (!detailsRow || !icon) return;

    if (detailsRow.style.display === 'none') {
        detailsRow.style.display = 'table-row';
        icon.textContent = 'â–¼';
    } else {
        detailsRow.style.display = 'none';
        icon.textContent = 'â–¶';
    }
}
</script>
{% endif %}

<h3>About Medals</h3>
<div class="card">
    <p>Medals are awarded for two events in each match:</p>
    <p><strong>QSO Race:</strong> First three competitors to log a confirmed qualifying contact with the target.</p>
    <p><strong>Cool Factor:</strong> Three highest distance-to-power ratios ({% if display_prefs.distance_unit == 'mi' %}mi/W{% else %}km/W{% endif %}) - rewards efficient, low-power contacts.</p>
</div>
{% endblock %}
