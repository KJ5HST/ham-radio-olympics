{% extends "base.html" %}

{% block title %}Sports - Admin{% endblock %}

{% block content %}
<h2>Sports for {{ olympiad.name }}</h2>
<p><a href="/admin">&larr; Back to Dashboard</a></p>

<h3>Current Sports</h3>
{% if sports %}
<div class="table-responsive"><table>
    <thead>
        <tr>
            <th scope="col">Name</th>
            <th scope="col">Target Type</th>
            <th scope="col">Work/Activate</th>
            <th scope="col">Allowed Modes</th>
            <th scope="col">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for sport in sports %}
        <tr>
            <td><strong>{{ sport.name }}</strong></td>
            <td>{{ sport.target_type | capitalize }}</td>
            <td>
                {% if sport.work_enabled %}Work{% endif %}
                {% if sport.work_enabled and sport.activate_enabled %} / {% endif %}
                {% if sport.activate_enabled %}Activate{% endif %}
                {% if sport.separate_pools %} (separate){% endif %}
            </td>
            <td>{{ sport.allowed_modes or 'All' }}</td>
            <td>
                <div class="btn-group">
                    <a href="/admin/sport/{{ sport.id }}/competitors" class="btn btn-sm btn-icon" title="Competitors"><span class="icon">üë•</span></a>
                    <a href="/admin/sport/{{ sport.id }}/matches" class="btn btn-sm btn-icon btn-info" title="Matches"><span class="icon">üìÖ</span></a>
                    <button type="button" onclick="editSport({{ sport.id }}, '{{ sport.name | e }}', '{{ (sport.description or '') | e }}', '{{ sport.target_type }}', {{ sport.work_enabled | lower }}, {{ sport.activate_enabled | lower }}, {{ sport.separate_pools | lower }}, '{{ sport.allowed_modes or '' }}')" class="btn btn-sm btn-icon btn-secondary" title="Edit"><span class="icon">‚úèÔ∏è</span></button>
                    <button type="button" onclick="deleteSport({{ sport.id }})" class="btn btn-sm btn-icon btn-danger" title="Delete"><span class="icon">üóëÔ∏è</span></button>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table></div>
{% else %}
<p>No sports yet. Create one below.</p>
{% endif %}

<h3 id="form-title">Create Sport</h3>
<div class="card">
    <form id="sport-form">
        <input type="hidden" id="sport_id">
        <div class="form-group">
            <label for="name">Name</label>
            <input type="text" id="name" required placeholder="DX Challenge">
        </div>
        <div class="form-group">
            <label for="description">Description</label>
            <input type="text" id="description" placeholder="Work DX stations on target continent">
        </div>
        <div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center; margin-bottom: 15px;">
            <div>
                <label for="target_type" style="font-size: 0.85em; color: var(--text-secondary);">Target</label>
                <select id="target_type" required style="margin-top: 2px;">
                    <option value="continent">Continent</option>
                    <option value="country">Country</option>
                    <option value="park">Park</option>
                    <option value="pota" title="Any POTA Park">Any POTA</option>
                    <option value="call">Callsign</option>
                    <option value="grid">Grid</option>
                    <option value="any">Any</option>
                </select>
            </div>
            <label title="Hunters working DX stations score points" style="cursor: help;"><input type="checkbox" id="work_enabled" checked> Work</label>
            <label title="Activators making contacts from target location score points" style="cursor: help;"><input type="checkbox" id="activate_enabled"> Activate</label>
            <label title="Work and Activate have separate leaderboards (14 max pts vs 7)" style="cursor: help;"><input type="checkbox" id="separate_pools"> Separate</label>
        </div>
        <div class="form-group">
            <label>Allowed Modes (leave unchecked for all modes)</label>
            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px;">
                <label><input type="checkbox" class="mode-checkbox" value="CW"> CW</label>
                <label><input type="checkbox" class="mode-checkbox" value="SSB"> SSB</label>
                <label><input type="checkbox" class="mode-checkbox" value="FM"> FM</label>
                <label><input type="checkbox" class="mode-checkbox" value="AM"> AM</label>
                <label><input type="checkbox" class="mode-checkbox" value="FT8"> FT8</label>
                <label><input type="checkbox" class="mode-checkbox" value="FT4"> FT4</label>
                <label><input type="checkbox" class="mode-checkbox" value="RTTY"> RTTY</label>
                <label><input type="checkbox" class="mode-checkbox" value="PSK31"> PSK31</label>
                <label><input type="checkbox" class="mode-checkbox" value="JS8"> JS8</label>
            </div>
            <small style="color: #718096;">USB/LSB QSOs will match SSB. Select modes to restrict this sport.</small>
        </div>
        <div class="btn-group">
            <button type="submit" class="btn btn-success" id="submit-btn"><span class="icon">‚ûï</span> Create Sport</button>
            <button type="button" id="cancel-btn" onclick="cancelEdit()" class="btn btn-secondary" style="display: none;"><span class="icon">‚úï</span> Cancel</button>
        </div>
    </form>
    <div id="sport-result"></div>
</div>

<script>
const olympiadId = {{ olympiad.id }};
let editingId = null;

function getSelectedModes() {
    const checkboxes = document.querySelectorAll('.mode-checkbox:checked');
    const modes = Array.from(checkboxes).map(cb => cb.value);
    return modes.length > 0 ? modes.join(',') : null;
}

function setSelectedModes(modesStr) {
    // Clear all checkboxes first
    document.querySelectorAll('.mode-checkbox').forEach(cb => cb.checked = false);
    if (modesStr) {
        const modes = modesStr.split(',').map(m => m.trim().toUpperCase());
        modes.forEach(mode => {
            const cb = document.querySelector(`.mode-checkbox[value="${mode}"]`);
            if (cb) cb.checked = true;
        });
    }
}

function editSport(id, name, description, targetType, workEnabled, activateEnabled, separatePools, allowedModes) {
    editingId = id;
    document.getElementById('sport_id').value = id;
    document.getElementById('name').value = name;
    document.getElementById('description').value = description;
    document.getElementById('target_type').value = targetType;
    document.getElementById('work_enabled').checked = workEnabled;
    document.getElementById('activate_enabled').checked = activateEnabled;
    document.getElementById('separate_pools').checked = separatePools;
    setSelectedModes(allowedModes);
    document.getElementById('form-title').textContent = 'Edit Sport';
    document.getElementById('submit-btn').innerHTML = '<span class="icon">üíæ</span> Save';
    document.getElementById('cancel-btn').style.display = 'inline-flex';
}

function cancelEdit() {
    editingId = null;
    document.getElementById('sport_id').value = '';
    document.getElementById('name').value = '';
    document.getElementById('description').value = '';
    document.getElementById('target_type').value = 'continent';
    document.getElementById('work_enabled').checked = true;
    document.getElementById('activate_enabled').checked = false;
    document.getElementById('separate_pools').checked = false;
    setSelectedModes(null);
    document.getElementById('form-title').textContent = 'Create Sport';
    document.getElementById('submit-btn').innerHTML = '<span class="icon">‚ûï</span> Create Sport';
    document.getElementById('cancel-btn').style.display = 'none';
}

document.getElementById('sport-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const result = document.getElementById('sport-result');
    const data = {
        name: document.getElementById('name').value,
        description: document.getElementById('description').value || null,
        target_type: document.getElementById('target_type').value,
        work_enabled: document.getElementById('work_enabled').checked,
        activate_enabled: document.getElementById('activate_enabled').checked,
        separate_pools: document.getElementById('separate_pools').checked,
        allowed_modes: getSelectedModes()
    };
    try {
        let resp;
        if (editingId) {
            resp = await fetch('/admin/sport/' + editingId, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin',
                body: JSON.stringify(data)
            });
        } else {
            resp = await fetch('/admin/olympiad/' + olympiadId + '/sport', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin',
                body: JSON.stringify(data)
            });
        }
        const respData = await resp.json();
        if (resp.ok) {
            result.innerHTML = '<div class="alert alert-success">Sport ' + (editingId ? 'updated' : 'created') + '!</div>';
            setTimeout(() => location.reload(), 1000);
        } else {
            result.innerHTML = '<div class="alert alert-error">' + respData.detail + '</div>';
        }
    } catch (err) {
        result.innerHTML = '<div class="alert alert-error">Error: ' + err.message + '</div>';
    }
});

async function deleteSport(id) {
    if (!confirm('Delete this Sport and all its Matches?')) return;
    await fetch('/admin/sport/' + id, {
        method: 'DELETE',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin'
    });
    location.reload();
}
</script>
{% endblock %}
