{% extends "base.html" %}

{% block title %}Competitors - Admin{% endblock %}

{% block content %}
<h2>Competitors</h2>
<p><a href="/admin">&larr; Back to Dashboard</a></p>

<div class="card" style="margin-bottom: 20px;">
    <form method="get" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: end;">
        <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
            <label for="search">Search Callsign</label>
            <input type="text" id="search" name="search" value="{{ request.query_params.get('search', '') }}" placeholder="W1ABC...">
        </div>
        <div class="btn-group">
            <button type="submit" class="btn"><span class="icon">üîç</span> Search</button>
            {% if request.query_params.get('search') %}
            <a href="/admin/competitors" class="btn btn-secondary"><span class="icon">‚úï</span> Clear</a>
            {% endif %}
        </div>
        <a href="/admin/export/competitors" class="btn btn-info"><span class="icon">üì•</span> Export CSV</a>
    </form>
</div>

{% if request.query_params.get('search') %}
<p style="color: var(--text-secondary);">Showing {{ competitors | length }} result(s) for "{{ request.query_params.get('search') }}"</p>
{% endif %}

<!-- Bulk Action Bar -->
<div id="bulk-action-bar" style="display: none; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 4px; padding: 10px 15px; margin-bottom: 15px;">
    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        <span id="selected-count" style="font-weight: bold;">0 selected</span>
        <div class="btn-group">
            <button type="button" onclick="bulkEnable()" class="btn btn-sm btn-success"><span class="icon">‚úì</span> Enable</button>
            <button type="button" onclick="bulkDisable()" class="btn btn-sm btn-warning"><span class="icon">‚è∏Ô∏è</span> Disable</button>
            <button type="button" onclick="bulkDelete()" class="btn btn-sm btn-danger"><span class="icon">üóëÔ∏è</span> Delete</button>
        </div>
        <button type="button" onclick="clearSelection()" class="btn btn-sm btn-secondary"><span class="icon">‚úï</span> Clear</button>
    </div>
</div>

{% if competitors %}
<div class="table-responsive"><table>
    <thead>
        <tr>
            <th scope="col" style="width: 40px;"><input type="checkbox" id="select-all" onchange="toggleSelectAll(this)"></th>
            <th scope="col">Callsign</th>
            <th scope="col">Role</th>
            <th scope="col">Status</th>
            <th scope="col">Registered</th>
            <th scope="col">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for c in competitors %}
        <tr{% if c.is_disabled %} style="opacity: 0.6;"{% endif %}>
            <td><input type="checkbox" class="competitor-checkbox" value="{{ c.callsign }}" onchange="updateBulkBar()"></td>
            <td>
                <strong>{{ c.first_name | competitor_display(c.callsign) }}</strong>
                {% if c.is_referee and c.assigned_sports %}
                {% for s in c.assigned_sports %}
                <br><small style="color: #805ad5;">üìã {{ s.name }}</small>
                {% endfor %}
                {% endif %}
            </td>
            <td>
                {% if c.is_admin %}
                <span style="color: #c53030; font-weight: bold;">Admin</span>
                {% elif c.is_referee %}
                <span style="color: #805ad5; font-weight: bold;">Referee</span>
                {% else %}
                <span style="color: #718096;">Competitor</span>
                {% endif %}
            </td>
            <td>
                {% if c.is_disabled %}
                <span style="color: #c53030;">Disabled</span>
                {% else %}
                <span style="color: #38a169;">Active</span>
                {% endif %}
            </td>
            <td>{{ c.registered_at | format_date }}</td>
            <td>
                <div class="btn-group">
                    <a href="/competitor/{{ c.callsign }}" class="btn btn-sm btn-icon" title="View"><span class="icon">üë§</span></a>

                    <!-- Role Management Dropdown -->
                    <div style="display: inline-block; position: relative;">
                        <button type="button" onclick="toggleDropdown('role-{{ c.callsign }}')" class="btn btn-sm btn-icon btn-secondary" title="Role"><span class="icon">üé≠</span></button>
                        <div id="role-{{ c.callsign }}" class="dropdown-menu" style="display: none; position: absolute; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 4px; padding: 5px; z-index: 100; min-width: 150px;">
                            {% if not c.is_admin %}
                            <button onclick="setAdmin('{{ c.callsign }}')" style="display: block; width: 100%; text-align: left; padding: 8px; border: none; background: none; cursor: pointer; color: var(--text-primary);">üëë Make Admin</button>
                            {% else %}
                            <button onclick="removeAdmin('{{ c.callsign }}')" style="display: block; width: 100%; text-align: left; padding: 8px; border: none; background: none; cursor: pointer; color: var(--text-primary);">Remove Admin</button>
                            {% endif %}
                            {% if not c.is_referee %}
                            <button onclick="setReferee('{{ c.callsign }}')" style="display: block; width: 100%; text-align: left; padding: 8px; border: none; background: none; cursor: pointer; color: var(--text-primary);">üèÅ Make Referee</button>
                            {% else %}
                            <button onclick="removeReferee('{{ c.callsign }}')" style="display: block; width: 100%; text-align: left; padding: 8px; border: none; background: none; cursor: pointer; color: var(--text-primary);">Remove Referee</button>
                            {% endif %}
                        </div>
                    </div>

                    {% if c.is_referee %}
                    <!-- Sport Assignment Dropdown -->
                    <div style="display: inline-block; position: relative;">
                        <button type="button" onclick="toggleDropdown('assign-{{ c.callsign }}')" class="btn btn-sm btn-icon btn-purple" title="Assign Sports"><span class="icon">üìã</span></button>
                        <div id="assign-{{ c.callsign }}" class="dropdown-menu" style="display: none; position: absolute; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 4px; padding: 5px; z-index: 100; min-width: 200px; max-height: 300px; overflow-y: auto;">
                            {% for sport in all_sports %}
                            {% set is_assigned = sport.id in (c.assigned_sports | map(attribute='id') | list) %}
                            <button type="button" onclick="{% if is_assigned %}unassignSport('{{ c.callsign }}', {{ sport.id }}){% else %}assignSport('{{ c.callsign }}', {{ sport.id }}){% endif %}"
                                    style="display: block; width: 100%; text-align: left; padding: 8px; border: none; background: {% if is_assigned %}var(--bg-card){% else %}none{% endif %}; cursor: pointer; color: var(--text-primary);">
                                {% if is_assigned %}‚úì {% endif %}{{ sport.name }} ({{ sport.olympiad_name }})
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if c.is_disabled %}
                    <button type="button" onclick="enableCompetitor('{{ c.callsign }}')" class="btn btn-sm btn-icon btn-success" title="Enable"><span class="icon">‚úì</span></button>
                    {% else %}
                    <button type="button" onclick="disableCompetitor('{{ c.callsign }}')" class="btn btn-sm btn-icon btn-warning" title="Disable"><span class="icon">‚è∏Ô∏è</span></button>
                    <button type="button" onclick="disqualifyCompetitor('{{ c.callsign }}')" class="btn btn-sm btn-icon btn-purple" title="Disqualify"><span class="icon">üö´</span></button>
                    {% endif %}
                    <button type="button" onclick="resetPassword('{{ c.callsign }}')" class="btn btn-sm btn-icon btn-info" title="Reset Password"><span class="icon">üîë</span></button>
                    <button type="button" onclick="syncCompetitor('{{ c.callsign }}')" class="btn btn-sm btn-icon btn-success" title="Sync QSOs"><span class="icon">üîÑ</span></button>
                    <button type="button" onclick="resetCompetitorQsos('{{ c.callsign }}')" class="btn btn-sm btn-icon btn-warning" title="Reset QSOs"><span class="icon">‚ôªÔ∏è</span></button>
                    <button type="button" onclick="deleteCompetitor('{{ c.callsign }}')" class="btn btn-sm btn-icon btn-danger" title="Delete"><span class="icon">üóëÔ∏è</span></button>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table></div>

{% if pagination and pagination.total_pages > 1 %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; flex-wrap: wrap; gap: 10px;">
    <span style="color: var(--text-secondary);">
        Showing {{ (pagination.page - 1) * pagination.per_page + 1 }}-{{ [pagination.page * pagination.per_page, pagination.total_items] | min }} of {{ pagination.total_items }} competitors
    </span>
    <div class="btn-group">
        {% if pagination.page > 1 %}
        <a href="?{% if request.query_params.get('search') %}search={{ request.query_params.get('search') }}&{% endif %}page={{ pagination.page - 1 }}" class="btn btn-sm btn-secondary">&larr; Prev</a>
        {% endif %}
        <span class="btn btn-sm" style="cursor: default;">Page {{ pagination.page }} of {{ pagination.total_pages }}</span>
        {% if pagination.page < pagination.total_pages %}
        <a href="?{% if request.query_params.get('search') %}search={{ request.query_params.get('search') }}&{% endif %}page={{ pagination.page + 1 }}" class="btn btn-sm btn-secondary">Next &rarr;</a>
        {% endif %}
    </div>
</div>
{% endif %}

{% else %}
<p>No competitors registered yet.</p>
{% endif %}

<script>
function toggleDropdown(id) {
    const dropdown = document.getElementById(id);
    const allDropdowns = document.querySelectorAll('.dropdown-menu');
    allDropdowns.forEach(d => {
        if (d.id !== id) d.style.display = 'none';
    });
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('button') && !e.target.closest('.dropdown-menu')) {
        document.querySelectorAll('.dropdown-menu').forEach(d => d.style.display = 'none');
    }
});

async function setAdmin(callsign) {
    if (!confirm('Make ' + callsign + ' an admin?')) return;
    await fetch('/admin/competitor/' + callsign + '/set-admin', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin'
    });
    location.reload();
}

async function removeAdmin(callsign) {
    if (!confirm('Remove admin role from ' + callsign + '?')) return;
    await fetch('/admin/competitor/' + callsign + '/remove-admin', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin'
    });
    location.reload();
}

async function setReferee(callsign) {
    if (!confirm('Make ' + callsign + ' a referee?')) return;
    await fetch('/admin/competitor/' + callsign + '/set-referee', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin'
    });
    location.reload();
}

async function removeReferee(callsign) {
    if (!confirm('Remove referee role from ' + callsign + '? This will also remove all sport assignments.')) return;
    await fetch('/admin/competitor/' + callsign + '/remove-referee', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin'
    });
    location.reload();
}

async function assignSport(callsign, sportId) {
    try {
        const resp = await fetch('/admin/competitor/' + callsign + '/assign-sport/' + sportId, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin'
        });
        if (!resp.ok) {
            const data = await resp.json().catch(() => ({}));
            showToast(data.detail || 'Failed to assign sport', 'error');
            return;
        }
        location.reload();
    } catch (err) {
        showToast('Network error: ' + err.message, 'error');
    }
}

async function unassignSport(callsign, sportId) {
    try {
        const resp = await fetch('/admin/competitor/' + callsign + '/assign-sport/' + sportId, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin'
        });
        if (!resp.ok) {
            const data = await resp.json().catch(() => ({}));
            showToast(data.detail || 'Failed to unassign sport', 'error');
            return;
        }
        location.reload();
    } catch (err) {
        showToast('Network error: ' + err.message, 'error');
    }
}

async function disableCompetitor(callsign) {
    if (!confirm('Disable ' + callsign + '? They will be logged out and unable to log in.')) return;
    await fetch('/admin/competitor/' + callsign + '/disable', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin'
    });
    location.reload();
}

async function enableCompetitor(callsign) {
    if (!confirm('Enable ' + callsign + '?')) return;
    await fetch('/admin/competitor/' + callsign + '/enable', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin'
    });
    location.reload();
}

async function disqualifyCompetitor(callsign) {
    if (!confirm('Disqualify ' + callsign + ' from the competition? They will be removed from all sports and lose their medals.')) return;
    await fetch('/admin/competitor/' + callsign + '/disqualify', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin'
    });
    location.reload();
}

async function deleteCompetitor(callsign) {
    if (!confirm('Delete competitor ' + callsign + '? This cannot be undone.')) return;
    await fetch('/admin/competitor/' + callsign, {
        method: 'DELETE',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin'
    });
    location.reload();
}

async function resetPassword(callsign) {
    if (!confirm('Reset password for ' + callsign + '? They will be logged out.')) return;
    const response = await fetch('/admin/competitor/' + callsign + '/reset-password', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin'
    });
    const data = await response.json();
    if (response.ok) {
        // Use prompt to allow copying the password
        prompt('New password for ' + callsign + ' (copy this):', data.new_password);
        showToast('Password reset successful', 'success');
    } else {
        showToast('Error: ' + data.detail, 'error');
    }
}

async function syncCompetitor(callsign) {
    if (!confirm('Sync QSOs for ' + callsign + ' from their stored credentials?')) return;
    try {
        const response = await fetch('/admin/competitor/' + callsign + '/sync', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin'
        });
        const data = await response.json();
        if (response.ok) {
            let msg = 'Sync complete for ' + callsign;
            if (data.qrz_sync) msg += ' (QRZ: ' + (data.qrz_sync.new_qsos || 0) + ' new, ' + (data.qrz_sync.updated_qsos || 0) + ' updated)';
            if (data.lotw_sync) msg += ' (LoTW: ' + (data.lotw_sync.new_qsos || 0) + ' new, ' + (data.lotw_sync.updated_qsos || 0) + ' updated)';
            showToast(msg, 'success');
        } else {
            showToast('Error: ' + (data.detail || 'Sync failed'), 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}

async function resetCompetitorQsos(callsign) {
    if (!confirm('Reset all QSOs for ' + callsign + '?\n\nThis will delete all their QSOs and medals, then reload from their stored credentials.')) return;
    if (!confirm('Are you SURE? This will delete all QSOs and medals for ' + callsign + '.')) return;
    try {
        const response = await fetch('/admin/competitor/' + callsign + '/reset-qsos', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin'
        });
        const data = await response.json();
        if (response.ok) {
            let msg = 'Reset complete for ' + callsign + '. Deleted ' + data.deleted_qsos + ' QSOs.';
            if (data.qrz_sync) msg += ' QRZ: ' + (data.qrz_sync.new_qsos || 0) + ' new.';
            if (data.lotw_sync) msg += ' LoTW: ' + (data.lotw_sync.new_qsos || 0) + ' new.';
            showToast(msg, 'success');
        } else {
            showToast('Error: ' + (data.detail || 'Reset failed'), 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}

// Bulk action functions
function getSelectedCallsigns() {
    return Array.from(document.querySelectorAll('.competitor-checkbox:checked')).map(cb => cb.value);
}

function updateBulkBar() {
    const selected = getSelectedCallsigns();
    const bar = document.getElementById('bulk-action-bar');
    const count = document.getElementById('selected-count');
    const selectAll = document.getElementById('select-all');
    const allCheckboxes = document.querySelectorAll('.competitor-checkbox');

    if (selected.length > 0) {
        bar.style.display = 'block';
        count.textContent = selected.length + ' selected';
    } else {
        bar.style.display = 'none';
    }

    // Update select-all checkbox state
    selectAll.checked = allCheckboxes.length > 0 && selected.length === allCheckboxes.length;
    selectAll.indeterminate = selected.length > 0 && selected.length < allCheckboxes.length;
}

function toggleSelectAll(checkbox) {
    document.querySelectorAll('.competitor-checkbox').forEach(cb => cb.checked = checkbox.checked);
    updateBulkBar();
}

function clearSelection() {
    document.querySelectorAll('.competitor-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('select-all').checked = false;
    updateBulkBar();
}

async function bulkEnable() {
    const callsigns = getSelectedCallsigns();
    if (callsigns.length === 0) return;
    if (!confirm('Enable ' + callsigns.length + ' competitor(s)?')) return;

    try {
        const resp = await fetch('/admin/competitors/bulk-enable', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({callsigns: callsigns})
        });
        const data = await resp.json();
        if (resp.ok) {
            showToast(data.message, 'success');
            location.reload();
        } else {
            showToast('Error: ' + data.detail, 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}

async function bulkDisable() {
    const callsigns = getSelectedCallsigns();
    if (callsigns.length === 0) return;
    if (!confirm('Disable ' + callsigns.length + ' competitor(s)? They will be logged out.')) return;

    try {
        const resp = await fetch('/admin/competitors/bulk-disable', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({callsigns: callsigns})
        });
        const data = await resp.json();
        if (resp.ok) {
            showToast(data.message, 'success');
            location.reload();
        } else {
            showToast('Error: ' + data.detail, 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}

async function bulkDelete() {
    const callsigns = getSelectedCallsigns();
    if (callsigns.length === 0) return;
    if (!confirm('DELETE ' + callsigns.length + ' competitor(s)? This cannot be undone!')) return;
    if (!confirm('Are you SURE? All QSOs, medals, and data for these competitors will be permanently deleted.')) return;

    try {
        const resp = await fetch('/admin/competitors/bulk-delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({callsigns: callsigns})
        });
        const data = await resp.json();
        if (resp.ok) {
            showToast(data.message, 'success');
            location.reload();
        } else {
            showToast('Error: ' + data.detail, 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}
</script>
{% endblock %}
