{% extends "base.html" %}

{% block title %}Settings - Admin{% endblock %}

{% block content %}
<h2>Admin Settings</h2>
<p><a href="/admin">&larr; Back to Dashboard</a></p>

<div class="card">
    <h3>Public Access</h3>
    <p style="color: #718096; margin-bottom: 1rem;">
        When enabled, visitors who are not logged in can view events, leaderboards, medals, records, teams, and competitor profiles.
        This makes the competition more visible and can help attract new participants.
    </p>
    <form id="public-results-form">
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="public_results" {% if public_results %}checked{% endif %} style="width: auto;">
                <span>Allow public viewing of results</span>
            </label>
        </div>
        <div class="btn-group">
            <button type="submit" class="btn btn-success">Save</button>
        </div>
    </form>
    <div id="public-results-result" style="margin-top: 1rem;"></div>
</div>

<div class="card">
    <h3>Site Theme</h3>
    <p style="color: #718096; margin-bottom: 1rem;">
        Choose the visual theme for your site. Changes take effect immediately for all users.
    </p>
    <form id="theme-form">
        <div class="form-group">
            <label for="site_theme">Theme</label>
            <select id="site_theme" style="width: 100%; max-width: 300px;">
                <option value="olympics" {% if current_theme == 'olympics' %}selected{% endif %}>Olympics - Classic blue and gold</option>
                <option value="coolcontest" {% if current_theme == 'coolcontest' %}selected{% endif %}>Cool Contest - Modern indigo</option>
                <option value="neon" {% if current_theme == 'neon' %}selected{% endif %}>Neon - Cyberpunk purple</option>
                <option value="midnight" {% if current_theme == 'midnight' %}selected{% endif %}>Midnight - Luxurious navy and gold</option>
            </select>
        </div>
        <div class="form-group">
            <label for="site_name">Site Name</label>
            <input type="text" id="site_name" value="{{ site_name or 'Ham Radio Olympics' }}" placeholder="Ham Radio Olympics">
        </div>
        <div class="form-group">
            <label for="site_tagline">Tagline</label>
            <input type="text" id="site_tagline" value="{{ site_tagline or 'Compete. Connect. Conquer the Airwaves.' }}" placeholder="Compete. Connect. Conquer the Airwaves.">
        </div>
        <div class="btn-group">
            <button type="submit" class="btn btn-success">Save Theme Settings</button>
        </div>
    </form>
    <div id="theme-result" style="margin-top: 1rem;"></div>
</div>

<div class="card">
    <h3>Email Settings</h3>
    <p style="color: #718096; margin-bottom: 1rem;">
        Configure email notification behavior for the system.
    </p>
    <form id="email-settings-form">
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="admin_bcc_emails" {% if admin_bcc_emails %}checked{% endif %} style="width: auto;">
                <span>BCC admin on all outgoing emails</span>
            </label>
            <small style="color: #718096; display: block; margin-top: 0.5rem;">
                When enabled, a copy of every email sent to competitors will be sent to the admin email address ({{ admin_email or 'not configured' }}).
            </small>
        </div>
        <div class="btn-group">
            <button type="submit" class="btn btn-success">Save</button>
        </div>
    </form>
    <div id="email-settings-result" style="margin-top: 1rem;"></div>
</div>

<div class="card">
    <h3>Discord Notifications</h3>
    <p style="color: #718096; margin-bottom: 1rem;">
        Send server-wide notifications to a Discord channel when events occur.
        <br>Create a webhook in your Discord server settings under Integrations &rarr; Webhooks.
    </p>
    <form id="discord-form">
        <div class="form-group">
            <label for="discord_webhook_url">Webhook URL</label>
            <input type="url" id="discord_webhook_url" value="{{ discord_webhook_url or '' }}" placeholder="https://discord.com/api/webhooks/...">
        </div>
        <div class="btn-group">
            <button type="submit" class="btn btn-success">Save</button>
            {% if discord_configured %}
            <button type="button" onclick="testDiscord()" class="btn btn-info">Test</button>
            <button type="button" onclick="clearDiscord()" class="btn btn-danger">Clear</button>
            {% endif %}
        </div>
    </form>
    <div id="discord-result" style="margin-top: 1rem;"></div>

    {% if discord_configured %}
    <hr style="margin: 1.5rem 0; border-color: #4a5568;">
    <h4 style="margin-bottom: 1rem;">Notification Types</h4>
    <form id="discord-options-form">
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="discord_notify_signups" {% if discord_notify_signups %}checked{% endif %} style="width: auto;">
                <span>New competitor signups</span>
            </label>
        </div>
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="discord_notify_records" {% if discord_notify_records %}checked{% endif %} style="width: auto;">
                <span>World records</span>
            </label>
        </div>
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="discord_notify_medals" {% if discord_notify_medals %}checked{% endif %} style="width: auto;">
                <span>Medal awards</span>
            </label>
        </div>
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="discord_notify_pota" {% if discord_notify_pota %}checked{% endif %} style="width: auto;">
                <span>POTA spot summaries</span>
            </label>
        </div>
        <div class="form-group" id="pota-interval-group" style="margin-left: 2rem; {% if not discord_notify_pota %}display: none;{% endif %}">
            <label for="discord_pota_interval">POTA summary interval (minutes)</label>
            <select id="discord_pota_interval" style="width: auto;">
                <option value="15" {% if discord_pota_interval == 15 %}selected{% endif %}>15 minutes</option>
                <option value="30" {% if discord_pota_interval == 30 or not discord_pota_interval %}selected{% endif %}>30 minutes</option>
                <option value="60" {% if discord_pota_interval == 60 %}selected{% endif %}>1 hour</option>
                <option value="120" {% if discord_pota_interval == 120 %}selected{% endif %}>2 hours</option>
                <option value="240" {% if discord_pota_interval == 240 %}selected{% endif %}>4 hours</option>
            </select>
            <small style="color: #718096; display: block; margin-top: 0.5rem;">
                How often to post POTA activity summaries (deduplicated per interval)
            </small>
        </div>
        <div class="btn-group">
            <button type="submit" class="btn btn-success">Save Options</button>
        </div>
    </form>
    <div id="discord-options-result" style="margin-top: 1rem;"></div>
    {% endif %}
</div>

<div class="card">
    <h3>QRZ XML API Credentials</h3>
    <p style="color: #718096; margin-bottom: 1rem;">
        These credentials are used for callsign lookups to fetch competitor names and country information.
        <br>A QRZ XML subscription is required. The username is your callsign (not email).
    </p>
    <form id="qrz-form">
        <div class="form-group">
            <label for="qrz_username">QRZ Username (Callsign)</label>
            <input type="text" id="qrz_username" value="{{ qrz_username or '' }}" placeholder="e.g., W1ABC" style="text-transform: uppercase;">
        </div>
        <div class="form-group">
            <label for="qrz_password">QRZ Password</label>
            <input type="password" id="qrz_password" value="{{ '********' if qrz_configured else '' }}" placeholder="Enter password">
            {% if qrz_configured %}
            <small style="color: #718096;">Leave blank to keep existing password</small>
            {% endif %}
        </div>
        <div class="btn-group">
            <button type="submit" class="btn btn-success"><span class="icon">üíæ</span> Save</button>
            {% if qrz_configured %}
            <button type="button" onclick="testQrz()" class="btn btn-info"><span class="icon">üîå</span> Test</button>
            <button type="button" onclick="clearQrz()" class="btn btn-danger"><span class="icon">üóëÔ∏è</span> Clear</button>
            {% endif %}
        </div>
    </form>
    <div id="qrz-result" style="margin-top: 1rem;"></div>
</div>

<script>
// Discord form handler
document.getElementById('discord-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const result = document.getElementById('discord-result');
    const webhookUrl = document.getElementById('discord_webhook_url').value.trim();

    try {
        const resp = await fetch('/admin/settings/discord', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({ webhook_url: webhookUrl })
        });
        const data = await resp.json();
        if (resp.ok) {
            result.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
            setTimeout(() => location.reload(), 1500);
        } else {
            result.innerHTML = '<div class="alert alert-error">' + data.detail + '</div>';
        }
    } catch (err) {
        result.innerHTML = '<div class="alert alert-error">Error: ' + err.message + '</div>';
    }
});

async function testDiscord() {
    const result = document.getElementById('discord-result');
    result.innerHTML = '<div class="alert">Sending test message...</div>';

    try {
        const resp = await fetch('/admin/settings/discord/test', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin'
        });
        const data = await resp.json();
        if (resp.ok) {
            result.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
        } else {
            result.innerHTML = '<div class="alert alert-error">' + data.detail + '</div>';
        }
    } catch (err) {
        result.innerHTML = '<div class="alert alert-error">Error: ' + err.message + '</div>';
    }
}

async function clearDiscord() {
    if (!confirm('Clear Discord webhook? Notifications will no longer be sent to Discord.')) return;

    const result = document.getElementById('discord-result');
    try {
        const resp = await fetch('/admin/settings/discord', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin'
        });
        const data = await resp.json();
        if (resp.ok) {
            result.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
            setTimeout(() => location.reload(), 1500);
        } else {
            result.innerHTML = '<div class="alert alert-error">' + data.detail + '</div>';
        }
    } catch (err) {
        result.innerHTML = '<div class="alert alert-error">Error: ' + err.message + '</div>';
    }
}

// Discord options form handler
const discordOptionsForm = document.getElementById('discord-options-form');
if (discordOptionsForm) {
    // Show/hide POTA interval based on checkbox
    const potaCheckbox = document.getElementById('discord_notify_pota');
    const potaIntervalGroup = document.getElementById('pota-interval-group');
    if (potaCheckbox && potaIntervalGroup) {
        potaCheckbox.addEventListener('change', () => {
            potaIntervalGroup.style.display = potaCheckbox.checked ? 'block' : 'none';
        });
    }

    discordOptionsForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const result = document.getElementById('discord-options-result');

        const data = {
            notify_signups: document.getElementById('discord_notify_signups').checked,
            notify_records: document.getElementById('discord_notify_records').checked,
            notify_medals: document.getElementById('discord_notify_medals').checked,
            notify_pota: document.getElementById('discord_notify_pota').checked,
            pota_interval: parseInt(document.getElementById('discord_pota_interval').value)
        };

        try {
            const resp = await fetch('/admin/settings/discord/options', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin',
                body: JSON.stringify(data)
            });
            const respData = await resp.json();
            if (resp.ok) {
                result.innerHTML = '<div class="alert alert-success">' + respData.message + '</div>';
            } else {
                result.innerHTML = '<div class="alert alert-error">' + respData.detail + '</div>';
            }
        } catch (err) {
            result.innerHTML = '<div class="alert alert-error">Error: ' + err.message + '</div>';
        }
    });
}

// Email settings form handler
document.getElementById('email-settings-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const result = document.getElementById('email-settings-result');
    const enabled = document.getElementById('admin_bcc_emails').checked;

    try {
        const resp = await fetch('/admin/settings/email', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({ admin_bcc_emails: enabled })
        });
        const data = await resp.json();
        if (resp.ok) {
            result.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
        } else {
            result.innerHTML = '<div class="alert alert-error">' + data.detail + '</div>';
        }
    } catch (err) {
        result.innerHTML = '<div class="alert alert-error">Error: ' + err.message + '</div>';
    }
});

// Public results form handler
document.getElementById('public-results-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const result = document.getElementById('public-results-result');
    const enabled = document.getElementById('public_results').checked;

    try {
        const resp = await fetch('/admin/settings/public-results', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({ enabled })
        });
        const data = await resp.json();
        if (resp.ok) {
            result.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
        } else {
            result.innerHTML = '<div class="alert alert-error">' + data.detail + '</div>';
        }
    } catch (err) {
        result.innerHTML = '<div class="alert alert-error">Error: ' + err.message + '</div>';
    }
});

// Theme form handler
document.getElementById('theme-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const result = document.getElementById('theme-result');
    const theme = document.getElementById('site_theme').value;
    const name = document.getElementById('site_name').value.trim();
    const tagline = document.getElementById('site_tagline').value.trim();

    try {
        const resp = await fetch('/admin/settings/theme', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({ theme, name, tagline })
        });
        const data = await resp.json();
        if (resp.ok) {
            result.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
            setTimeout(() => location.reload(), 1000);
        } else {
            result.innerHTML = '<div class="alert alert-error">' + data.detail + '</div>';
        }
    } catch (err) {
        result.innerHTML = '<div class="alert alert-error">Error: ' + err.message + '</div>';
    }
});

// QRZ form handler
document.getElementById('qrz-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const result = document.getElementById('qrz-result');
    const username = document.getElementById('qrz_username').value.trim().toUpperCase();
    const password = document.getElementById('qrz_password').value;

    if (!username) {
        result.innerHTML = '<div class="alert alert-error">Username is required</div>';
        return;
    }

    // Don't send if password is just the placeholder
    const data = { username };
    if (password && password !== '********') {
        data.password = password;
    }

    try {
        const resp = await fetch('/admin/settings/qrz', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify(data)
        });
        const respData = await resp.json();
        if (resp.ok) {
            result.innerHTML = '<div class="alert alert-success">' + respData.message + '</div>';
            setTimeout(() => location.reload(), 1500);
        } else {
            result.innerHTML = '<div class="alert alert-error">' + respData.detail + '</div>';
        }
    } catch (err) {
        result.innerHTML = '<div class="alert alert-error">Error: ' + err.message + '</div>';
    }
});

async function testQrz() {
    const result = document.getElementById('qrz-result');
    result.innerHTML = '<div class="alert">Testing connection...</div>';

    try {
        const resp = await fetch('/admin/settings/qrz/test', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin'
        });
        const data = await resp.json();
        if (resp.ok) {
            result.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
        } else {
            result.innerHTML = '<div class="alert alert-error">' + data.detail + '</div>';
        }
    } catch (err) {
        result.innerHTML = '<div class="alert alert-error">Error: ' + err.message + '</div>';
    }
}

async function clearQrz() {
    if (!confirm('Clear QRZ credentials? Callsign lookups will fall back to HamQTH.')) return;

    const result = document.getElementById('qrz-result');
    try {
        const resp = await fetch('/admin/settings/qrz', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin'
        });
        const data = await resp.json();
        if (resp.ok) {
            result.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
            setTimeout(() => location.reload(), 1500);
        } else {
            result.innerHTML = '<div class="alert alert-error">' + data.detail + '</div>';
        }
    } catch (err) {
        result.innerHTML = '<div class="alert alert-error">Error: ' + err.message + '</div>';
    }
}
</script>
{% endblock %}
