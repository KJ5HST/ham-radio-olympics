{% extends "base.html" %}

{% block title %}Admin - Ham Radio Olympics{% endblock %}

{% block content %}
<h2>Admin Dashboard</h2>

<div class="stats">
    <div class="stat-box">
        <div class="value">{{ olympiads|length }}</div>
        <div class="label">Olympiads</div>
    </div>
    <a href="/admin/competitors?admin_key={{ request.query_params.get('admin_key', '') }}" class="stat-box" style="text-decoration: none; color: inherit;">
        <div class="value">{{ competitor_count }}</div>
        <div class="label">Competitors</div>
    </a>
    <a href="/admin/teams" class="stat-box" style="text-decoration: none; color: inherit;">
        <div class="value">üë•</div>
        <div class="label">Teams</div>
    </a>
    <a href="/admin/audit-log" class="stat-box" style="text-decoration: none; color: inherit;">
        <div class="value">üìã</div>
        <div class="label">Audit Log</div>
    </a>
    <a href="/admin/settings?admin_key={{ request.query_params.get('admin_key', '') }}" class="stat-box" style="text-decoration: none; color: inherit;">
        <div class="value">‚öôÔ∏è</div>
        <div class="label">Settings</div>
    </a>
    <a href="/admin/backup" class="stat-box" style="text-decoration: none; color: inherit;">
        <div class="value">üíæ</div>
        <div class="label">Backup DB</div>
    </a>
    <div class="stat-box" style="cursor: pointer;" onclick="recomputeRecords()">
        <div class="value">üèÜ</div>
        <div class="label">Recompute Records</div>
    </div>
</div>

<h3>Olympiads</h3>
{% if olympiads %}
<div class="table-responsive"><table>
    <thead>
        <tr>
            <th scope="col">Name</th>
            <th scope="col">Period</th>
            <th scope="col">Qualifying</th>
            <th scope="col">Status</th>
            <th scope="col">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for olympiad in olympiads %}
        <tr>
            <td><strong>{{ olympiad.name }}</strong></td>
            <td>{{ olympiad.start_date | format_date }} to {{ olympiad.end_date | format_date }}</td>
            <td>{{ olympiad.qualifying_qsos }} QSOs</td>
            <td>{% if olympiad.is_active %}<span style="color: green;">Active</span>{% else %}Inactive{% endif %}</td>
            <td>
                <div class="btn-group">
                    <a href="/admin/olympiad/{{ olympiad.id }}/sports?admin_key={{ request.query_params.get('admin_key', '') }}" class="btn btn-sm btn-icon" title="Sports"><span class="icon">üèÖ</span></a>
                    <button type="button" onclick="editOlympiad({{ olympiad.id }}, '{{ olympiad.name | e }}', '{{ olympiad.start_date }}', '{{ olympiad.end_date }}', {{ olympiad.qualifying_qsos }})" class="btn btn-sm btn-icon btn-secondary" title="Edit"><span class="icon">‚úèÔ∏è</span></button>
                    {% if olympiad.is_active %}
                    <button type="button" onclick="deactivateOlympiad({{ olympiad.id }})" class="btn btn-sm btn-icon btn-warning" title="Pause"><span class="icon">‚è∏Ô∏è</span></button>
                    {% else %}
                    <button type="button" onclick="activateOlympiad({{ olympiad.id }})" class="btn btn-sm btn-icon btn-success" title="Activate"><span class="icon">‚ñ∂Ô∏è</span></button>
                    {% endif %}
                    <button type="button" onclick="deleteOlympiad({{ olympiad.id }})" class="btn btn-sm btn-icon btn-danger" title="Delete"><span class="icon">üóëÔ∏è</span></button>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table></div>
{% else %}
<p>No olympiads yet. Create one below.</p>
{% endif %}

<h3 id="form-title">Create Olympiad</h3>
<div class="card">
    <form id="olympiad-form">
        <input type="hidden" id="olympiad_id">
        <div class="form-group">
            <label for="name">Name</label>
            <input type="text" id="name" required placeholder="2026 Ham Radio Olympics">
        </div>
        <div class="form-group">
            <label for="start_date">Start Date</label>
            <input type="date" id="start_date" required>
        </div>
        <div class="form-group">
            <label for="end_date">End Date</label>
            <input type="date" id="end_date" required>
        </div>
        <div class="form-group">
            <label for="qualifying_qsos">Qualifying QSOs (0 = no minimum)</label>
            <input type="number" id="qualifying_qsos" value="0" min="0">
        </div>
        <div class="btn-group">
            <button type="submit" class="btn btn-success" id="submit-btn"><span class="icon">‚ûï</span> Create Olympiad</button>
            <button type="button" id="cancel-btn" onclick="cancelEdit()" class="btn btn-secondary" style="display: none;"><span class="icon">‚úï</span> Cancel</button>
        </div>
    </form>
    <div id="olympiad-result"></div>
</div>

<script>
const adminKey = new URLSearchParams(window.location.search).get('admin_key');
let editingId = null;

function editOlympiad(id, name, startDate, endDate, qualifyingQsos) {
    editingId = id;
    document.getElementById('olympiad_id').value = id;
    document.getElementById('name').value = name;
    document.getElementById('start_date').value = startDate;
    document.getElementById('end_date').value = endDate;
    document.getElementById('qualifying_qsos').value = qualifyingQsos;
    document.getElementById('form-title').textContent = 'Edit Olympiad';
    document.getElementById('submit-btn').innerHTML = '<span class="icon">üíæ</span> Save';
    document.getElementById('cancel-btn').style.display = 'inline-flex';
}

function cancelEdit() {
    editingId = null;
    document.getElementById('olympiad_id').value = '';
    document.getElementById('name').value = '';
    document.getElementById('start_date').value = '';
    document.getElementById('end_date').value = '';
    document.getElementById('qualifying_qsos').value = '0';
    document.getElementById('form-title').textContent = 'Create Olympiad';
    document.getElementById('submit-btn').innerHTML = '<span class="icon">‚ûï</span> Create Olympiad';
    document.getElementById('cancel-btn').style.display = 'none';
}

document.getElementById('olympiad-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const result = document.getElementById('olympiad-result');
    const data = {
        name: document.getElementById('name').value,
        start_date: document.getElementById('start_date').value,
        end_date: document.getElementById('end_date').value,
        qualifying_qsos: parseInt(document.getElementById('qualifying_qsos').value) || 0
    };
    try {
        let resp;
        if (editingId) {
            resp = await fetch('/admin/olympiad/' + editingId + '?admin_key=' + adminKey, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
        } else {
            resp = await fetch('/admin/olympiad?admin_key=' + adminKey, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
        }
        const respData = await resp.json();
        if (resp.ok) {
            result.innerHTML = '<div class="alert alert-success">Olympiad ' + (editingId ? 'updated' : 'created') + '!</div>';
            setTimeout(() => location.reload(), 1000);
        } else {
            result.innerHTML = '<div class="alert alert-error">' + respData.detail + '</div>';
        }
    } catch (err) {
        result.innerHTML = '<div class="alert alert-error">Error: ' + err.message + '</div>';
    }
});

async function activateOlympiad(id) {
    if (!confirm('Activate this Olympiad? This will deactivate others.')) return;
    await fetch('/admin/olympiad/' + id + '/activate?admin_key=' + adminKey, {method: 'POST'});
    location.reload();
}

async function deactivateOlympiad(id) {
    if (!confirm('Pause this Olympiad?')) return;
    await fetch('/admin/olympiad/' + id + '/deactivate?admin_key=' + adminKey, {method: 'POST'});
    location.reload();
}

async function deleteOlympiad(id) {
    if (!confirm('Delete this Olympiad? This cannot be undone.')) return;
    await fetch('/admin/olympiad/' + id + '?admin_key=' + adminKey, {method: 'DELETE'});
    location.reload();
}

async function recomputeRecords() {
    if (!confirm('Recompute all world records? This will recalculate records from match-qualifying QSOs.')) return;
    try {
        const resp = await fetch('/admin/recompute-records?admin_key=' + adminKey, {method: 'POST'});
        const data = await resp.json();
        if (resp.ok) {
            showToast(data.message, 'success');
        } else {
            showToast('Error: ' + data.detail, 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}
</script>
{% endblock %}
