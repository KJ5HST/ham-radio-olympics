{% extends "base.html" %}

{% block title %}Matches - Admin{% endblock %}

{% block content %}
<h2>Matches for {{ sport.name }}</h2>
<p>
    <a href="/admin/olympiad/{{ sport.olympiad_id }}/sports">&larr; Back to Sports</a>
</p>

<div class="card">
    <p><strong>Target Type:</strong> {{ sport.target_type | capitalize }}</p>
    <p><strong>Work/Activate:</strong>
        {% if sport.work_enabled %}Work{% endif %}
        {% if sport.work_enabled and sport.activate_enabled %} / {% endif %}
        {% if sport.activate_enabled %}Activate{% endif %}
        {% if sport.separate_pools %} (separate pools){% endif %}
    </p>
    <p><strong>Sport Allowed Modes:</strong> {{ sport.allowed_modes or 'All' }}</p>
</div>

<h3>Scheduled Matches</h3>
{% if matches %}
<div class="table-responsive"><table>
    <thead>
        <tr>
            <th scope="col">Target</th>
            <th scope="col">Target Type</th>
            <th scope="col">Start Date</th>
            <th scope="col">End Date</th>
            <th scope="col">Confirm Deadline</th>
            <th scope="col">Mode Override</th>
            <th scope="col">Max Power</th>
            <th scope="col">Live</th>
            <th scope="col">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for match in matches %}
        <tr>
            <td><strong>{{ match.target_display | pota_tooltip }}</strong></td>
            <td>{% if match.target_type %}<span style="color: var(--link-color);">{{ match.target_type | capitalize }}</span>{% else %}<span style="color: var(--text-secondary);">(Sport)</span>{% endif %}</td>
            <td>{{ match.start_date | format_datetime_short }}</td>
            <td>{{ match.end_date | format_datetime_short }}</td>
            <td>{% if match.confirmation_deadline %}{{ match.confirmation_deadline | format_datetime_short }}{% else %}-{% endif %}</td>
            <td>{{ match.allowed_modes or '-' }}</td>
            <td>{% if match.max_power_w %}{{ match.max_power_w }}W{% else %}-{% endif %}</td>
            <td>{% if match.show_live_results %}<span title="Live results enabled" style="color: #38a169;">‚ö°</span>{% else %}-{% endif %}</td>
            <td>
                <div class="btn-group">
                    <button type="button" onclick="editMatch({{ match.id }}, '{{ match.target_value }}', '{{ match.start_date[:16] }}', '{{ match.end_date[:16] }}', '{{ match.allowed_modes or '' }}', {{ match.max_power_w or 'null' }}, '{{ match.target_type or '' }}', '{{ (match.confirmation_deadline or '')[:16] }}', {{ 'true' if match.show_live_results else 'false' }})" class="btn btn-sm btn-icon btn-secondary" title="Edit"><span class="icon">‚úèÔ∏è</span></button>
                    <button type="button" onclick="deleteMatch({{ match.id }})" class="btn btn-sm btn-icon btn-danger" title="Delete"><span class="icon">üóëÔ∏è</span></button>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table></div>
{% else %}
<p>No matches scheduled yet. Create one below.</p>
{% endif %}

<h3 id="form-title">Create Match</h3>
<div class="card">
    <form id="match-form">
        <input type="hidden" id="match_id">
        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <div class="form-group" style="flex: 1; min-width: 200px;">
                <label for="target_value">Target Value</label>
                {% if target_options %}
                <select id="target_value" required>
                    <option value="">-- Select --</option>
                    {% for code, name in target_options %}
                    <option value="{{ code }}">{{ name }} ({{ code }})</option>
                    {% endfor %}
                </select>
                {% else %}
                <input type="text" id="target_value" required placeholder="{% if sport.target_type == 'park' %}K-0001{% elif sport.target_type == 'grid' %}FN31{% elif sport.target_type == 'call' %}W1AW{% else %}Target{% endif %}">
                {% endif %}
            </div>
            <div class="form-group" style="flex: 1; min-width: 200px;">
                <label for="target_type">Type Override</label>
                <select id="target_type">
                    <option value="">(Sport: {{ sport.target_type | capitalize }})</option>
                    <option value="continent">Continent</option>
                    <option value="country">Country</option>
                    <option value="park">Specific Park</option>
                    <option value="pota">Any POTA Park</option>
                    <option value="call">Callsign</option>
                    <option value="grid">Grid Square</option>
                    <option value="any">Any QSO</option>
                </select>
            </div>
            <div class="form-group" style="flex: 0 0 120px;">
                <label for="max_power_w">Max Power</label>
                <input type="number" id="max_power_w" min="1" placeholder="No limit">
            </div>
        </div>
        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <div class="form-group" style="flex: 1; min-width: 200px;">
                <label for="start_date">Start (UTC)</label>
                <input type="datetime-local" id="start_date" required>
            </div>
            <div class="form-group" style="flex: 1; min-width: 200px;">
                <label for="end_date">End (UTC)</label>
                <input type="datetime-local" id="end_date" required>
            </div>
            <div class="form-group" style="flex: 1; min-width: 200px;">
                <label for="confirmation_deadline">Confirm Deadline (UTC)</label>
                <input type="datetime-local" id="confirmation_deadline">
            </div>
        </div>
        <div class="form-group">
            <label>Mode Override (leave unchecked to use sport's modes)</label>
            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px;">
                <label><input type="checkbox" class="mode-checkbox" value="CW"> CW</label>
                <label><input type="checkbox" class="mode-checkbox" value="SSB"> SSB</label>
                <label><input type="checkbox" class="mode-checkbox" value="FM"> FM</label>
                <label><input type="checkbox" class="mode-checkbox" value="AM"> AM</label>
                <label><input type="checkbox" class="mode-checkbox" value="FT8"> FT8</label>
                <label><input type="checkbox" class="mode-checkbox" value="FT4"> FT4</label>
                <label><input type="checkbox" class="mode-checkbox" value="RTTY"> RTTY</label>
                <label><input type="checkbox" class="mode-checkbox" value="PSK31"> PSK31</label>
                <label><input type="checkbox" class="mode-checkbox" value="JS8"> JS8</label>
            </div>
            <small style="color: #718096;">If checked, overrides sport-level mode restrictions for this match only.</small>
        </div>
        <div style="margin-bottom: 15px;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="show_live_results">
                <span style="color: var(--text-primary);">‚ö° Show Live Results</span>
            </div>
            <small style="color: var(--text-secondary); display: block; margin-top: 5px;">Enable to show unconfirmed QSOs in standings. Useful during competition day for real-time feedback.</small>
        </div>
        <div class="btn-group">
            <button type="submit" class="btn btn-success" id="submit-btn"><span class="icon">‚ûï</span> Create Match</button>
            <button type="button" id="cancel-btn" onclick="cancelEdit()" class="btn btn-secondary" style="display: none;"><span class="icon">‚úï</span> Cancel</button>
        </div>
    </form>
    <div id="match-result"></div>
</div>

<script>
const sportId = {{ sport.id }};
let editingId = null;

function getSelectedModes() {
    const checkboxes = document.querySelectorAll('.mode-checkbox:checked');
    const modes = Array.from(checkboxes).map(cb => cb.value);
    return modes.length > 0 ? modes.join(',') : null;
}

function setSelectedModes(modesStr) {
    document.querySelectorAll('.mode-checkbox').forEach(cb => cb.checked = false);
    if (modesStr) {
        const modes = modesStr.split(',').map(m => m.trim().toUpperCase());
        modes.forEach(mode => {
            const cb = document.querySelector(`.mode-checkbox[value="${mode}"]`);
            if (cb) cb.checked = true;
        });
    }
}

// Set default times on page load
function setDefaultTimes() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    document.getElementById('start_date').value = `${year}-${month}-${day}T00:00`;
    document.getElementById('end_date').value = `${year}-${month}-${day}T23:59`;
    document.getElementById('confirmation_deadline').value = `${year}-${month}-${day}T23:59`;
}
setDefaultTimes();

// Sync confirmation deadline to end date when end date changes
document.getElementById('end_date').addEventListener('change', function() {
    const confirmField = document.getElementById('confirmation_deadline');
    // Only auto-update if confirmation is empty or matches the previous end date
    if (!confirmField.dataset.userModified) {
        confirmField.value = this.value;
    }
});

// Track if user manually changed confirmation deadline
document.getElementById('confirmation_deadline').addEventListener('change', function() {
    this.dataset.userModified = 'true';
});

function editMatch(id, targetValue, startDate, endDate, allowedModes, maxPowerW, targetType, confirmationDeadline, showLiveResults) {
    editingId = id;
    document.getElementById('match_id').value = id;
    document.getElementById('target_value').value = targetValue;
    document.getElementById('target_type').value = targetType || '';
    document.getElementById('start_date').value = startDate;
    document.getElementById('end_date').value = endDate;
    setSelectedModes(allowedModes);
    document.getElementById('max_power_w').value = maxPowerW || '';
    const confirmField = document.getElementById('confirmation_deadline');
    confirmField.value = confirmationDeadline || endDate;
    // Mark as user-modified if different from end date
    confirmField.dataset.userModified = (confirmationDeadline && confirmationDeadline !== endDate) ? 'true' : '';
    document.getElementById('show_live_results').checked = showLiveResults || false;
    document.getElementById('form-title').textContent = 'Edit Match';
    document.getElementById('submit-btn').innerHTML = '<span class="icon">üíæ</span> Save';
    document.getElementById('cancel-btn').style.display = 'inline-flex';
}

function cancelEdit() {
    editingId = null;
    document.getElementById('match_id').value = '';
    document.getElementById('target_value').value = '';
    document.getElementById('target_type').value = '';
    setDefaultTimes();
    setSelectedModes(null);
    document.getElementById('max_power_w').value = '';
    document.getElementById('confirmation_deadline').dataset.userModified = '';
    document.getElementById('show_live_results').checked = false;
    document.getElementById('form-title').textContent = 'Create Match';
    document.getElementById('submit-btn').innerHTML = '<span class="icon">‚ûï</span> Create Match';
    document.getElementById('cancel-btn').style.display = 'none';
}

document.getElementById('match-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const result = document.getElementById('match-result');
    const maxPowerVal = document.getElementById('max_power_w').value;
    const targetTypeVal = document.getElementById('target_type').value;
    const confirmDeadlineVal = document.getElementById('confirmation_deadline').value;
    const data = {
        target_value: document.getElementById('target_value').value,
        start_date: document.getElementById('start_date').value + ':00',
        end_date: document.getElementById('end_date').value + ':00',
        allowed_modes: getSelectedModes(),
        max_power_w: maxPowerVal ? parseInt(maxPowerVal, 10) : null,
        target_type: targetTypeVal || null,
        confirmation_deadline: confirmDeadlineVal ? confirmDeadlineVal + ':00' : null,
        show_live_results: document.getElementById('show_live_results').checked
    };
    try {
        let resp;
        if (editingId) {
            resp = await fetch('/admin/match/' + editingId, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin',
                body: JSON.stringify(data)
            });
        } else {
            resp = await fetch('/admin/sport/' + sportId + '/match', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin',
                body: JSON.stringify(data)
            });
        }
        const respData = await resp.json();
        if (resp.ok) {
            result.innerHTML = '<div class="alert alert-success">Match ' + (editingId ? 'updated' : 'created') + '!</div>';
            setTimeout(() => location.reload(), 1000);
        } else {
            result.innerHTML = '<div class="alert alert-error">' + respData.detail + '</div>';
        }
    } catch (err) {
        result.innerHTML = '<div class="alert alert-error">Error: ' + err.message + '</div>';
    }
});

async function deleteMatch(id) {
    if (!confirm('Delete this Match?')) return;
    await fetch('/admin/match/' + id, {
        method: 'DELETE',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin'
    });
    location.reload();
}
</script>
{% endblock %}
