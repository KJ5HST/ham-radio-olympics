{% extends "base.html" %}

{% block title %}Settings - {{ user.callsign }} - Ham Radio Olympics{% endblock %}

{% block nav_extra %}{% endblock %}

{% block content %}
<h2>Account Settings</h2>
<p>Callsign: <strong>{{ user.callsign }}</strong> | Member since: {{ account.registered_at | format_date }}</p>

{% if request.query_params.get('updated') %}
<div class="alert alert-success">
    {% if request.query_params.get('updated') == 'name' %}Name updated successfully.
    {% elif request.query_params.get('updated') == 'email' %}Email updated successfully.
    {% elif request.query_params.get('updated') == 'password' %}Password changed successfully.
    {% elif request.query_params.get('updated') == 'qrz' %}QRZ API key updated successfully.
    {% elif request.query_params.get('updated') == 'qrz_removed' %}QRZ API key removed.
    {% elif request.query_params.get('updated') == 'lotw' %}LoTW credentials updated successfully.
    {% elif request.query_params.get('updated') == 'lotw_removed' %}LoTW credentials removed.
    {% elif request.query_params.get('updated') == 'verification_sent' %}Verification email sent. Please check your inbox.
    {% elif request.query_params.get('updated') == 'notifications' %}Email notification preferences updated.
    {% endif %}
</div>
{% endif %}

{% if request.query_params.get('error') %}
<div class="alert alert-error">{{ request.query_params.get('error') }}</div>
{% endif %}

<h3>Your Name</h3>
<div class="card">
    <p style="font-size: 0.9em; color: #718096; margin-bottom: 15px;">Your name is displayed in the navigation and on leaderboards.</p>
    <form action="/settings/name" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <div class="form-group" style="flex: 1; min-width: 150px;">
                <label for="first_name">First Name</label>
                <input type="text" id="first_name" name="first_name" value="{{ account.first_name or '' }}" placeholder="John">
            </div>
            <div class="form-group" style="flex: 1; min-width: 150px;">
                <label for="last_name">Last Name</label>
                <input type="text" id="last_name" name="last_name" value="{{ account.last_name or '' }}" placeholder="Smith">
            </div>
        </div>
        <button type="submit" class="btn">Update Name</button>
    </form>
</div>

<h3>Email Address</h3>
<div class="card">
    <form action="/settings/email" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" value="{{ account.email or '' }}" placeholder="you@example.com">
        </div>
        {% if account.email %}
        <p style="margin-bottom: 15px;">
            Status:
            {% if account.email_verified %}
            <span style="color: #22543d;">Verified</span>
            {% else %}
            <span style="color: #c53030;">Not verified</span>
            {% endif %}
        </p>
        {% endif %}
        <div style="display: flex; gap: 10px;">
            <button type="submit" class="btn">Update Email</button>
            {% if account.email and not account.email_verified %}
            <button type="button" class="btn" style="background: #718096;" onclick="resendVerification()">Resend Verification</button>
            {% endif %}
        </div>
    </form>
</div>

<h3>Change Password</h3>
<div class="card">
    <form action="/settings/password" method="post" id="password-form" data-loading>
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="form-group">
            <label for="current_password">Current Password</label>
            <input type="password" id="current_password" name="current_password" required>
        </div>
        <div class="form-group">
            <label for="new_password">New Password</label>
            <input type="password" id="new_password" name="new_password" required minlength="8">
        </div>
        <div class="form-group">
            <label for="confirm_password">Confirm New Password</label>
            <input type="password" id="confirm_password" required minlength="8">
        </div>
        <button type="submit" class="btn">Change Password</button>
    </form>
    <div id="password-result"></div>
</div>

<h3>QRZ API Key</h3>
<div class="card">
    <p>Status: {% if user.has_qrz_key %}<span style="color: #22543d;">Stored</span>{% else %}<span style="color: #718096;">Not stored</span>{% endif %}</p>
    <p style="font-size: 0.9em; color: #718096;">Your QRZ API key enables automatic QSO sync. Get your key from <a href="https://logbook.qrz.com/logbook" target="_blank">QRZ Logbook Settings</a> (requires QRZ XML subscription).</p>
    <form action="/settings/qrz-key" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="form-group">
            <label for="qrz_api_key">QRZ API Key</label>
            <input type="text" id="qrz_api_key" name="qrz_api_key" required placeholder="XXXX-XXXX-XXXX-XXXX">
        </div>
        <div style="display: flex; gap: 10px;">
            <button type="submit" class="btn">{% if user.has_qrz_key %}Update{% else %}Save{% endif %} API Key</button>
            {% if user.has_qrz_key %}
            <button type="button" class="btn" style="background: #c53030;" onclick="removeQrzKey()">Remove</button>
            {% endif %}
        </div>
    </form>
</div>

<h3>LoTW Credentials</h3>
<div class="card">
    <p>Status: {% if user.has_lotw_creds %}<span style="color: #22543d;">Stored</span>{% else %}<span style="color: #718096;">Not stored</span>{% endif %}</p>
    <p style="font-size: 0.9em; color: #718096;">Your LoTW credentials enable automatic QSO sync from Logbook of the World.</p>
    <form action="/settings/lotw" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="form-group">
            <label for="lotw_username">LoTW Username</label>
            <input type="text" id="lotw_username" name="lotw_username" required placeholder="Your callsign">
        </div>
        <div class="form-group">
            <label for="lotw_password">LoTW Password</label>
            <input type="password" id="lotw_password" name="lotw_password" required placeholder="Your LoTW password">
        </div>
        <div style="display: flex; gap: 10px;">
            <button type="submit" class="btn">{% if user.has_lotw_creds %}Update{% else %}Save{% endif %} Credentials</button>
            {% if user.has_lotw_creds %}
            <button type="button" class="btn" style="background: #c53030;" onclick="removeLotwCreds()">Remove</button>
            {% endif %}
        </div>
    </form>
</div>

<h3 id="notifications">Email Notifications</h3>
<div class="card">
    <p style="font-size: 0.9em; color: #718096; margin-bottom: 15px;">Choose which email notifications you'd like to receive. Requires a verified email address.</p>
    <form action="/settings/notifications" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" name="email_notifications_enabled" value="true" {% if account.email_notifications_enabled %}checked{% endif %} style="width: auto;">
                <span>Enable all email notifications</span>
            </label>
        </div>
        <div style="margin-left: 28px; display: flex; flex-direction: column; gap: 12px;">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" name="email_medal_notifications" value="true" {% if account.email_medal_notifications %}checked{% endif %} style="width: auto;">
                <span>Medal notifications</span>
                <span style="font-size: 0.85em; color: #718096;">(when you earn a new medal)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" name="email_match_reminders" value="true" {% if account.email_match_reminders %}checked{% endif %} style="width: auto;">
                <span>Weekly match digest</span>
                <span style="font-size: 0.85em; color: #718096;">(upcoming matches in your sports)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" name="email_record_notifications" value="true" {% if account.email_record_notifications %}checked{% endif %} style="width: auto;">
                <span>Record notifications</span>
                <span style="font-size: 0.85em; color: #718096;">(when you set a new world record)</span>
            </label>
        </div>
        <button type="submit" class="btn" style="margin-top: 15px;">Save Preferences</button>
    </form>
</div>

<script>
document.getElementById('password-form').addEventListener('submit', function(e) {
    const newPass = document.getElementById('new_password').value;
    const confirm = document.getElementById('confirm_password').value;

    if (newPass !== confirm) {
        e.preventDefault();
        document.getElementById('password-result').innerHTML =
            '<div class="alert alert-error">New passwords do not match</div>';
    }
});

async function removeQrzKey() {
    if (!confirm('Are you sure you want to remove your stored QRZ API key?')) return;

    const resp = await fetch('/settings/qrz-key', {
        method: 'DELETE',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin'
    });
    if (resp.ok) {
        window.location.href = '/settings?updated=qrz_removed';
    } else {
        showToast('Failed to remove QRZ key', 'error');
    }
}

async function removeLotwCreds() {
    if (!confirm('Are you sure you want to remove your stored LoTW credentials?')) return;

    const resp = await fetch('/settings/lotw', {
        method: 'DELETE',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin'
    });
    if (resp.ok) {
        window.location.href = '/settings?updated=lotw_removed';
    } else {
        showToast('Failed to remove LoTW credentials', 'error');
    }
}

async function resendVerification() {
    const resp = await fetch('/settings/resend-verification', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin'
    });
    if (resp.redirected) {
        window.location.href = resp.url;
    } else if (!resp.ok) {
        showToast('Failed to send verification email', 'error');
    }
}
</script>
{% endblock %}
