{% extends "base.html" %}

{% block title %}Settings - {{ user.callsign }} - Ham Radio Olympics{% endblock %}

{% block nav_extra %}{% endblock %}

{% block content %}
<h2>Account Settings</h2>
<p>Callsign: <strong>{{ user.callsign }}</strong> | Member since: {{ account.registered_at | format_date }}</p>

{% if request.query_params.get('updated') %}
<div class="alert alert-success">
    {% if request.query_params.get('updated') == 'name' %}Name updated successfully.
    {% elif request.query_params.get('updated') == 'email' %}Email updated successfully.
    {% elif request.query_params.get('updated') == 'password' %}Password changed successfully.
    {% elif request.query_params.get('updated') == 'qrz' %}QRZ API key updated successfully.
    {% elif request.query_params.get('updated') == 'qrz_removed' %}QRZ API key removed.
    {% elif request.query_params.get('updated') == 'lotw' %}LoTW credentials updated successfully.
    {% elif request.query_params.get('updated') == 'lotw_removed' %}LoTW credentials removed.
    {% elif request.query_params.get('updated') == 'verification_sent' %}Verification email sent. Please check your inbox.
    {% elif request.query_params.get('updated') == 'notifications' %}Email notification preferences updated.
    {% elif request.query_params.get('updated') == 'display' %}Display preferences updated.
    {% endif %}
</div>
{% endif %}

{% if request.query_params.get('error') %}
<div class="alert alert-error">{{ request.query_params.get('error') }}</div>
{% endif %}

<h3>Your Name</h3>
<div class="card">
    <p style="font-size: 0.9em; color: #718096; margin-bottom: 15px;">Your name is displayed in the navigation and on leaderboards.</p>
    <form action="/settings/name" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <div class="form-group" style="flex: 1; min-width: 150px;">
                <label for="first_name">First Name</label>
                <input type="text" id="first_name" name="first_name" value="{{ account.first_name or '' }}" placeholder="John">
            </div>
            <div class="form-group" style="flex: 1; min-width: 150px;">
                <label for="last_name">Last Name</label>
                <input type="text" id="last_name" name="last_name" value="{{ account.last_name or '' }}" placeholder="Smith">
            </div>
        </div>
        <button type="submit" class="btn">Update Name</button>
    </form>
</div>

<h3>Email Address</h3>
<div class="card">
    <form action="/settings/email" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" value="{{ account.email or '' }}" placeholder="you@example.com">
        </div>
        {% if account.email %}
        <p style="margin-bottom: 15px;">
            Status:
            {% if account.email_verified %}
            <span style="color: #22543d;">Verified</span>
            {% else %}
            <span style="color: #c53030;">Not verified</span>
            {% endif %}
        </p>
        {% endif %}
        <div style="display: flex; gap: 10px;">
            <button type="submit" class="btn">Update Email</button>
            {% if account.email and not account.email_verified %}
            <button type="button" class="btn" style="background: #718096;" onclick="resendVerification()">Resend Verification</button>
            {% endif %}
        </div>
    </form>
</div>

<h3>Change Password</h3>
<div class="card">
    <form action="/settings/password" method="post" id="password-form" data-loading>
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="form-group">
            <label for="current_password">Current Password</label>
            <input type="password" id="current_password" name="current_password" required>
        </div>
        <div class="form-group">
            <label for="new_password">New Password</label>
            <input type="password" id="new_password" name="new_password" required minlength="8">
        </div>
        <div class="form-group">
            <label for="confirm_password">Confirm New Password</label>
            <input type="password" id="confirm_password" required minlength="8">
        </div>
        <button type="submit" class="btn">Change Password</button>
    </form>
    <div id="password-result"></div>
</div>

<h3>QRZ API Key</h3>
<div class="card">
    <p>Status: {% if user.has_qrz_key %}<span style="color: #22543d;">Stored</span>{% else %}<span style="color: #718096;">Not stored</span>{% endif %}</p>
    <p style="font-size: 0.9em; color: #718096;">Your QRZ API key enables automatic QSO sync. Get your key from <a href="https://logbook.qrz.com/logbook" target="_blank">QRZ Logbook Settings</a> (requires QRZ XML subscription).</p>
    <form action="/settings/qrz-key" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="form-group">
            <label for="qrz_api_key">QRZ API Key</label>
            <input type="text" id="qrz_api_key" name="qrz_api_key" required placeholder="XXXX-XXXX-XXXX-XXXX">
        </div>
        <div style="display: flex; gap: 10px;">
            <button type="submit" class="btn">{% if user.has_qrz_key %}Update{% else %}Save{% endif %} API Key</button>
            {% if user.has_qrz_key %}
            <button type="button" class="btn" style="background: #c53030;" onclick="removeQrzKey()">Remove</button>
            {% endif %}
        </div>
    </form>
</div>

<h3>LoTW Credentials</h3>
<div class="card">
    <p>Status: {% if user.has_lotw_creds %}<span style="color: #22543d;">Stored</span>{% else %}<span style="color: #718096;">Not stored</span>{% endif %}</p>
    <p style="font-size: 0.9em; color: #718096;">Your LoTW credentials enable automatic QSO sync from Logbook of the World.</p>
    <form action="/settings/lotw" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="form-group">
            <label for="lotw_username">LoTW Username</label>
            <input type="text" id="lotw_username" name="lotw_username" required placeholder="Your callsign">
        </div>
        <div class="form-group">
            <label for="lotw_password">LoTW Password</label>
            <input type="password" id="lotw_password" name="lotw_password" required placeholder="Your LoTW password">
        </div>
        <div style="display: flex; gap: 10px;">
            <button type="submit" class="btn">{% if user.has_lotw_creds %}Update{% else %}Save{% endif %} Credentials</button>
            {% if user.has_lotw_creds %}
            <button type="button" class="btn" style="background: #c53030;" onclick="removeLotwCreds()">Remove</button>
            {% endif %}
        </div>
    </form>
</div>

<h3 id="display">Display Preferences</h3>
<div class="card">
    <p style="font-size: 0.9em; color: #718096; margin-bottom: 15px;">Customize how distances and times are displayed throughout the site.</p>
    <form action="/settings/display" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 15px;">
            <div class="form-group" style="flex: 1; min-width: 200px;">
                <label for="distance_unit">Distance Unit</label>
                <select id="distance_unit" name="distance_unit" style="width: 100%;">
                    <option value="km" {% if account.distance_unit == 'km' %}selected{% endif %}>Kilometers (km)</option>
                    <option value="mi" {% if account.distance_unit == 'mi' %}selected{% endif %}>Miles (mi)</option>
                </select>
            </div>
            <div class="form-group" style="flex: 1; min-width: 200px;">
                <label for="time_display">Time Display</label>
                <select id="time_display" name="time_display" style="width: 100%;">
                    <option value="utc" {% if account.time_display == 'utc' %}selected{% endif %}>UTC</option>
                    <option value="local" {% if account.time_display == 'local' %}selected{% endif %}>Local Time (based on home grid)</option>
                </select>
            </div>
            <div class="form-group" style="flex: 1; min-width: 200px;">
                <label for="home_grid">Home Grid Square</label>
                <input type="text" id="home_grid" name="home_grid" value="{{ account.home_grid or '' }}" placeholder="e.g., EM12" maxlength="6" style="width: 100%; text-transform: uppercase;">
                <small style="color: var(--text-secondary);">Used for local time calculation</small>
            </div>
        </div>
        <button type="submit" class="btn">Save Display Preferences</button>
    </form>
</div>

<h3 id="notifications">Email Notifications</h3>
<div class="card">
    <p style="font-size: 0.9em; color: #718096; margin-bottom: 15px;">Choose which email notifications you'd like to receive. Requires a verified email address.</p>
    <form action="/settings/notifications" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" name="email_notifications_enabled" value="true" {% if account.email_notifications_enabled %}checked{% endif %} style="width: auto;">
                <span>Enable all email notifications</span>
            </label>
        </div>
        <div style="margin-left: 28px; display: flex; flex-direction: column; gap: 12px;">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" name="email_medal_notifications" value="true" {% if account.email_medal_notifications %}checked{% endif %} style="width: auto;">
                <span>Medal notifications</span>
                <span style="font-size: 0.85em; color: #718096;">(when you earn a new medal)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" name="email_match_reminders" value="true" {% if account.email_match_reminders %}checked{% endif %} style="width: auto;">
                <span>Weekly match digest</span>
                <span style="font-size: 0.85em; color: #718096;">(upcoming matches in your sports)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" name="email_record_notifications" value="true" {% if account.email_record_notifications %}checked{% endif %} style="width: auto;">
                <span>Record notifications</span>
                <span style="font-size: 0.85em; color: #718096;">(when you set a new world record)</span>
            </label>
        </div>
        <button type="submit" class="btn" style="margin-top: 15px;">Save Preferences</button>
    </form>
</div>

<h3 id="push-notifications">Push Notifications</h3>
<div class="card">
    <p style="font-size: 0.9em; color: #718096; margin-bottom: 15px;">
        Get instant notifications on your device when medals change, QSOs are confirmed, or matches are about to start.
    </p>

    <div id="push-status" style="margin-bottom: 15px;">
        <span id="push-status-indicator" style="display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px; border-radius: 4px; background: var(--bg-card); border: 1px solid var(--border-color);">
            <span id="push-status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #718096;"></span>
            <span id="push-status-text">Checking...</span>
        </span>
    </div>

    <div id="push-not-supported" style="display: none;">
        <p style="color: #c53030;">Push notifications are not supported in this browser. Try using Chrome, Firefox, or Edge.</p>
    </div>

    <div id="push-ios-standalone" style="display: none;">
        <p style="color: #dd6b20; margin-bottom: 10px;">
            <strong>iOS requires the app to be installed</strong>
        </p>
        <p style="margin-bottom: 10px;">To enable push notifications on iOS Safari:</p>
        <ol style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
            <li>Tap the <strong>Share</strong> button <span style="font-size: 1.2em;">&#x1F4E4;</span> at the bottom of Safari</li>
            <li>Scroll down and tap <strong>"Add to Home Screen"</strong></li>
            <li>Tap <strong>"Add"</strong> in the top right</li>
            <li>Open the app from your home screen</li>
            <li>Return to Settings to enable notifications</li>
        </ol>
        <p style="font-size: 0.9em; color: #718096;">Note: Requires iOS 16.4 or later</p>
    </div>

    <div id="push-not-configured" style="display: none;">
        <p style="color: #718096;">Push notifications are not configured on this server.</p>
    </div>

    <div id="push-permission-denied" style="display: none;">
        <p style="color: #c53030;">Push notification permission was denied. Please enable notifications in your browser settings to receive alerts.</p>
    </div>

    <div id="push-controls" style="display: none;">
        <div id="push-subscribe-section">
            <button type="button" class="btn" onclick="subscribePush()" id="push-subscribe-btn">
                Enable Push Notifications
            </button>
        </div>

        <div id="push-preferences-section" style="display: none;">
            <p style="margin-bottom: 15px; color: #22543d;">
                <strong>Push notifications are enabled</strong>
                <span id="push-device-count"></span>
            </p>

            <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 15px;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="pref-medal-changes" checked style="width: auto;">
                    <span>Medal changes</span>
                    <span style="font-size: 0.85em; color: #718096;">(when you win, lose, or upgrade medals)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="pref-new-confirmations" checked style="width: auto;">
                    <span>QSO confirmations</span>
                    <span style="font-size: 0.85em; color: #718096;">(when your QSOs get confirmed)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="pref-record-broken" checked style="width: auto;">
                    <span>Record achievements</span>
                    <span style="font-size: 0.85em; color: #718096;">(when you set personal or world records)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="pref-match-reminders" checked style="width: auto;">
                    <span>Match reminders</span>
                    <span style="font-size: 0.85em; color: #718096;">(7 days before a match starts)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="pref-pota-spots" checked style="width: auto;">
                    <span>POTA spot alerts</span>
                    <span style="font-size: 0.85em; color: #718096;">(when someone activates a park in your matches)</span>
                </label>
            </div>

            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button type="button" class="btn" onclick="savePushPreferences()">Save Preferences</button>
                <button type="button" class="btn" style="background: #718096;" onclick="testPushNotification()">Send Test</button>
                <button type="button" class="btn" style="background: #c53030;" onclick="unsubscribePush()">Disable Notifications</button>
            </div>
        </div>
    </div>
</div>

<script>
// Push notification management
(function() {
    var pushSupported = 'serviceWorker' in navigator && 'PushManager' in window;
    var pushConfigured = false;
    var currentSubscription = null;

    // Detect iOS Safari
    var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    var isStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
    var isIOSSafari = isIOS && isSafari;

    async function initPushUI() {
        var statusDot = document.getElementById('push-status-dot');
        var statusText = document.getElementById('push-status-text');

        // iOS Safari only supports push when installed to home screen
        if (isIOSSafari && !isStandalone) {
            document.getElementById('push-ios-standalone').style.display = 'block';
            statusDot.style.background = '#dd6b20';
            statusText.textContent = 'Install app first';
            return;
        }

        if (!pushSupported) {
            document.getElementById('push-not-supported').style.display = 'block';
            statusDot.style.background = '#c53030';
            statusText.textContent = 'Not supported';
            return;
        }

        // Check if push is configured on server
        try {
            var resp = await fetch('/push/vapid-public-key');
            if (!resp.ok) {
                document.getElementById('push-not-configured').style.display = 'block';
                statusDot.style.background = '#718096';
                statusText.textContent = 'Not configured';
                return;
            }
            pushConfigured = true;
        } catch (e) {
            document.getElementById('push-not-configured').style.display = 'block';
            statusDot.style.background = '#718096';
            statusText.textContent = 'Not configured';
            return;
        }

        // Check permission
        var permission = Notification.permission;
        if (permission === 'denied') {
            document.getElementById('push-permission-denied').style.display = 'block';
            statusDot.style.background = '#c53030';
            statusText.textContent = 'Permission denied';
            return;
        }

        document.getElementById('push-controls').style.display = 'block';

        // Check current subscription with timeout
        try {
            statusText.textContent = 'Loading...';

            // Wait for service worker with timeout
            var swReady = Promise.race([
                navigator.serviceWorker.ready,
                new Promise(function(_, reject) {
                    setTimeout(function() { reject(new Error('SW timeout')); }, 10000);
                })
            ]);

            var reg = await swReady;
            currentSubscription = await reg.pushManager.getSubscription();

            if (currentSubscription) {
                showPreferencesSection();
                await loadPreferences();
            } else {
                showSubscribeSection();
            }
        } catch (e) {
            console.error('Push init error:', e);
            showSubscribeSection();
        }
    }

    function showSubscribeSection() {
        document.getElementById('push-subscribe-section').style.display = 'block';
        document.getElementById('push-preferences-section').style.display = 'none';
        document.getElementById('push-status-dot').style.background = '#718096';
        document.getElementById('push-status-text').textContent = 'Disabled';
    }

    function showPreferencesSection() {
        document.getElementById('push-subscribe-section').style.display = 'none';
        document.getElementById('push-preferences-section').style.display = 'block';
        document.getElementById('push-status-dot').style.background = '#38a169';
        document.getElementById('push-status-text').textContent = 'Enabled';
    }

    async function loadPreferences() {
        try {
            var resp = await fetch('/push/preferences');
            if (resp.ok) {
                var data = await resp.json();
                document.getElementById('pref-medal-changes').checked = data.preferences.medal_changes;
                document.getElementById('pref-new-confirmations').checked = data.preferences.new_confirmations;
                document.getElementById('pref-record-broken').checked = data.preferences.record_broken;
                document.getElementById('pref-match-reminders').checked = data.preferences.match_reminders;
                document.getElementById('pref-pota-spots').checked = data.preferences.pota_spots !== false;

                if (data.subscription_count > 1) {
                    document.getElementById('push-device-count').textContent =
                        ' on ' + data.subscription_count + ' devices';
                }
            }
        } catch (e) {
            console.error('Failed to load preferences:', e);
        }
    }

    window.subscribePush = async function() {
        var btn = document.getElementById('push-subscribe-btn');
        btn.disabled = true;
        btn.textContent = 'Enabling...';

        // Timeout helper
        function withTimeout(promise, ms, message) {
            return Promise.race([
                promise,
                new Promise(function(_, reject) {
                    setTimeout(function() { reject(new Error(message || 'Timeout')); }, ms);
                })
            ]);
        }

        try {
            // Check if service worker is supported and registered
            if (!('serviceWorker' in navigator)) {
                throw new Error('Service workers not supported');
            }

            // Get VAPID public key
            var resp = await withTimeout(fetch('/push/vapid-public-key'), 10000, 'Server timeout');
            var data = await resp.json();
            if (!data.publicKey) {
                throw new Error('Server not configured for push');
            }
            var publicKey = urlBase64ToUint8Array(data.publicKey);

            // Request permission with timeout
            btn.textContent = 'Requesting permission...';
            var permission = await withTimeout(
                Notification.requestPermission(),
                30000,
                'Permission request timed out. Check your browser settings.'
            );
            if (permission !== 'granted') {
                throw new Error('Permission denied');
            }

            // Wait for service worker with timeout
            btn.textContent = 'Connecting...';
            var reg = await withTimeout(
                navigator.serviceWorker.ready,
                15000,
                'Service worker not ready. Try refreshing the page.'
            );

            // Subscribe to push with timeout
            btn.textContent = 'Subscribing...';
            var subscription = await withTimeout(
                reg.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: publicKey
                }),
                15000,
                'Push subscription failed. Your browser may not support this feature.'
            );

            // Send to server
            btn.textContent = 'Saving...';
            var subscribeResp = await withTimeout(
                fetch('/push/subscribe', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(subscription.toJSON())
                }),
                10000,
                'Failed to save to server'
            );

            if (!subscribeResp.ok) {
                var errData = await subscribeResp.json().catch(function() { return {}; });
                throw new Error(errData.detail || 'Failed to save subscription');
            }

            currentSubscription = subscription;
            showPreferencesSection();
            await loadPreferences();
            showToast('Push notifications enabled!', 'success');

        } catch (e) {
            console.error('Subscribe error:', e);
            if (e.message === 'Permission denied') {
                document.getElementById('push-permission-denied').style.display = 'block';
                document.getElementById('push-controls').style.display = 'none';
            } else {
                showToast('Failed to enable notifications: ' + e.message, 'error');
            }
        } finally {
            btn.disabled = false;
            btn.textContent = 'Enable Push Notifications';
        }
    };

    window.unsubscribePush = async function() {
        if (!confirm('Are you sure you want to disable push notifications?')) return;

        try {
            if (currentSubscription) {
                await currentSubscription.unsubscribe();

                await fetch('/push/unsubscribe', {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({endpoint: currentSubscription.endpoint})
                });
            }

            currentSubscription = null;
            showSubscribeSection();
            showToast('Push notifications disabled', 'success');

        } catch (e) {
            console.error('Unsubscribe error:', e);
            showToast('Failed to disable notifications', 'error');
        }
    };

    window.savePushPreferences = async function() {
        try {
            var prefs = {
                medal_changes: document.getElementById('pref-medal-changes').checked,
                new_confirmations: document.getElementById('pref-new-confirmations').checked,
                record_broken: document.getElementById('pref-record-broken').checked,
                match_reminders: document.getElementById('pref-match-reminders').checked,
                pota_spots: document.getElementById('pref-pota-spots').checked
            };

            var resp = await fetch('/push/preferences', {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(prefs)
            });

            if (resp.ok) {
                showToast('Preferences saved', 'success');
            } else {
                throw new Error('Failed to save');
            }
        } catch (e) {
            console.error('Save preferences error:', e);
            showToast('Failed to save preferences', 'error');
        }
    };

    window.testPushNotification = async function() {
        try {
            var resp = await fetch('/push/test', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: '{}'
            });
            var data = await resp.json();
            if (resp.ok) {
                showToast(data.message, 'success');
            } else {
                showToast(data.detail || 'Test failed', 'error');
            }
        } catch (e) {
            showToast('Test failed: ' + e.message, 'error');
        }
    };

    function urlBase64ToUint8Array(base64String) {
        var padding = '='.repeat((4 - base64String.length % 4) % 4);
        var base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        var rawData = window.atob(base64);
        var outputArray = new Uint8Array(rawData.length);
        for (var i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }

    // Initialize on load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPushUI);
    } else {
        initPushUI();
    }
})();
</script>

<script>
document.getElementById('password-form').addEventListener('submit', function(e) {
    const newPass = document.getElementById('new_password').value;
    const confirm = document.getElementById('confirm_password').value;

    if (newPass !== confirm) {
        e.preventDefault();
        document.getElementById('password-result').innerHTML =
            '<div class="alert alert-error">New passwords do not match</div>';
    }
});

async function removeQrzKey() {
    if (!confirm('Are you sure you want to remove your stored QRZ API key?')) return;

    const resp = await fetch('/settings/qrz-key', {
        method: 'DELETE',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin'
    });
    if (resp.ok) {
        window.location.href = '/settings?updated=qrz_removed';
    } else {
        showToast('Failed to remove QRZ key', 'error');
    }
}

async function removeLotwCreds() {
    if (!confirm('Are you sure you want to remove your stored LoTW credentials?')) return;

    const resp = await fetch('/settings/lotw', {
        method: 'DELETE',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin'
    });
    if (resp.ok) {
        window.location.href = '/settings?updated=lotw_removed';
    } else {
        showToast('Failed to remove LoTW credentials', 'error');
    }
}

async function resendVerification() {
    const resp = await fetch('/settings/resend-verification', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin'
    });
    if (resp.redirected) {
        window.location.href = resp.url;
    } else if (!resp.ok) {
        showToast('Failed to send verification email', 'error');
    }
}
</script>
{% endblock %}
