{% extends "base.html" %}

{% block title %}Settings - {{ user.callsign }} - Ham Radio Olympics{% endblock %}

{% block nav_extra %}{% endblock %}

{% block content %}
<h2>Account Settings</h2>
<p>Callsign: <strong>{{ user.callsign }}</strong> | Member since: {{ account.registered_at | format_date }}</p>

{% if request.query_params.get('updated') %}
<div class="alert alert-success">
    {% if request.query_params.get('updated') == 'email' %}Email updated successfully.
    {% elif request.query_params.get('updated') == 'password' %}Password changed successfully.
    {% elif request.query_params.get('updated') == 'qrz' %}QRZ API key updated successfully.
    {% elif request.query_params.get('updated') == 'qrz_removed' %}QRZ API key removed.
    {% elif request.query_params.get('updated') == 'lotw' %}LoTW credentials updated successfully.
    {% elif request.query_params.get('updated') == 'lotw_removed' %}LoTW credentials removed.
    {% endif %}
</div>
{% endif %}

<h3>Email Address</h3>
<div class="card">
    <form action="/settings/email" method="post">
        <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" value="{{ account.email or '' }}" placeholder="you@example.com">
        </div>
        <button type="submit" class="btn">Update Email</button>
    </form>
</div>

<h3>Change Password</h3>
<div class="card">
    <form action="/settings/password" method="post" id="password-form">
        <div class="form-group">
            <label for="current_password">Current Password</label>
            <input type="password" id="current_password" name="current_password" required>
        </div>
        <div class="form-group">
            <label for="new_password">New Password</label>
            <input type="password" id="new_password" name="new_password" required minlength="8">
        </div>
        <div class="form-group">
            <label for="confirm_password">Confirm New Password</label>
            <input type="password" id="confirm_password" required minlength="8">
        </div>
        <button type="submit" class="btn">Change Password</button>
    </form>
    <div id="password-result"></div>
</div>

<h3>QRZ API Key</h3>
<div class="card">
    <p>Status: {% if user.has_qrz_key %}<span style="color: #22543d;">Stored</span>{% else %}<span style="color: #718096;">Not stored</span>{% endif %}</p>
    <p style="font-size: 0.9em; color: #718096;">Your QRZ API key enables automatic QSO sync. Get your key from <a href="https://logbook.qrz.com/logbook" target="_blank">QRZ Logbook Settings</a> (requires QRZ XML subscription).</p>
    <form action="/settings/qrz-key" method="post">
        <div class="form-group">
            <label for="qrz_api_key">QRZ API Key</label>
            <input type="text" id="qrz_api_key" name="qrz_api_key" required placeholder="XXXX-XXXX-XXXX-XXXX">
        </div>
        <div style="display: flex; gap: 10px;">
            <button type="submit" class="btn">{% if user.has_qrz_key %}Update{% else %}Save{% endif %} API Key</button>
            {% if user.has_qrz_key %}
            <button type="button" class="btn" style="background: #c53030;" onclick="removeQrzKey()">Remove</button>
            {% endif %}
        </div>
    </form>
</div>

<h3>LoTW Credentials</h3>
<div class="card">
    <p>Status: {% if user.has_lotw_creds %}<span style="color: #22543d;">Stored</span>{% else %}<span style="color: #718096;">Not stored</span>{% endif %}</p>
    <p style="font-size: 0.9em; color: #718096;">Your LoTW credentials enable automatic QSO sync from Logbook of the World.</p>
    <form action="/settings/lotw" method="post">
        <div class="form-group">
            <label for="lotw_username">LoTW Username</label>
            <input type="text" id="lotw_username" name="lotw_username" required placeholder="Your callsign">
        </div>
        <div class="form-group">
            <label for="lotw_password">LoTW Password</label>
            <input type="password" id="lotw_password" name="lotw_password" required placeholder="Your LoTW password">
        </div>
        <div style="display: flex; gap: 10px;">
            <button type="submit" class="btn">{% if user.has_lotw_creds %}Update{% else %}Save{% endif %} Credentials</button>
            {% if user.has_lotw_creds %}
            <button type="button" class="btn" style="background: #c53030;" onclick="removeLotwCreds()">Remove</button>
            {% endif %}
        </div>
    </form>
</div>

<script>
document.getElementById('password-form').addEventListener('submit', function(e) {
    const newPass = document.getElementById('new_password').value;
    const confirm = document.getElementById('confirm_password').value;

    if (newPass !== confirm) {
        e.preventDefault();
        document.getElementById('password-result').innerHTML =
            '<div class="alert alert-error">New passwords do not match</div>';
    }
});

async function removeQrzKey() {
    if (!confirm('Are you sure you want to remove your stored QRZ API key?')) return;

    const resp = await fetch('/settings/qrz-key', {method: 'DELETE'});
    if (resp.ok) {
        window.location.href = '/settings?updated=qrz_removed';
    } else {
        alert('Failed to remove QRZ key');
    }
}

async function removeLotwCreds() {
    if (!confirm('Are you sure you want to remove your stored LoTW credentials?')) return;

    const resp = await fetch('/settings/lotw', {method: 'DELETE'});
    if (resp.ok) {
        window.location.href = '/settings?updated=lotw_removed';
    } else {
        alert('Failed to remove LoTW credentials');
    }
}
</script>
{% endblock %}
