{% extends "base.html" %}

{% block title %}{{ target_display }} - {{ sport_name }} - Ham Radio Olympics{% endblock %}

{% block content %}
<h2>{{ sport_name }}: {{ target_display | pota_tooltip }}</h2>

<div class="card">
    <p><strong>Target:</strong> {{ target_display | pota_tooltip }}</p>
    <p><strong>Start:</strong> {{ match.start_date | format_datetime }}</p>
    <p><strong>End:</strong> {{ match.end_date | format_datetime }}</p>
    {% if match.max_power_w %}
    <p><strong>Max Power:</strong> {{ match.max_power_w }}W{% if match.max_power_w <= 10 %} (QRP){% endif %}</p>
    {% endif %}
</div>

{% if target_type == 'park' %}
<h3>Live Spots at {{ target_value }}</h3>
<div id="spots-container" class="card">
    <p class="loading-text"><span class="loading-spinner"></span> Loading spots...</p>
</div>

<script>
(function() {
    async function loadSpots() {
        const container = document.getElementById('spots-container');
        try {
            const resp = await fetch('/api/v1/park/{{ target_value }}/spots');
            if (!resp.ok) {
                container.innerHTML = '<p style="color: var(--text-secondary);">Unable to load spots.</p>';
                return;
            }
            const data = await resp.json();
            if (!data.spots || data.spots.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No active spots at this park right now.</p>';
                return;
            }

            let html = '<div class="table-responsive"><table><thead><tr>';
            html += '<th>Activator</th><th>Frequency</th><th>Mode</th><th>QSOs</th><th>Spotted</th><th>Comments</th>';
            html += '</tr></thead><tbody>';

            for (const spot of data.spots) {
                const spotTime = new Date(spot.spot_time + 'Z');
                const timeAgo = formatTimeAgo(spotTime);
                html += '<tr>';
                html += '<td><strong>' + escapeHtml(spot.activator) + '</strong></td>';
                html += '<td>' + escapeHtml(spot.frequency) + '</td>';
                html += '<td>' + escapeHtml(spot.mode) + '</td>';
                html += '<td>' + (spot.qso_count || 0) + '</td>';
                html += '<td title="Spotted by ' + escapeHtml(spot.spotter || 'unknown') + '">' + timeAgo + '</td>';
                html += '<td style="color: var(--text-secondary);">' + escapeHtml(spot.comments || '') + '</td>';
                html += '</tr>';
            }
            html += '</tbody></table></div>';
            html += '<p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 10px;">Data from <a href="https://pota.app/" target="_blank">pota.app</a>. Auto-refreshes every 60 seconds.</p>';
            container.innerHTML = html;
        } catch (e) {
            container.innerHTML = '<p style="color: var(--text-secondary);">Unable to load spots.</p>';
        }
    }

    function formatTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        if (diffMins < 1) return 'just now';
        if (diffMins === 1) return '1 min ago';
        if (diffMins < 60) return diffMins + ' mins ago';
        const diffHours = Math.floor(diffMins / 60);
        if (diffHours === 1) return '1 hour ago';
        return diffHours + ' hours ago';
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Load spots immediately
    loadSpots();

    // Refresh every 60 seconds
    setInterval(loadSpots, 60000);
})();
</script>
{% endif %}

{% if medals %}
<h3>Leaderboard</h3>
<div class="table-responsive"><table>
    <thead>
        <tr>
            <th scope="col" style="width: 30px;"></th>
            <th scope="col">Rank</th>
            <th scope="col">Callsign</th>
            <th scope="col">QSO Race</th>
            <th scope="col">Cool Factor Medal</th>
            <th scope="col">POTA Bonus</th>
            <th scope="col">Total Points</th>
        </tr>
    </thead>
    <tbody>
        {% for medal in medals %}
        <tr class="leaderboard-row" data-callsign="{{ medal.callsign }}">
            <td style="cursor: pointer; text-align: center;" onclick="toggleQsoDetails('{{ medal.callsign }}')">
                {% if qso_details.get(medal.callsign) %}
                <span class="expand-icon" id="qso-icon-{{ medal.callsign }}">▶</span>
                {% endif %}
            </td>
            <td>{{ loop.index }}</td>
            <td><a href="/competitor/{{ medal.callsign }}">{{ medal.first_name | competitor_display(medal.callsign) }}</a></td>
            <td>
                {% if medal.qso_race_medal %}
                    <span class="medal-emoji {{ medal.qso_race_medal }}"></span>
                {% else %}
                    -
                {% endif %}
            </td>
            <td>
                {% if medal.cool_factor_medal %}
                    <span class="medal-emoji {{ medal.cool_factor_medal }}"></span>
                    <span style="color: var(--text-secondary);">({{ "%.1f" | format(medal.cool_factor_value) if medal.cool_factor_value else '-' }})</span>
                {% else %}
                    -
                {% endif %}
            </td>
            <td>{% if medal.pota_bonus %}+{{ medal.pota_bonus }}{% else %}-{% endif %}</td>
            <td><strong>{{ medal.total_points }}</strong></td>
        </tr>
        {% if qso_details.get(medal.callsign) %}
        <tr class="qso-details-row" id="qso-details-{{ medal.callsign }}" style="display: none;">
            <td colspan="7" style="padding: 0; background: var(--bg-primary);">
                <div style="padding: 10px 15px 10px 40px;">
                    <table style="margin: 0; font-size: 0.9em;">
                        <thead>
                            <tr>
                                <th>Time (UTC)</th>
                                <th>DX Call</th>
                                <th>Mode</th>
                                <th>Power</th>
                                <th>Distance</th>
                                <th>Cool Factor</th>
                                <th>Confirmed</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for qso in qso_details[medal.callsign] %}
                            <tr>
                                <td>{{ qso.time }}</td>
                                <td><strong>{{ qso.dx_callsign }}</strong>{% if qso.park %} <span style="color: var(--text-secondary);">({{ qso.park }})</span>{% endif %}</td>
                                <td>{{ qso.mode or '-' }}</td>
                                <td>{% if qso.power %}{{ qso.power }}W{% else %}-{% endif %}</td>
                                <td>{% if qso.distance %}{{ "%.0f" | format(qso.distance) }} km{% else %}-{% endif %}</td>
                                <td>{% if qso.cool_factor %}{{ "%.1f" | format(qso.cool_factor) }}{% else %}-{% endif %}</td>
                                <td>{% if qso.confirmed %}<span style="color: #22543d;">Yes</span>{% else %}<span style="color: #c53030;">No</span>{% endif %}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </td>
        </tr>
        {% endif %}
        {% endfor %}
    </tbody>
</table></div>

<script>
function toggleQsoDetails(callsign) {
    const detailsRow = document.getElementById('qso-details-' + callsign);
    const icon = document.getElementById('qso-icon-' + callsign);
    if (!detailsRow || !icon) return;

    if (detailsRow.style.display === 'none') {
        detailsRow.style.display = 'table-row';
        icon.textContent = '▼';
    } else {
        detailsRow.style.display = 'none';
        icon.textContent = '▶';
    }
}
</script>

<style>
.expand-icon {
    font-size: 0.8em;
    color: var(--text-secondary);
    transition: transform 0.2s;
}
.leaderboard-row:hover .expand-icon {
    color: var(--text-primary);
}
.qso-details-row table {
    width: 100%;
    border-collapse: collapse;
}
.qso-details-row th, .qso-details-row td {
    padding: 5px 10px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}
.qso-details-row th {
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.85em;
}
</style>
{% else %}
<div class="card">
    <p>No medals awarded yet. Medals are assigned based on confirmed QSOs matching this target.</p>
</div>
{% endif %}

<p><a href="/olympiad/sport/{{ sport_id }}">Back to {{ sport_name }}</a></p>
{% endblock %}
