{% extends "base.html" %}

{% block title %}Forgot Password - Ham Radio Olympics{% endblock %}

{% block content %}
<h2>Forgot Password</h2>

<div class="card" style="max-width: 400px;">
    {% if message %}
    <div class="alert alert-success">{{ message }}</div>
    {% else %}
    <p>Enter your callsign to receive a password reset email.</p>
    <form id="forgot-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="form-group">
            <label for="callsign">Callsign</label>
            <input type="text" id="callsign" name="callsign" required placeholder="W1ABC" style="text-transform: uppercase;">
        </div>
        <button type="submit" class="btn">Send Reset Email</button>
    </form>
    <div id="forgot-result"></div>
    {% endif %}
    <p style="margin-top: 15px;"><a href="/login">Back to Login</a></p>
</div>

<script>
document.getElementById('forgot-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const result = document.getElementById('forgot-result');
    const btn = e.target.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.textContent = 'Sending...';

    try {
        const resp = await fetch('/forgot-password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                callsign: document.getElementById('callsign').value
            })
        });

        if (resp.ok) {
            result.innerHTML = '<div class="alert alert-success">If an account exists with that callsign, a password reset email will be sent.</div>';
            e.target.style.display = 'none';
        } else {
            const data = await resp.json();
            result.innerHTML = '<div class="alert alert-error">' + data.detail + '</div>';
            btn.disabled = false;
            btn.textContent = 'Send Reset Email';
        }
    } catch (err) {
        result.innerHTML = '<div class="alert alert-error">Error: ' + err.message + '</div>';
        btn.disabled = false;
        btn.textContent = 'Send Reset Email';
    }
});
</script>
{% endblock %}
